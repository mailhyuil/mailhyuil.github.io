"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["688230"],{365641:function(e,r,c){c.r(r),c.d(r,{frontMatter:()=>t,toc:()=>i,default:()=>d,metadata:()=>n,assets:()=>l,contentTitle:()=>a});var n=JSON.parse('{"id":"docker/docker-compose deploy replicas auto scale","title":"docker-compose cluster auto scaling","description":"scale.sh","source":"@site/docs/docker/docker-compose deploy replicas auto scale.md","sourceDirName":"docker","slug":"/docker/docker-compose deploy replicas auto scale","permalink":"/docs/docker/docker-compose deploy replicas auto scale","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"docker-compose cluster","permalink":"/docs/docker/docker-compose deploy replicas - cluster"},"next":{"title":"docker-compose logs","permalink":"/docs/docker/docker-compose logs"}}'),s=c(447259),o=c(255511);let t={},a="docker-compose cluster auto scaling",l={},i=[{value:"scale.sh",id:"scalesh",level:2},{value:"cron job",id:"cron-job",level:2}];function p(e){let r={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"docker-compose-cluster-auto-scaling",children:"docker-compose cluster auto scaling"})}),"\n",(0,s.jsx)(r.h2,{id:"scalesh",children:"scale.sh"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\n\r\n# \uC124\uC815\r\nCOMPOSE_SERVICE_NAME="app"\r\nCOMPOSE_PROJECT_NAME="myproject"  # docker-compose\uAC00 \uC2E4\uD589\uB41C \uB514\uB809\uD1A0\uB9AC \uC774\uB984\r\nSCALE_UP_THRESHOLD=80             # CPU % \uCD08\uACFC \uC2DC \uC2A4\uCF00\uC77C \uC5C5\r\nSCALE_DOWN_THRESHOLD=20           # CPU % \uBBF8\uB9CC \uC2DC \uC2A4\uCF00\uC77C \uB2E4\uC6B4\r\nMIN_REPLICAS=1                    # \uCD5C\uC18C \uCEE8\uD14C\uC774\uB108 \uAC1C\uC218\r\nMAX_REPLICAS=5                    # \uCD5C\uB300 \uCEE8\uD14C\uC774\uB108 \uAC1C\uC218\r\n\r\n# \uD604\uC7AC \uCEE8\uD14C\uC774\uB108 \uAC1C\uC218 \uD655\uC778\r\ncurrent_replicas=$(docker ps --filter "name=${COMPOSE_PROJECT_NAME}_${COMPOSE_SERVICE_NAME}_" --format \'{{.Names}}\' | wc -l)\r\n\r\n# \uD604\uC7AC \uCEE8\uD14C\uC774\uB108\uB4E4\uC758 \uD3C9\uADE0 CPU \uC0AC\uC6A9\uB7C9 \uACC4\uC0B0\r\ncpu_usage=$(docker stats --no-stream --format "{{.CPUPerc}}" $(docker ps --filter "name=${COMPOSE_PROJECT_NAME}_${COMPOSE_SERVICE_NAME}_" --format \'{{.Names}}\') | sed \'s/%//\' | awk \'{sum+=$1} END {if (NR>0) print int(sum/NR); else print 0}\')\r\n\r\necho "$(date): Current replicas=${current_replicas}, CPU usage=${cpu_usage}%"\r\n\r\n# \uC2A4\uCF00\uC77C \uC5C5 \uC870\uAC74\r\nif [ "$cpu_usage" -gt "$SCALE_UP_THRESHOLD" ] && [ "$current_replicas" -lt "$MAX_REPLICAS" ]; then\r\n  new_replicas=$((current_replicas + 1))\r\n  echo "$(date): Scaling UP to ${new_replicas} replicas"\r\n  docker compose up -d --scale ${COMPOSE_SERVICE_NAME}=${new_replicas}\r\nfi\r\n\r\n# \uC2A4\uCF00\uC77C \uB2E4\uC6B4 \uC870\uAC74\r\nif [ "$cpu_usage" -lt "$SCALE_DOWN_THRESHOLD" ] && [ "$current_replicas" -gt "$MIN_REPLICAS" ]; then\r\n  new_replicas=$((current_replicas - 1))\r\n  echo "$(date): Scaling DOWN to ${new_replicas} replicas"\r\n  docker compose up -d --scale ${COMPOSE_SERVICE_NAME}=${new_replicas}\r\nfi\n'})}),"\n",(0,s.jsx)(r.h2,{id:"cron-job",children:"cron job"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-sh",children:"crontab -e\r\n\r\n# Run the scale.sh script every 5 minutes\r\n*/5 * * * * /path/to/scale.sh\n"})})]})}function d(e={}){let{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},255511:function(e,r,c){c.d(r,{R:()=>t,x:()=>a});var n=c(596363);let s={},o=n.createContext(s);function t(e){let r=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);