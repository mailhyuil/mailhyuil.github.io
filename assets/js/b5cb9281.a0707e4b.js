"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["178104"],{636555:function(e,r,n){n.r(r),n.d(r,{frontMatter:()=>o,toc:()=>a,default:()=>l,metadata:()=>t,assets:()=>i,contentTitle:()=>d});var t=JSON.parse('{"id":"nestjs/nest advanced http2 - spdy","title":"nest advanced http2","description":"client\uC640 nginx\uAC00 http2\uB97C \uC0AC\uC6A9\uD558\uACE0 \uC788\uB2E4\uBA74 nginx\uC640 nestjs \uC0AC\uC774\uC5D0\uB3C4 http2\uB97C \uC0AC\uC6A9\uD574\uC57C \uBA40\uD2F0\uD50C\uB809\uC2F1\uC758 \uC774\uC810\uC744 \uB204\uB9B4 \uC218 \uC788\uB2E4.","source":"@site/docs/nestjs/nest advanced http2 - spdy.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced http2 - spdy","permalink":"/docs/nestjs/nest advanced http2 - spdy","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest health checks","permalink":"/docs/nestjs/nest advanced health checks - terminus"},"next":{"title":"nest advanced message queue AWS SQS","permalink":"/docs/nestjs/nest advanced message queue AWS SQS"}}'),s=n(447259),p=n(255511);let o={},d="nest advanced http2",i={},a=[{value:"install",id:"install",level:2},{value:"tls.key &amp; tls.crt required",id:"tlskey--tlscrt-required",level:2},{value:"main.ts",id:"maints",level:2},{value:"http-shutdown.provider.ts",id:"http-shutdownproviderts",level:2}];function c(e){let r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,p.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"nest-advanced-http2",children:"nest advanced http2"})}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"client\uC640 nginx\uAC00 http2\uB97C \uC0AC\uC6A9\uD558\uACE0 \uC788\uB2E4\uBA74 nginx\uC640 nestjs \uC0AC\uC774\uC5D0\uB3C4 http2\uB97C \uC0AC\uC6A9\uD574\uC57C \uBA40\uD2F0\uD50C\uB809\uC2F1\uC758 \uC774\uC810\uC744 \uB204\uB9B4 \uC218 \uC788\uB2E4."}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"install",children:"install"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-sh",children:"npm i spdy\r\nnpm i -D @types/spdy\n"})}),"\n",(0,s.jsx)(r.h2,{id:"tlskey--tlscrt-required",children:"tls.key & tls.crt required"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-sh",children:"openssl req -x509 -newkey rsa:4096 -nodes -sha256 -keyout private.pem -out crt.pem\n"})}),"\n",(0,s.jsx)(r.h2,{id:"maints",children:"main.ts"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:'import express, { Express } from "express";\r\nimport { ServerOptions, createServer } from "spdy";\r\n\r\nasync function bootstrap() {\r\n  const expressApp: Express = express();\r\n  const app = await NestFactory.create(AppModule, new ExpressAdapter(expressApp));\r\n\r\n  /** Config */\r\n  /*   ....  */\r\n  app.enableCors();\r\n\r\n  /** Init */\r\n  await app.init();\r\n  /** Create HTTP Server */\r\n  const spdyOpts: ServerOptions = {\r\n    key: fs.readFileSync(process.env["PRIVATE_KEY_PATH"], "utf8"),\r\n    cert: fs.readFileSync(process.env["CERTIFICATE_PATH"], "utf8"),\r\n  };\r\n  const http2Server = createServer(spdyOpts, expressApp);\r\n  /** Port */\r\n  const port = process.env.SERVER_PORT || 3000;\r\n  /** Server Listen */\r\n  http2Server.listen(port);\r\n  Logger.log(`\u{1F680} Application is running on: http://localhost:${port}`);\r\n  /** Shutdown */\r\n  const shutdownProvider = app.get(HttpShutdownProvider);\r\n  shutdownProvider.addHttpServer(http2Server);\r\n}\r\n\r\nbootstrap();\n'})}),"\n",(0,s.jsx)(r.h2,{id:"http-shutdownproviderts",children:"http-shutdown.provider.ts"}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"nestjs\uB294 \uC784\uC758\uB85C \uC0DD\uC131\uD55C http server\uB97C \uB2EB\uB294 \uAE30\uB2A5\uC744 \uC81C\uACF5\uD558\uC9C0 \uC54A\uAE30 \uB54C\uBB38\uC5D0 OnApplicationShutdown\uC744 \uC0AC\uC6A9\uD558\uC5EC \uC9C1\uC811 \uAD6C\uD604\uD574\uC57C \uD55C\uB2E4."}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"\uC0DD\uC131 \uD6C4 App Module\uC758 Provider\uC5D0 \uB4F1\uB85D"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"@Injectable()\r\nexport class HttpShutdownProvider implements OnApplicationShutdown {\r\n  private httpServers: http.Server[] = [];\r\n\r\n  public addHttpServer(server: http.Server): void {\r\n    this.httpServers.push(server);\r\n  }\r\n\r\n  public async onApplicationShutdown(): Promise<void> {\r\n    await Promise.all(\r\n      this.httpServers.map(\r\n        server =>\r\n          new Promise((resolve, reject) => {\r\n            server.close(error => {\r\n              if (error) {\r\n                reject(error);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n            });\r\n          }),\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nconst shutdownObserver = app.get(ShutdownObserver);\r\nshutdownObserver.addHttpServer(httpServer);\r\nshutdownObserver.addHttpServer(httpsServer);\n"})})]})}function l(e={}){let{wrapper:r}={...(0,p.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},255511:function(e,r,n){n.d(r,{R:()=>o,x:()=>d});var t=n(596363);let s={},p=t.createContext(s);function o(e){let r=t.useContext(p);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(p.Provider,{value:r},e.children)}}}]);