"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[423304],{299384:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>o,contentTitle:()=>d,default:()=>l,frontMatter:()=>a,metadata:()=>n,toc:()=>p});const n=JSON.parse('{"id":"db-postgres/postgres setting \uc138\ud305","title":"postgres \uc138\ud305","description":"pg_basebackup \ubb34\uc870\uac74 \ud55c\ubc88 \ud574\ub450\uae30","source":"@site/docs/db-postgres/postgres setting \uc138\ud305.md","sourceDirName":"db-postgres","slug":"/db-postgres/postgres setting \uc138\ud305","permalink":"/docs/db-postgres/postgres setting \uc138\ud305","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"postgres schema pg_catalog","permalink":"/docs/db-postgres/postgres schema pg_catalog"},"next":{"title":"Stored Procedure","permalink":"/docs/db-postgres/postgres stored procedure"}}');var t=s(447259),c=s(529087);const a={},d="postgres \uc138\ud305",o={},p=[{value:"/var/lib/postgresql/data/postgresql.conf",id:"varlibpostgresqldatapostgresqlconf",level:2},{value:"\ubc31\uc5c5",id:"\ubc31\uc5c5",level:2},{value:"pg_dump script",id:"pg_dump-script",level:3},{value:"pg_basebackup script",id:"pg_basebackup-script",level:3},{value:"3\uc911 \ubc31\uc5c5 script",id:"3\uc911-\ubc31\uc5c5-script",level:3},{value:"CRONJOB",id:"cronjob",level:3}];function i(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"postgres-\uc138\ud305",children:"postgres \uc138\ud305"})}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"pg_basebackup \ubb34\uc870\uac74 \ud55c\ubc88 \ud574\ub450\uae30"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"path"}),"\n",(0,t.jsx)(r.p,{children:"/var/lib/postgresql/data"}),"\n",(0,t.jsx)(r.p,{children:"/var/lib/postgresql/data/postgresql.conf"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"varlibpostgresqldatapostgresqlconf",children:"/var/lib/postgresql/data/postgresql.conf"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"/mnt/server/archivedir \uc0dd\uc131 (postgres \uc0ac\uc6a9\uc790 \uad8c\ud55c)"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"/mnt/server/backupdir \uc0dd\uc131 (postgres \uc0ac\uc6a9\uc790 \uad8c\ud55c)"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-conf",children:"## ARCHIVE BACKUP\r\narchive_mode                    = on\r\narchive_command                 = 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'\r\n                                # %p: WAL \ud3f4\ub354, %f: WAL \ud30c\uc77c\uc774\ub984\r\n                                # aws s3\ub85c \ubcf4\ub0b4\ub294 \uacbd\uc6b0: 'aws s3 cp %p s3://bucket-name/%f'\r\narchive_timeout                 = 1 # 1\ucd08\ub9c8\ub2e4 \uac15\uc81c\ub85c WAL \ud30c\uc77c\uc744 archive_command\ub85c \ubcf4\ub0c4 (0\uc774\uba74 16MB \ucc44\uc6cc\uc9c0\uba74 \ubcf4\ub0c4)\r\n\r\n## Archive Recovery \uc2dc \uc0ac\uc6a9\r\nrestore_command                 = 'cp /mnt/server/archivedir/%f %p'\r\nrecovery_target_time            = '2024-01-31 09:07:00 UTC'\n"})}),"\n",(0,t.jsx)(r.h2,{id:"\ubc31\uc5c5",children:"\ubc31\uc5c5"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"pg_dump, pg_basebackup\uc744 \uc8fc\uae30\uc801\uc73c\ub85c \ud574\uc8fc\ub294 \uc2a4\ud06c\ub9bd\ud2b8\ub97c \uc2e4\ud589"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"\ubc31\uc5c5 \ub370\uc774\ud130\ub294 s3, nas, \ub2e4\ub978 \uc11c\ubc84\ub85c \ubcf4\ub0b4\uae30"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.h3,{id:"pg_dump-script",children:"pg_dump script"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\nDEL_FILE=$(date -d \'30 day ago\' +\'%Y-%m-%d_\')"*.dump"\r\nFILENAME=$(date +"%Y-%m-%d_%H%M").dump\r\nBACKUP_DIR=/mnt/server/backupdir/dumps\r\nUSERNAME=user_name\r\nDB_NAME=DB_name\r\nPASSWORD=password\r\n\r\ncd $BACKUP_DIR\r\n\r\n#----- DUMP BACKUP_FILE -----\r\necho "DB backup start time : " $(date +"%Y-%m-%d %H:%M:%S")\r\nPGPASSWORD=$PASSWORD pg_dump -U $USERNAME $DB_NAME -Fc -v > "${BACKUP_DIR}/${DB_NAME}_${FILENAME}"\r\necho "Successful db backup ( ${BACKUP_DIR}/${DB_NAME}_${FILENAME} )"\r\n\r\n#----- DELETE AFTER 30 DAYS -----\r\necho "Delete old file ${DB_NAME}_${DEL_FILE}"\r\nrm "${BACKUP_DIR}/${DB_NAME}_${DEL_FILE}"\r\necho "BACKUP - End time : " $(date +"%Y-%m-%d %H:%M:%S")\n'})}),"\n",(0,t.jsx)(r.h3,{id:"pg_basebackup-script",children:"pg_basebackup script"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"pg_basebackup\uc744 \ud55c \ub4a4 WAL\uc744 \uadf8 \uc804 wal\uc744 \uc9c0\uc6b0\uac70\ub098 \ub2e4\ub978 \uc11c\ubc84\ub85c \ubcf4\ub0b4\ub294 \uc2a4\ud06c\ub9bd\ud2b8"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\nDEL_FILE=$(date -d \'30 day ago\' +\'%Y-%m-%d_\')"*.dump"\r\nFILENAME=$(date +"%Y-%m-%d_%H%M").dump\r\nBACKUP_DIR=/mnt/server/backupdir/bases\r\nUSERNAME=user_name\r\nDB_NAME=DB_name\r\nPASSWORD=password\r\n\r\ncd $BACKUP_DIR\r\n\r\n#----- DUMP BACKUP_FILE -----\r\necho "DB backup start time : " $(date +"%Y-%m-%d %H:%M:%S")\r\npg_basebackup -D $BACKUP_DIR -c fast -X none\r\necho "Successful db backup ( ${BACKUP_DIR}/${DB_NAME}_${FILENAME} )"\r\n\r\n#----- DELETE AFTER 30 DAYS -----\r\necho "Delete old file ${DB_NAME}_${DEL_FILE}"\r\nrm "${BACKUP_DIR}/${DB_NAME}_${DEL_FILE}"\r\necho "BACKUP - End time : " $(date +"%Y-%m-%d %H:%M:%S")\n'})}),"\n",(0,t.jsx)(r.h3,{id:"3\uc911-\ubc31\uc5c5-script",children:"3\uc911 \ubc31\uc5c5 script"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"dump, basebackup, wal\uc744 \ub450\uac1c\uc758 \uc6d0\uaca9 \uc11c\ubc84\ub85c \ubcf4\ub0b4\ub294 \uc2a4\ud06c\ub9bd\ud2b8"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sh"})}),"\n",(0,t.jsx)(r.h3,{id:"cronjob",children:"CRONJOB"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"crontab -e"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sh",children:"# pg_basebackup + wal (\ub9e4\uc77c 00\uc2dc 00\ubd84)\r\n0 0 * * * /bin/bash pg_basebackup.sh\r\n\r\n# pg_dump (\ud55c\uc2dc\uac04\ub9c8\ub2e4)\r\n0 * * * * /bin/bash pg_dump.sh\r\n\r\n# 3\uc911 \ubc31\uc5c5 (\ud55c\uc2dc\uac04\ub9c8\ub2e4)\r\n0 * * * * /bin/bash remote_backup.sh\n"})})]})}function l(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(i,{...e})}):i(e)}},529087:(e,r,s)=>{s.d(r,{R:()=>a,x:()=>d});var n=s(596363);const t={},c=n.createContext(t);function a(e){const r=n.useContext(c);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),n.createElement(c.Provider,{value:r},e.children)}}}]);