"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[21661],{457027:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>i});const r=JSON.parse('{"id":"nestjs/nest advanced multi-tenancy durable provider","title":"nest advanced multi-tenancy durable provider","description":"database provider\uc758 \uc2a4\ucf54\ud504\ub97c REQUEST\ub85c \uc124\uc815\ud558\uc5ec, \uac01 \uc694\uccad\ub9c8\ub2e4 \ub2e4\ub978 \uc778\uc2a4\ud134\uc2a4\ub97c \uc0dd\uc131\ub97c \uc0dd\uc131\ud55c\ub2e4. (\ubaa8\ub4e0 \uc694\uccad\uc5d0 DI Tree\ub97c \uc7ac\uc0dd\uc131)","source":"@site/docs/nestjs/nest advanced multi-tenancy durable provider.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced multi-tenancy durable provider","permalink":"/docs/nestjs/nest advanced multi-tenancy durable provider","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest advanced multi-tenancy REQUEST","permalink":"/docs/nestjs/nest advanced multi-tenancy REQUEST"},"next":{"title":"nestjs advanced multi-tenancy \ub2e4\uc911 \ub370\uc774\ud130\ubca0\uc774\uc2a4 prisma","permalink":"/docs/nestjs/nest advanced multi-tenancy \ub2e4\uc911 \ub370\uc774\ud130\ubca0\uc774\uc2a4 prisma"}}');var s=t(447259),a=t(529087);const o={},d="nest advanced multi-tenancy durable provider",c={},i=[{value:"multi-tenancy.strategy.ts",id:"multi-tenancystrategyts",level:2},{value:"main.ts",id:"maints",level:2},{value:"some.provider.ts",id:"someproviderts",level:2}];function l(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"nest-advanced-multi-tenancy-durable-provider",children:"nest advanced multi-tenancy durable provider"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"database provider\uc758 \uc2a4\ucf54\ud504\ub97c REQUEST\ub85c \uc124\uc815\ud558\uc5ec, \uac01 \uc694\uccad\ub9c8\ub2e4 \ub2e4\ub978 \uc778\uc2a4\ud134\uc2a4\ub97c \uc0dd\uc131\ub97c \uc0dd\uc131\ud55c\ub2e4. (\ubaa8\ub4e0 \uc694\uccad\uc5d0 DI Tree\ub97c \uc7ac\uc0dd\uc131)"}),"\n",(0,s.jsx)(n.p,{children:"\ud558\uc9c0\ub9cc 1,000\uac1c\uc758 \uc694\uccad\uc774 \ub4e4\uc5b4\uc624\uba74 1,000\uac1c\uc758 \uc778\uc2a4\ud134\uc2a4\uac00 \uc0dd\uc131\ub418\uc5b4, \uba54\ubaa8\ub9ac\ub97c \ub9ce\uc774 \ucc28\uc9c0\ud558\uac8c \ub41c\ub2e4."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:'durable provider\ub97c \uc0ac\uc6a9\ud558\uba74, "\ud14c\ub10c\ud2b8 \uc2dd\ubcc4\uc790"\ub97c \ud1b5\ud574 \ud14c\ub10c\ud2b8\ubcc4\ub85c \ubcc4\ub3c4\uc758 \uc778\uc2a4\ud134\uc2a4\ub97c \uc0dd\uc131\ud55c\ub2e4. (tenantId\ub97c \ud1b5\ud574 DI Tree\ub97c \uc7ac\uc0dd\uc131)'}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\ud14c\ub10c\ud2b8 \ubcc4\ub85c \ub370\uc774\ud130 \uc18c\uc2a4\ub97c \uc644\uc804\ud788 \ubd84\ub9ac\ud560 \uc218 \uc788\ub2e4."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"multi-tenancystrategyts",children:"multi-tenancy.strategy.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\uc694\uccad\ub9c8\ub2e4 \uc0c8\ub85c\uc6b4 context\uac00 \uc2e4\ud589\ub418\ub294\uac8c nestjs\uc758 \uae30\ubcf8 \ub3d9\uc791"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"tenantId\ub97c \ud1b5\ud574 context\ub97c \uc0dd\uc131\ud574 \uc800\uc7a5\ud558\uc5ec \uac19\uc740 tenantId\uc758 \uc694\uccad\uc774 \ub4e4\uc5b4\uc624\uba74, \uae30\uc874 tenant\uc758 context\ub97c \uc0ac\uc6a9\ud558\ub3c4\ub85d \ud55c\ub2e4."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:'client\uc5d0\uc11c request header\uc5d0 "x-tenant-id"\ub97c \ucd94\uac00\ud558\uc5ec \ud14c\ub10c\ud2b8 \uc2dd\ubcc4\uc790\ub97c \uc804\ub2ec\ud55c\ub2e4.'}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\ud14c\ub10c\ud2b8 \uc2dd\ubcc4\uc790\uc5d0 \ub530\ub77c\uc11c \ub2e4\ub978 context\ub97c \uc0ac\uc6a9\ud55c\ub2e4."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { ContextId, ContextIdFactory, ContextIdStrategy, HostComponentInfo } from "@nestjs/core";\r\nimport { Request } from "express";\r\n\r\nconst tenants = new Map<string, ContextId>();\r\n\r\nexport class AggregateByTenantContextIdStrategy implements ContextIdStrategy {\r\n  attach(contextId: ContextId, request: Request) {\r\n    const tenantId = request.headers["x-tenant-id"] as string;\r\n    let tenantSubTreeId: ContextId;\r\n\r\n    if (tenants.has(tenantId)) {\r\n      // \ud14c\ub10c\ud2b8 context\uac00 \uc774\ubbf8 \uc874\uc7ac\ud55c\ub2e4\uba74, \ud574\ub2f9 contextId\ub97c \uac00\uc838\uc628\ub2e4.\r\n      tenantSubTreeId = tenants.get(tenantId);\r\n    } else {\r\n      // \ud14c\ub10c\ud2b8 context\uac00 \uc874\uc7ac\ud558\uc9c0 \uc54a\ub294\ub2e4\uba74, \uc0c8\ub85c \uc0dd\uc131\ud558\uc5ec \uc800\uc7a5\ud55c\ub2e4.\r\n      tenantSubTreeId = ContextIdFactory.create();\r\n      tenants.set(tenantId, tenantSubTreeId);\r\n    }\r\n\r\n    request.tenantId = tenantId;\r\n\r\n    // If tree is not durable, return the original "contextId" object\r\n    return (info: HostComponentInfo) => (info.isTreeDurable ? tenantSubTreeId : contextId);\r\n\r\n    // payload\ub97c \ud568\uaed8 \uc804\ub2ec\ud558\uace0 \uc2f6\ub2e4\uba74 \uc544\ub798\uc640 \uac19\uc774 \uc791\uc131 // \uadf8\ub0e5 request.teantId\ub97c \uc0ac\uc6a9\ud574\ub3c4 \ub41c\ub2e4.\r\n    // (e.g. tenantId\ub97c payload\ub85c \uc804\ub2ec\ud558\uc5ec, tenantId\uc5d0 \ub530\ub77c \ub2e4\ub978 \ub370\uc774\ud130 \uc18c\uc2a4\ub97c \uc0ac\uc6a9\ud560 \uc218 \uc788\ub2e4.)\r\n    // return {\r\n    //   resolve: (info: HostComponentInfo) =>\r\n    //     info.isTreeDurable ? tenantSubTreeId : contextId,\r\n    //   payload: { tenantId },\r\n    // };\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"ContextIdFactory\uc5d0 strategy\ub97c \uc801\uc6a9\ud55c\ub2e4."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { ContextIdFactory, NestFactory } from "@nestjs/core";\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule);\r\n\r\n  ContextIdFactory.apply(new AggregateByTenantContextIdStrategy());\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"someproviderts",children:"some.provider.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Injectable, Scope } from "@nestjs/common";\r\n\r\n@Injectable({ scope: Scope.REQUEST, durable: true })\r\nexport class CatsService {}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\ub610\ub294"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"{\r\n  provide: 'foobar',\r\n  useFactory: () => { ... },\r\n  scope: Scope.REQUEST,\r\n  durable: true,\r\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},529087:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>d});var r=t(596363);const s={},a=r.createContext(s);function o(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);