"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[569337],{236884:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>m,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"how to implement/\uc870\ud68c\uc218","title":"\uc870\ud68c\uc218","description":"prisma","source":"@site/docs/how to implement/\uc870\ud68c\uc218.md","sourceDirName":"how to implement","slug":"/how to implement/\uc870\ud68c\uc218","permalink":"/docs/how to implement/\uc870\ud68c\uc218","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\uc790\ub3d9 \ub85c\uadf8\uc778 \uc138\uc158 \uad6c\ud604","permalink":"/docs/how to implement/\uc790\ub3d9 \ub85c\uadf8\uc778 \uc138\uc158 \uad6c\ud604"},"next":{"title":"\uc88b\uc544\uc694","permalink":"/docs/how to implement/\uc88b\uc544\uc694"}}');var t=n(447259),i=n(529087);const o={},a="\uc870\ud68c\uc218",c={},d=[{value:"prisma",id:"prisma",level:2},{value:"increase-view.decorator.ts",id:"increase-viewdecoratorts",level:2},{value:"scheduler",id:"scheduler",level:2}];function l(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"\uc870\ud68c\uc218",children:"\uc870\ud68c\uc218"})}),"\n",(0,t.jsx)(r.h2,{id:"prisma",children:"prisma"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-prisma",children:"model Resource {\r\n    id        String    @id @db.Uuid\r\n    title     String    @db.VarChar(255)\r\n    /// ...\r\n    views Int  @default(0)\r\n}\n"})}),"\n",(0,t.jsx)(r.h2,{id:"increase-viewdecoratorts",children:"increase-view.decorator.ts"}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"\ud2b8\ub798\ud53d\uc774 \ub9ce\uc740 \uacbd\uc6b0 redis\uc758 hyperloglog (pfcount) \ub97c \uc0ac\uc6a9\ud558\uc5ec \ubc29\ubb38\uc790 \uc218\ub97c \uc138\ub294 \uac83\uc774 \uc88b\ub2e4."}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:'import { Inject } from "@nestjs/common";\r\nimport { RedisClientType } from "@redis/client";\r\nimport { Aspect, LazyDecorator, WrapParams, createDecorator } from "@toss/nestjs-aop";\r\nimport { ClsService } from "nestjs-cls";\r\nimport { RedisKey } from "../redis/redis.key";\r\nimport { REDIS_CLIENT } from "../redis/redis.provider";\r\n\r\nexport const INCREASE_VIEW = Symbol("INCREASE_VIEW");\r\n\r\n@Aspect(INCREASE_VIEW)\r\nexport class IncreaseViewDecorator implements LazyDecorator<any, any> {\r\n  constructor(private readonly cls: ClsService, @Inject(REDIS_CLIENT) private readonly redis: RedisClientType) {}\r\n\r\n  wrap(params: WrapParams<any, any>) {\r\n    return async (...args: any) => {\r\n      const res = await params.method(...args);\r\n      const id = args[0];\r\n      const cacheKey = RedisKey.resourceView(id);\r\n      const ip = this.cls.get("ip");\r\n      if (!ip) return;\r\n      const isNew = await this.redis.sAdd(cacheKey, ip);\r\n      if (isNew) {\r\n        await Promise.all([\r\n          this.redis.incr(RedisKey.resourceViewCount(id)),\r\n          this.redis.expire(cacheKey, 60 * 60 * 24), // 1 day\r\n        ]);\r\n      }\r\n      return res;\r\n    };\r\n  }\r\n}\r\n\r\nexport const IncreaseView = () => createDecorator(INCREASE_VIEW);\n'})}),"\n",(0,t.jsx)(r.h2,{id:"scheduler",children:"scheduler"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:'import { PrismaService } from "@/server/prisma/prisma.service";\r\nimport { RedisKey } from "@/server/redis/redis.key";\r\nimport { REDIS_CLIENT, RedisClient } from "@/server/redis/redis.provider";\r\nimport { Inject, Injectable, Logger } from "@nestjs/common";\r\nimport { Cron } from "@nestjs/schedule";\r\n@Injectable()\r\nexport class ResourceService {\r\n  logger = new Logger(ResourceService.name);\r\n  constructor(private readonly prisma: PrismaService, @Inject(REDIS_CLIENT) private readonly redis: RedisClient) {}\r\n\r\n  @Cron("*/5 * * * *")\r\n  async increaseViewCount() {\r\n    const keys = await this.redis.keys(RedisKey.resourceViewCount("*"));\r\n    if (keys.length === 0) return;\r\n    for (const key of keys) {\r\n      const value = await this.redis.get(key);\r\n      if (!value) continue;\r\n      const id = key.split(":")[2];\r\n      if (!id) continue;\r\n      const views = Number(value);\r\n      await this.prisma.resource.update({\r\n        where: { id },\r\n        data: {\r\n          views: {\r\n            increment: views,\r\n          },\r\n        },\r\n      });\r\n      await this.redis.del(key);\r\n    }\r\n    this.logger.log(`increased view count for ${keys.length} resources`);\r\n  }\r\n}\n'})})]})}function m(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},529087:(e,r,n)=>{n.d(r,{R:()=>o,x:()=>a});var s=n(596363);const t={},i=s.createContext(t);function o(e){const r=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);