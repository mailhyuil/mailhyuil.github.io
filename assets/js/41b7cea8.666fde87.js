"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[927888],{529087:(n,r,e)=>{e.d(r,{R:()=>t,x:()=>a});var s=e(596363);const o={},i=s.createContext(o);function t(n){const r=s.useContext(i);return s.useMemo(function(){return"function"==typeof n?n(r):{...r,...n}},[r,n])}function a(n){let r;return r=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:t(n.components),s.createElement(i.Provider,{value:r},n.children)}},645133:(n,r,e)=>{e.r(r),e.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>t,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"angular/angular worker service worker webpush \uc6f9 \ud478\uc2dc - PWA","title":"angular pwa webpush \uc6f9\ud478\uc2dc","description":"web-push\ub97c \uc0ac\uc6a9\ud558\uc5ec pushSubscription\uc744 \uc0dd\uc131\ud558\uace0 \uc11c\ubc84\uc5d0 \uc800\uc7a5","source":"@site/docs/angular/angular worker service worker webpush \uc6f9 \ud478\uc2dc - PWA.md","sourceDirName":"angular","slug":"/angular/angular worker service worker webpush \uc6f9 \ud478\uc2dc - PWA","permalink":"/docs/angular/angular worker service worker webpush \uc6f9 \ud478\uc2dc - PWA","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"angular PWA","permalink":"/docs/angular/angular worker service worker - PWA"},"next":{"title":"angular web worker","permalink":"/docs/angular/angular worker web worker"}}');var o=e(447259),i=e(529087);const t={},a="angular pwa webpush \uc6f9\ud478\uc2dc",c={},l=[{value:"\uc870\uac74",id:"\uc870\uac74",level:2},{value:"install",id:"install",level:2},{value:"worker.js",id:"workerjs",level:2},{value:"angular.json (project.json)",id:"angularjson-projectjson",level:2},{value:"app.config.ts",id:"appconfigts",level:2},{value:"window.service.ts",id:"windowservicets",level:2},{value:"SwPush \uc0ac\uc6a9",id:"swpush-\uc0ac\uc6a9",level:2},{value:"\uc11c\ubc84",id:"\uc11c\ubc84",level:2},{value:"main.ts",id:"maints",level:3},{value:"web-push.controller.ts",id:"web-pushcontrollerts",level:3}];function p(n){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"angular-pwa-webpush-\uc6f9\ud478\uc2dc",children:"angular pwa webpush \uc6f9\ud478\uc2dc"})}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"web-push\ub97c \uc0ac\uc6a9\ud558\uc5ec pushSubscription\uc744 \uc0dd\uc131\ud558\uace0 \uc11c\ubc84\uc5d0 \uc800\uc7a5"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\uc54c\ub9bc\uc744 \ubcf4\ub0bc \ub550 web-push\ub97c \uc0ac\uc6a9\ud558\uc5ec \uc800\uc7a5\ub41c pushSubscription\uc744 \uc0ac\uc6a9\ud558\uc5ec \uc54c\ub9bc\uc744 \ubcf4\ub0b8\ub2e4."}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\uc54c\ub9bc\uc744 \ub744\uc6b0\uae30 \uc704\ud574\uc11c\ub294 \ubc31\uadf8\ub77c\uc6b4\ub4dc\uc5d0\uc11c \ub3d9\uc791\ud558\uace0 \uc788\ub294 \uc11c\ube44\uc2a4 \uc6cc\ucee4\uac00 \uc0ac\uc6a9\ub41c\ub2e4."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.h2,{id:"\uc870\uac74",children:"\uc870\uac74"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\ube0c\ub77c\uc6b0\uc800\uac00 web push api\ub97c \uc9c0\uc6d0\ud574\uc57c \ud55c\ub2e4."}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\uc0ac\uc6a9\uc790\uac00 \uc6f9 \uc54c\ub9bc \uad8c\ud55c\uc744 \ud5c8\uc6a9\ud574\uc57c \ud55c\ub2e4."}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\uc6f9 \uc6cc\ucee4\ub97c \ub4f1\ub85d\ud558\uace0 \uc6f9 \uc6cc\ucee4 \ud504\ub85c\uc138\uc2a4\uac00 \uc2e4\ud589\ub418\uc5b4\uc57c \ud55c\ub2e4."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.h2,{id:"install",children:"install"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-sh",children:"ng add @angular/pwa\r\n\r\n# web-push \uc124\uce58\r\nnpm install -D web-push\r\n# vapid public key, vapid private key \uc0dd\uc131\r\nnpx web-push generate-vapid-keys\n"})}),"\n",(0,o.jsx)(r.h2,{id:"workerjs",children:"worker.js"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\ud478\uc2dc\ub97c \ubc1b\uc744 \ub54c \uc54c\ub9bc\uc744 \ub744\uc6b0\ub294 \ub85c\uc9c1 \uad6c\ud604"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"angular.json(project.json)\uc5d0\uc11c assets\uc5d0 \uc774 \ud30c\uc77c\uc774 \ucd94\uac00\ub418\ub3c4\ub85d \uc124\uc815"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"ServiceWorkerModule.register('my-worker.js'), // \uc218\uc815"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-js",children:'/// \uc774 \ucf54\ub4dc\ub294 WorkerGlobalScope\uc5d0\uc11c \ub3d9\uc791\ud558\ub294 \ucf54\ub4dc\uc785\ub2c8\ub2e4.\r\nimportScripts("ngsw-worker.js");\r\n\r\nself.addEventListener("push", e => {\r\n  const { title, body, ...data } = e.data.json();\r\n\r\n  if (!title || !body) {\r\n    return;\r\n  }\r\n\r\n  self.registration.showNotification(title, { body, data });\r\n});\r\n\r\nself.addEventListener("notificationclick", e => {\r\n  const url = e.notification?.data?.url;\r\n\r\n  if (!url) {\r\n    return;\r\n  }\r\n\r\n  self.clients.openWindow(url);\r\n});\n'})}),"\n",(0,o.jsx)(r.h2,{id:"angularjson-projectjson",children:"angular.json (project.json)"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-json",children:'assets: [\r\n  "src/worker.js",\r\n  ...\r\n],\n'})}),"\n",(0,o.jsx)(r.h2,{id:"appconfigts",children:"app.config.ts"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:'ServiceWorkerModule.register("worker.js") \ucd94\uac00'}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-ts",children:'export const appConfig: ApplicationConfig = {\r\n  providers: [importProvidersFrom([ServiceWorkerModule.register("worker.js")])],\r\n};\n'})}),"\n",(0,o.jsx)(r.h2,{id:"windowservicets",children:"window.service.ts"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\ube0c\ub77c\uc6b0\uc800\uac00 \uc9c0\uc6d0\ud558\ub294\uc9c0 \ud655\uc778"}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-ts",children:'import { compare } from "compare-versions";\r\nimport UAParser from "ua-parser-js";\r\n\r\n@Injectable()\r\nexport class WindowService {\r\n  isSupportNotification = false;\r\n\r\n  constructor() {\r\n    const {\r\n      browser: { name, version },\r\n    } = new UAParser().getResult();\r\n\r\n    // \uacf5\uc2dd \ubb38\uc11c \uae30\uc900\uc73c\ub85c \ud544\ud130\ub9c1\r\n    this.isSupportNotification =\r\n      "Notification" in window &&\r\n      !!version &&\r\n      (name === "Chrome" ||\r\n        compare(version, "52", ">=") ||\r\n        name === "Edge" ||\r\n        compare(version, "17", ">=") ||\r\n        name === "Firefox" ||\r\n        compare(version, "46", ">="));\r\n  }\r\n}\n'})}),"\n",(0,o.jsx)(r.h2,{id:"swpush-\uc0ac\uc6a9",children:"SwPush \uc0ac\uc6a9"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-ts",children:'export class NotificationComponent {\r\n  constructor(\r\n    private readonly swPush: SwPush,\r\n    private readonly httpClient: HttpClient,\r\n    protected readonly windowService: WindowService,\r\n  ) {}\r\n\r\n  async onClick() {\r\n    // \ube0c\ub77c\uc6b0\uc800\uac00 \uc9c0\uc6d0\ud558\uc9c0 \uc54a\uc73c\uba74 \uc885\ub8cc\r\n    if (!this.windowService.isSupportNotification) return;\r\n\r\n    // PushSubscription\uac1d\uccb4\ub97c \uc11c\ubc84\ub85c \uc804\uc1a1 \ubc0f DB\uc5d0 \uc800\uc7a5\r\n    const pushSubscription = await this.swPush.requestSubscription({ serverPublicKey: environment.VAPIDPublicKey });\r\n    this.httpClient.post("web-push/subscribe", pushSubscription).subscribe();\r\n  }\r\n}\n'})}),"\n",(0,o.jsx)(r.h2,{id:"\uc11c\ubc84",children:"\uc11c\ubc84"}),"\n",(0,o.jsx)(r.h3,{id:"maints",children:"main.ts"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-ts",children:'import { NestFactory } from "@nestjs/core";\r\nimport { AppModule } from "./app.module";\r\nimport * as webPush from "web-push";\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule);\r\n\r\n  webPush.setVapidDetails(\r\n    "mailto:<\uad00\ub9ac\uc6a9 \uc774\uba54\uc77c \uc8fc\uc18c \uae30\uc785>",\r\n    process.env.VAPID_PUBLIC_KEY,\r\n    process.env.VAPID_PRIVATE_KEY,\r\n  );\r\n\r\n  await app.listen(3000);\r\n}\r\nbootstrap();\n'})}),"\n",(0,o.jsx)(r.h3,{id:"web-pushcontrollerts",children:"web-push.controller.ts"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"pushSubscription\uc744 DB\uc5d0 \uc800\uc7a5\ud558\uace0"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\uc54c\ub9bc\uc744 \ubcf4\ub0b4\uc57c \ud560 \ub550 \uc544\ub798\uc640 \uac19\uc774 \uc800\uc7a5\ud588\ub358 pushSubscription\uc744 sendNotification\uc758 \uc778\uc790\ub85c \ubcf4\ub0b4\uba74 \ub41c\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-ts",children:'import { Controller, Post, Body } from "@nestjs/common";\r\nimport * as webPush from "web-push";\r\n\r\n@Controller("web-push")\r\nexport class WebPushController {\r\n  constructor(private readonly prisma: PrismaService) {}\r\n  @Post("subscribe")\r\n  async subscribe(@Body() body: { subscription: PushSubscription }) {\r\n    console.log("Received subscription:", subscription);\r\n\r\n    // subscription\uc744 DB\uc5d0 \uc800\uc7a5\r\n    await this.prisma.pushSubscription.create({\r\n      data: {\r\n        subscription,\r\n      },\r\n    });\r\n\r\n    return { success: true };\r\n  }\r\n\r\n  @OnEvent("web-push.send")\r\n  async send(notification: { title: string; body: string }) {\r\n    const payload = JSON.stringify(notification);\r\n\r\n    const subscriptions = await this.prisma.pushSubscription.findMany();\r\n\r\n    try {\r\n      for (const { subscription } of subscriptions) {\r\n        await webPush.sendNotification(subscription, payload);\r\n      }\r\n    } catch (err) {\r\n      console.error("Error sending notification, reason: ", err);\r\n    }\r\n  }\r\n}\n'})})]})}function u(n={}){const{wrapper:r}={...(0,i.R)(),...n.components};return r?(0,o.jsx)(r,{...n,children:(0,o.jsx)(p,{...n})}):p(n)}}}]);