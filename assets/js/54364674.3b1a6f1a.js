"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[974208],{529087:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>d});var o=r(596363);const s={},l=o.createContext(s);function t(e){const n=o.useContext(l);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),o.createElement(l.Provider,{value:n},e.children)}},972749:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>a,frontMatter:()=>t,metadata:()=>o,toc:()=>u});const o=JSON.parse('{"id":"nestjs/nest advanced message queue bullMQ","title":"nest advanced message queue","description":"bullmq\ub294 \uc0c8\ub85c\uc6b4 \ud504\ub85c\uc138\uc2a4\ub97c \uc0dd\uc131\ud574\uc8fc\uc9c0 \uc54a\ub294\ub2e4. (\uba54\uc778 \ud504\ub85c\uc138\uc2a4\uc640 \ubd84\ub9ac\ub418\uc9c0 \uc54a\ub294\ub2e4.)","source":"@site/docs/nestjs/nest advanced message queue bullMQ.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced message queue bullMQ","permalink":"/docs/nestjs/nest advanced message queue bullMQ","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest advanced message queue","permalink":"/docs/nestjs/nest advanced message queue bullMQ concurrency"},"next":{"title":"nest rabbitMQ","permalink":"/docs/nestjs/nest advanced message queue rabbitMQ"}}');var s=r(447259),l=r(529087);const t={},d="nest advanced message queue",c={},u=[{value:"install",id:"install",level:2},{value:"app.module.ts",id:"appmodulets",level:2},{value:"audio.module.ts",id:"audiomodulets",level:2},{value:"audio.processor.ts",id:"audioprocessorts",level:2},{value:"audio.controller.ts",id:"audiocontrollerts",level:2}];function i(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"nest-advanced-message-queue",children:"nest advanced message queue"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"bullmq\ub294 \uc0c8\ub85c\uc6b4 \ud504\ub85c\uc138\uc2a4\ub97c \uc0dd\uc131\ud574\uc8fc\uc9c0 \uc54a\ub294\ub2e4. (\uba54\uc778 \ud504\ub85c\uc138\uc2a4\uc640 \ubd84\ub9ac\ub418\uc9c0 \uc54a\ub294\ub2e4.)"}),"\n",(0,s.jsx)(n.p,{children:"\ub530\ub77c\uc11c \ub3c5\ub9bd\ub41c \uc571\uc73c\ub85c \uc2e4\ud589\uc2dc\ucf1c\uc57c \ud55c\ub2e4."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"redis \uae30\ubc18\uc758 \uac00\ubcbc\uc6b4 \uba54\uc138\uc9c0 \ud050"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\uc694\uccad\uc740 \ucc98\ub9ac\ub420 \ub54c\uae4c\uc9c0 \ud050\uc5d0\uc11c \ub300\uae30\ud558\uae30 \ub54c\ubb38\uc5d0 \uc11c\ubc84\uac00 \ub2e4\uc6b4\ub418\uc5b4\ub3c4 \uba54\uc138\uc9c0\uac00 \uc720\uc2e4\ub418\uc9c0 \uc54a\ub294\ub2e4."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\uc11c\ubc84 \ubd80\ud558\uac00 \ub9ce\uc740 \uc791\uc5c5\uc758 \uacbd\uc6b0 MQ\uc5d0 \uc800\uc7a5\ud574\ub450\uace0 \ud55c\ubc88\uc5d0 \ucc98\ub9ac\ud560 \uc218 \uc788\ub294 \uc591\ub9cc\ud07c\ub9cc \uac00\uc838\uc640\uc11c \ucc98\ub9ac\ud55c\ub2e4."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"@Processor()\ub85c Consumer(process)\ub97c \uc0dd\uc131\ud558\uc5ec \uadf8 \ud504\ub85c\uc138\uc2a4\uc5d0\uc11c \uc791\uc5c5\uc744 \ucc98\ub9ac\ud55c\ub2e4. (\uba54\uc778 \ud504\ub85c\uc138\uc2a4\uc640 \ubd84\ub9ac)"}),"\n",(0,s.jsx)(n.p,{children:"@Process()\uc548\uc5d0\uc11c concurrency\ub97c \uc124\uc815\ud560 \uc218 \uc788\ub2e4. (\ub3d9\uc2dc\uc5d0 \ucc98\ub9ac\ud560 \uc218 \uc788\ub294 job\uc758 \uac1c\uc218)"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"install",children:"install"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npm i bull\r\nnpm i @nestjs/bull\r\n\r\n# redis \uc124\uce58\r\ndocker run --name redis -d -p 6379:6379 redis:latest\r\n\r\n# redis-cli\r\nnpm i -g redis-cli\r\nrdcli -h localhost -p 6379\n"})}),"\n",(0,s.jsx)(n.h2,{id:"appmodulets",children:"app.module.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Module } from "@nestjs/common";\r\nimport { BullModule } from "@nestjs/bull";\r\n\r\n@Module({\r\n  imports: [\r\n    BullModule.forRoot({\r\n      redis: {\r\n        host: "localhost",\r\n        port: 6379,\r\n      },\r\n    }),\r\n  ],\r\n})\r\nexport class AppModule {}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"audiomodulets",children:"audio.module.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"registerQueue\uac00 \ub41c \ubaa8\ub4c8\uc5d0\uc11c\ub9cc @InjectQueue\ub97c \uc0ac\uc6a9\ud560 \uc218 \uc788\ub2e4."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { BullModule } from "@nestjs/bull";\r\nimport { Module } from "@nestjs/common";\r\nimport { AudioController } from "./audio.controller";\r\nimport { AudioProcessor } from "./audio.processor";\r\n\r\n@Module({\r\n  imports: [\r\n    BullModule.registerQueue({\r\n      name: "audio",\r\n    }),\r\n  ],\r\n  controllers: [AudioController],\r\n  providers: [AudioProcessor],\r\n})\r\nexport class AudioModule {}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"audioprocessorts",children:"audio.processor.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"@Process\uc5d0 \ubc18\ub4dc\uc2dc name\uc744 \uc9c0\uc815\ud574\ub3c4 \ub418\uace0 \uc548\ud558\uba74 \uadf8\ub0e5 add"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"concurrency: \ub3d9\uc2dc\uc5d0 \ucc98\ub9ac\ud560 \uc218 \uc788\ub294 job\uc758 \uac1c\uc218"}),"\n",(0,s.jsx)(n.p,{children:"concurrency\uac00 1\uc774\uba74 transcode job\uc740 \ud55c\ubc88\uc5d0 \ud558\ub098\ub9cc \ucc98\ub9ac\ud55c\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Process, Processor } from "@nestjs/bull";\r\nimport { Logger } from "@nestjs/common";\r\nimport { Job } from "bull";\r\n\r\n@Processor("audio")\r\nexport class AudioProcessor {\r\n  private readonly logger = new Logger(AudioProcessor.name);\r\n\r\n  @Process({\r\n    name: "transcode",\r\n    concurrency: 5,\r\n  })\r\n  transcode(job: Job) {\r\n    this.logger.debug("Start transcoding...");\r\n    this.logger.debug(job.data);\r\n    this.logger.debug("Transcoding completed");\r\n  }\r\n\r\n  @OnQueueCompleted()\r\n  onCompleted(job: Job, result: any) {\r\n    this.logger.debug("onCompleted");\r\n    this.logger.debug(result);\r\n  }\r\n\r\n  @OnQueueActive()\r\n  onActive(job: Job) {\r\n    this.logger.debug("onActive");\r\n  }\r\n\r\n  @OnQueueFailed()\r\n  onFailed(job: Job, err: Error) {\r\n    this.logger.debug("onFailed");\r\n    this.logger.debug(err);\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"audiocontrollerts",children:"audio.controller.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"multi worker\ub85c \ube60\ub974\uac8c \ucc98\ub9ac\ud558\uace0 \uc2f6\ub2e4\uba74 data\ub97c \ub098\ub220\uc11c \uc5ec\ub7ec\uac1c\uc758 add\ub97c \uc0ac\uc6a9 process\uc758 concurrency\ub3c4 \ub192\uc5ec\uc57c \ud55c\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { InjectQueue } from "@nestjs/bull";\r\nimport { Controller, Post } from "@nestjs/common";\r\nimport { Queue } from "bull";\r\n\r\n@Controller("audio")\r\nexport class AudioController {\r\n  constructor(@InjectQueue("audio") private readonly audioQueue: Queue) {}\r\n\r\n  @Post("transcode")\r\n  async transcode() {\r\n    await this.audioQueue.add(\r\n      "transcode",\r\n      {\r\n        file: "audio.mp3",\r\n      },\r\n      {\r\n        attempts: 3,\r\n        backoff: 60000,\r\n        delay: 1000,\r\n        priority: 1,\r\n      },\r\n    );\r\n  }\r\n}\n'})})]})}function a(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(i,{...e})}):i(e)}}}]);