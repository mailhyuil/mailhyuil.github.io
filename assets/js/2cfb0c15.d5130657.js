"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[119695],{529087:(e,a,r)=>{r.d(a,{R:()=>i,x:()=>d});var n=r(596363);const t={},s=n.createContext(t);function i(e){const a=n.useContext(s);return n.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function d(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),n.createElement(s.Provider,{value:a},e.children)}},717066:(e,a,r)=>{r.r(a),r.d(a,{assets:()=>o,contentTitle:()=>d,default:()=>p,frontMatter:()=>i,metadata:()=>n,toc:()=>m});const n=JSON.parse('{"id":"db-prisma/prisma middleware soft delete","title":"prisma middleware soft delete","description":"","source":"@site/docs/db-prisma/prisma middleware soft delete.md","sourceDirName":"db-prisma","slug":"/db-prisma/prisma middleware soft delete","permalink":"/docs/db-prisma/prisma middleware soft delete","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"prisma log","permalink":"/docs/db-prisma/prisma log"},"next":{"title":"prisma middleware","permalink":"/docs/db-prisma/prisma middleware"}}');var t=r(447259),s=r(529087);const i={},d="prisma middleware soft delete",o={},m=[];function l(e){const a={code:"code",h1:"h1",header:"header",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.header,{children:(0,t.jsx)(a.h1,{id:"prisma-middleware-soft-delete",children:"prisma middleware soft delete"})}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-ts",children:'import { Injectable, OnModuleInit } from "@nestjs/common";\r\nimport { PrismaClient } from "@prisma/client";\r\n\r\n@Injectable()\r\nexport class PrismaService extends PrismaClient implements OnModuleInit {\r\n  async onModuleInit() {\r\n    // soft delete\r\n    this.$use(async (params, next) => {\r\n      // model\uc774 Class \ub610\ub294 User\uc774\uace0\r\n      if (params.model === "Class" || params.model === "User") {\r\n        // action\uc774 delete\uc774\uba74\r\n        if (params.action == "delete") {\r\n          params.action = "update"; // action\uc744 update\ub85c \ubcc0\uacbd\r\n          if (params.model === "User") {\r\n            params.args["data"] = { deletedAt: new Date(), status: "INACTIVE" }; // data\uc5d0 deletedAt: new Date(), status: "INACTIVE" \ucd94\uac00\r\n          } else {\r\n            params.args["data"] = { deletedAt: new Date(), status: "DELETED" };\r\n          }\r\n        }\r\n        // action\uc774 deleteMany\uc774\uba74\r\n        if (params.action == "deleteMany") {\r\n          params.action = "updateMany"; // action\uc744 updateMany\ub85c \ubcc0\uacbd\r\n          if (params.args.data != undefined) {\r\n            params.args.data["deletedAt"] = new Date();\r\n            if (params.model === "User") {\r\n              params.args.data["status"] = "INACTIVE";\r\n            } else {\r\n              params.args.data["status"] = "DELETED";\r\n            }\r\n          } else {\r\n            if (params.model === "User") {\r\n              params.args["data"] = {\r\n                deletedAt: new Date(),\r\n                status: "INACTIVE",\r\n              };\r\n            } else {\r\n              params.args["data"] = {\r\n                deletedAt: new Date(),\r\n                status: "DELETED",\r\n              };\r\n            }\r\n          }\r\n        }\r\n        if (\r\n          params.action == "findUnique" ||\r\n          params.action == "findMany" ||\r\n          params.action == "findFirst" ||\r\n          params.action === "findFirstOrThrow" ||\r\n          params.action === "findUniqueOrThrow" ||\r\n          params.action === "findRaw" ||\r\n          params.action === "executeRaw" ||\r\n          params.action === "queryRaw" ||\r\n          params.action == "count" ||\r\n          params.action == "aggregate" ||\r\n          params.action === "groupBy"\r\n        ) {\r\n          params.args["where"]["deletedAt"] = null;\r\n        }\r\n      }\r\n      return next(params);\r\n    });\r\n    await this.$connect();\r\n  }\r\n}\n'})})]})}function p(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);