"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["492171"],{517662:function(n,e,r){r.r(e),r.d(e,{frontMatter:()=>s,toc:()=>l,default:()=>g,metadata:()=>t,assets:()=>c,contentTitle:()=>a});var t=JSON.parse('{"id":"ai langchain/langchain Vector Stores pgvector","title":"langchain Vector Stores pgvector","description":"install","source":"@site/docs/ai langchain/langchain Vector Stores pgvector.md","sourceDirName":"ai langchain","slug":"/ai langchain/langchain Vector Stores pgvector","permalink":"/docs/ai langchain/langchain Vector Stores pgvector","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"langchain Vector Stores","permalink":"/docs/ai langchain/langchain Vector Stores MemoryVectorStore"},"next":{"title":"langchain Text Splitters","permalink":"/docs/ai langchain/langchain Vector Text Spliters"}}'),o=r(447259),i=r(255511);let s={},a="langchain Vector Stores pgvector",c={},l=[{value:"install",id:"install",level:2},{value:"postgres settings",id:"postgres-settings",level:2},{value:"init.sql",id:"initsql",level:2},{value:"VectorStore",id:"vectorstore",level:2}];function d(n){let e={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,i.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.header,{children:(0,o.jsx)(e.h1,{id:"langchain-vector-stores-pgvector",children:"langchain Vector Stores pgvector"})}),"\n",(0,o.jsx)(e.h2,{id:"install",children:"install"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-sh",children:"npm i @langchain/community @langchain/openai @langchain/core pg uuid\n"})}),"\n",(0,o.jsx)(e.h2,{id:"postgres-settings",children:"postgres settings"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-sh",children:"services:\r\n  db:\r\n    image: pgvector/pgvector:pg16\r\n    container_name: postgres\r\n    ports:\r\n      - 5432:5432\r\n    restart: always\r\n    environment:\r\n      - POSTGRES_DB=mydb\r\n      - POSTGRES_USER=postgres\r\n      - POSTGRES_PASSWORD=postgres\r\n    volumes:\r\n      - pgdata:/var/lib/postgresql/data\r\n      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql\n"})}),"\n",(0,o.jsx)(e.h2,{id:"initsql",children:"init.sql"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE chatbot_vector (\r\n    id SERIAL PRIMARY KEY,\r\n    content TEXT, -- \uD14D\uC2A4\uD2B8 \uB370\uC774\uD130 \uC800\uC7A5\r\n    metadata JSONB, -- \uBA54\uD0C0\uB370\uC774\uD130 \uC800\uC7A5\r\n    embedding vector(1536)  -- vector \uB370\uC774\uD130 \uC800\uC7A5, OpenAI\uC758 text-embedding-ada-002 \uBAA8\uB378 \uAE30\uC900\r\n    --------------------------------\r\n    -- \uCD94\uAC00\uC801\uC778 \uB370\uC774\uD130 \uC800\uC7A5 (RDBMS \uC6A9)\r\n    -- username TEXT,\r\n    -- created_at TIMESTAMP DEFAULT NOW()\r\n);\n"})}),"\n",(0,o.jsx)(e.h2,{id:"vectorstore",children:"VectorStore"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'import { DistanceStrategy, PGVectorStore } from "@langchain/community/vectorstores/pgvector";\r\nimport type { Document } from "@langchain/core/documents";\r\nimport { OpenAIEmbeddings } from "@langchain/openai";\r\nimport { Injectable, OnApplicationShutdown, OnModuleInit } from "@nestjs/common";\r\nimport { PoolConfig } from "pg";\r\nimport { v4 as uuid } from "uuid";\r\n\r\n@Injectable()\r\nexport class VectorStore implements OnModuleInit, OnApplicationShutdown {\r\n  embeddings: OpenAIEmbeddings;\r\n  vectorStore: PGVectorStore;\r\n  onModuleInit() {\r\n    this.init();\r\n  }\r\n  onApplicationShutdown(signal?: string) {\r\n    this.vectorStore.end();\r\n  }\r\n\r\n  async init() {\r\n    this.embeddings = new OpenAIEmbeddings({\r\n      model: "text-embedding-3-small",\r\n    });\r\n\r\n    const config = {\r\n      postgresConnectionOptions: {\r\n        type: "postgres",\r\n        host: process.env.PG_VECTOR_HOST,\r\n        port: process.env.PG_VECTOR_PORT,\r\n        user: process.env.PG_VECTOR_USER,\r\n        password: process.env.PG_VECTOR_PASSWORD,\r\n        database: process.env.PG_VECTOR_DATABASE,\r\n      } as PoolConfig,\r\n      tableName: process.env.PG_VECTOR_TABLE,\r\n      columns: {\r\n        idColumnName: "id",\r\n        vectorColumnName: "embedding",\r\n        contentColumnName: "content",\r\n        metadataColumnName: "metadata",\r\n      },\r\n      // supported distance strategies: cosine (default), innerProduct, or euclidean\r\n      distanceStrategy: "cosine" as DistanceStrategy,\r\n    };\r\n\r\n    this.vectorStore = await PGVectorStore.initialize(this.embeddings, config);\r\n  }\r\n\r\n  async add(docs: Document[]) {\r\n    const docsWithIds = docs.map(doc => {\r\n      return {\r\n        ...doc,\r\n        id: uuid(),\r\n      };\r\n    });\r\n    return await this.vectorStore.addDocuments(docsWithIds);\r\n  }\r\n\r\n  async delete(ids: string[], filter?: Record<string, unknown>) {\r\n    await this.vectorStore.delete({\r\n      ids,\r\n      filter,\r\n    });\r\n  }\r\n\r\n  async get(query: string, k: number, filter?: Record<string, unknown>) {\r\n    // query: \uAC80\uC0C9\uD560 \uBB38\uC7A5, k: \uBC18\uD658\uD560 \uBB38\uC11C \uC218, filter: \uD544\uD130 \uD568\uC218\r\n    // \uBCA1\uD130 \uC800\uC7A5\uC18C\uB97C \uC9C1\uC811 \uAC80\uC0C9\r\n    // \uC0AC\uC6A9\uC774 \uAC04\uB2E8\uD558\uB2E4.\r\n    return await this.vectorStore.similaritySearch(query, k, filter);\r\n  }\r\n\r\n  async retrieve(query: string, k?: number, filter?: Record<string, unknown>) {\r\n    // query: \uAC80\uC0C9\uD560 \uBB38\uC7A5, k: \uBC18\uD658\uD560 \uBB38\uC11C \uC218, filter: \uD544\uD130 \uD568\uC218, searchType: \uAC80\uC0C9 \uBC29\uBC95, searchKwargs: \uAC80\uC0C9 \uC635\uC158\r\n    // retriever\uB97C \uC0AC\uC6A9\uD558\uC5EC \uAC80\uC0C9\r\n    // \uD65C\uC6A9 \uBC94\uC704\uAC00 \uB354 \uB113\uACE0 \uB2E4\uC591\uD55C \uC635\uC158\uC744 \uC81C\uACF5\uD55C\uB2E4.\r\n    const retriever = this.vectorStore.asRetriever({\r\n      searchType: "mmr",\r\n      searchKwargs: {\r\n        fetchK: 10,\r\n      },\r\n      filter,\r\n      k,\r\n    });\r\n    return await retriever.invoke(query);\r\n  }\r\n}\n'})})]})}function g(n={}){let{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(d,{...n})}):d(n)}},255511:function(n,e,r){r.d(e,{R:()=>s,x:()=>a});var t=r(596363);let o={},i=t.createContext(o);function s(n){let e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:s(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);