"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[683311],{154192:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"nestjs/nest advanced websocket","title":"nest websocket","description":"install","source":"@site/docs/nestjs/nest advanced websocket.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced websocket","permalink":"/docs/nestjs/nest advanced websocket","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nestjs advanced webpack","permalink":"/docs/nestjs/nest advanced webpack"},"next":{"title":"nest FedCM (Federated Credential Management)","permalink":"/docs/nestjs/nest auth FedCM"}}');var s=t(447259),o=t(529087);const a={},c="nest websocket",i={},l=[{value:"install",id:"install",level:2},{value:"chat.gateway.ts",id:"chatgatewayts",level:2},{value:"chat.module.ts",id:"chatmodulets",level:2},{value:"angular client",id:"angular-client",level:2},{value:"app.config.ts",id:"appconfigts",level:3},{value:"usage",id:"usage",level:3},{value:"nginx",id:"nginx",level:2}];function d(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"nest-websocket",children:"nest websocket"})}),"\n",(0,s.jsx)(n.h2,{id:"install",children:"install"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npm i @nestjs/websockets\r\nnpm i @nestjs/platform-socket.io\r\n\r\n# angular client\r\nnpm i ngx-socket-io\n"})}),"\n",(0,s.jsx)(n.h2,{id:"chatgatewayts",children:"chat.gateway.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"@WebSocketGateway()\uc5d0 websocket \uc11c\ubc84\ub97c \uc5f4 port \uc9c0\uc815"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\uae30\ubcf8\uc740 nestjs server port\ub97c \uc0ac\uc6a9"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Logger } from "@nestjs/common";\r\nimport {\r\n  MessageBody,\r\n  OnGatewayConnection,\r\n  OnGatewayDisconnect,\r\n  OnGatewayInit,\r\n  SubscribeMessage,\r\n  WebSocketGateway,\r\n  WebSocketServer,\r\n} from "@nestjs/websockets";\r\nimport { Server, Socket } from "socket.io";\r\n\r\n@WebSocketGateway({\r\n  path: "/ws", // default: /socket.io\r\n  namespace: "chat",\r\n})\r\nexport class ChatGateway implements OnGatewayConnection, OnGatewayDisconnect, OnGatewayInit {\r\n  logger = new Logger(ChatGateway.name);\r\n  @WebSocketServer()\r\n  server: Server;\r\n\r\n  @SubscribeMessage("join")\r\n  handleJoin(@MessageBody() data: string) {\r\n    this.server.on("connection", socket => {\r\n      socket.join("room:1");\r\n      this.server.to("room:1").emit("message", data);\r\n    });\r\n  }\r\n\r\n  @SubscribeMessage("text")\r\n  handleEvent(@MessageBody() data: string, @ConnectedSocket() client: Socket) {\r\n    client.join("room:1");\r\n    this.server.to("room:1").emit("message");\r\n  }\r\n\r\n  handleConnection(client: Socket, ...args: any[]) {\r\n    this.logger.log("User connected");\r\n  }\r\n\r\n  handleDisconnect(client: Socket) {\r\n    this.logger.log("User disconnected");\r\n  }\r\n\r\n  afterInit(server: Server) {\r\n    this.logger.log("Socket is live");\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"chatmodulets",children:"chat.module.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"bugfix: ChatModule\uacfc AppModule\uc5d0 \ubaa8\ub450 ChatGateway\uac00 \ub4f1\ub85d\ub418\uc5b4 \uc788\uc73c\uba74 \ucee4\ub125\uc158\uc774 \ub450\uac1c\uac00 \uc0dd\uc131\ub428"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"@Module({\r\n  providers: [ChatGateway],\r\n})\r\nexport class ChatModule {}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"angular-client",children:"angular client"}),"\n",(0,s.jsx)(n.h3,{id:"appconfigts",children:"app.config.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { SocketIoModule, SocketIoConfig } from "ngx-socket-io";\r\n\r\nconst config: SocketIoConfig = {\r\n  url: "ws://localhost:3000/chat", // \ub05d\uc5d0 namespace\ub97c \ubd99\uc5ec\uc918\uc57c\ud568\r\n  options: {\r\n    transports: ["websocket"],\r\n    path: "/ws", // default: /socket.io\r\n  },\r\n};\r\n\r\nexport const appConfig: ApplicationConfig = {\r\n  providers: [importProvidersFrom([SocketIoModule.forRoot(config)])],\r\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"usage",children:"usage"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Socket } from "ngx-socket-io";\r\n\r\nsocket = inject(Socket);\r\nsocket.emit("chat", "Hello World");\r\nsocket.emit("chat", { message: "Hello World" }, data => console.log(data));\r\nsocket.on("message", data => console.log(data));\n'})}),"\n",(0,s.jsx)(n.h2,{id:"nginx",children:"nginx"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-conf",children:'# ws\r\nlocation /ws/ {\r\n    proxy_http_version 1.1;\r\n    proxy_set_header Upgrade $http_upgrade;\r\n    proxy_set_header Connection "Upgrade";\r\n    proxy_set_header Host $host;\r\n    proxy_set_header X-Forwarded-For $remote_addr;\r\n    proxy_buffering off;\r\n    gzip off;\r\n    proxy_pass http://127.0.0.1:10018;\r\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},529087:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var r=t(596363);const s={},o=r.createContext(s);function a(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);