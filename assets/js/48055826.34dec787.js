"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["29978"],{824710:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>o,toc:()=>c,default:()=>u,metadata:()=>t,assets:()=>i,contentTitle:()=>l});var t=JSON.parse('{"id":"nestjs/nest advanced schedule - cronjob","title":"nest schedule","description":"cronjob\uC740 \uD3EC\uD2B8\uAC00 \uD544\uC694 \uC5C6\uC73C\uB2C8 standalone\uC73C\uB85C \uAD6C\uC131\uD558\uB294\uAC8C \uC88B\uB2E4.","source":"@site/docs/nestjs/nest advanced schedule - cronjob.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced schedule - cronjob","permalink":"/docs/nestjs/nest advanced schedule - cronjob","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nestjs advanced multi-tenancy","permalink":"/docs/nestjs/nest advanced multi-tenancy"},"next":{"title":"nestjs standalone","permalink":"/docs/nestjs/nest advanced standalone"}}'),s=r(447259),a=r(255511);let o={},l="nest schedule",i={},c=[{value:"install",id:"install",level:2},{value:"main.ts",id:"maints",level:2},{value:"module",id:"module",level:2},{value:"Static task.service.ts",id:"static-taskservicets",level:2},{value:"Dynamic task.service.ts",id:"dynamic-taskservicets",level:2},{value:"example",id:"example",level:2}];function d(e){let n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"nest-schedule",children:"nest schedule"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"cronjob\uC740 \uD3EC\uD2B8\uAC00 \uD544\uC694 \uC5C6\uC73C\uB2C8 standalone\uC73C\uB85C \uAD6C\uC131\uD558\uB294\uAC8C \uC88B\uB2E4."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"install",children:"install"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npm i @nestjs/schedule\n"})}),"\n",(0,s.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"standalone"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { NestFactory } from "@nestjs/core";\r\nimport { AppModule } from "./app.module";\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.createApplicationContext(AppModule);\r\n}\r\nbootstrap();\n'})}),"\n",(0,s.jsx)(n.h2,{id:"module",children:"module"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { ScheduleModule } from "@nestjs/schedule";\r\n\r\n@Module({\r\n  imports: [ScheduleModule.forRoot(), TasksModule],\r\n  controllers: [AppController],\r\n  providers: [AppService],\r\n})\r\nexport class AppModule {}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"static-taskservicets",children:"Static task.service.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Injectable, Logger } from "@nestjs/common";\r\nimport { Cron, Interval, Timeout } from "@nestjs/schedule";\r\n\r\n@Injectable()\r\nexport class TasksService {\r\n  private readonly logger = new Logger(TasksService.name);\r\n\r\n  // @Cron("45 * * * * *")\r\n  @Cron(CronExpression.EVERY_45_SECONDS)\r\n  handleCron() {\r\n    this.logger.debug("Called when the second is 45");\r\n  }\r\n\r\n  @Interval(10000)\r\n  handleInterval() {\r\n    this.logger.debug("Called every 10 seconds");\r\n  }\r\n\r\n  @Timeout(5000)\r\n  handleTimeout() {\r\n    this.logger.debug("Called once after 5 seconds");\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"dynamic-taskservicets",children:"Dynamic task.service.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Injectable, Logger } from "@nestjs/common";\r\nimport { SchedulerRegistry } from "@nestjs/schedule";\r\nimport { CronJob } from "cron";\r\n@Injectable()\r\nexport class TaskService {\r\n  private readonly logger = new Logger(TaskService.name);\r\n  constructor(private readonly schedulerRegistry: SchedulerRegistry) {}\r\n\r\n  getCronJob(jobName: string) {\r\n    try {\r\n      return this.schedulerRegistry.getCronJob(jobName);\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  addCronJob({ jobName, date, callback }: { jobName: string; date: Date; callback: () => void }) {\r\n    const job = new CronJob(date, callback);\r\n    this.schedulerRegistry.addCronJob(jobName, job);\r\n    job.runOnce = true;\r\n    job.start();\r\n  }\r\n\r\n  deleteCron(jobName: string) {\r\n    this.schedulerRegistry.deleteCronJob(jobName);\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"example",children:"example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:" async scheduleClass(entity: Class) {\r\n    const job = this.taskService.getCronJob(entity.id);\r\n    if (job) {\r\n      this.taskService.deleteCron(entity.id);\r\n    }\r\n\r\n    if (dayjs().isAfter(entity.liveOpenAt)) {\r\n      this.logger.log(\r\n        `\u{1F6A9} ${entity.name} \uC774\uBBF8 \uC9C0\uB09C \uB77C\uC774\uBE0C \uAC15\uC758\uAC00 \uC624\uD508\uB418\uC5C8\uC2B5\uB2C8\uB2E4.`,\r\n      );\r\n      await this.prisma.class.update({\r\n        where: { id: entity.id },\r\n        data: {\r\n          status: 'LIVE_OPENED',\r\n        },\r\n      });\r\n      return;\r\n    }\r\n\r\n    this.taskService.addCronJob({\r\n      jobName: entity.id,\r\n      date: dayjs(entity.liveOpenAt).toDate(),\r\n      callback: async () => {\r\n        this.logger.log(`${entity.name} \uB77C\uC774\uBE0C \uAC15\uC758\uAC00 \uC624\uD508\uB418\uC5C8\uC2B5\uB2C8\uB2E4.`);\r\n        await this.prisma.class.update({\r\n          where: { id: entity.id },\r\n          data: {\r\n            status: 'LIVE_OPENED',\r\n          },\r\n        });\r\n      },\r\n    });\r\n    this.logger.log(`\u{1F550} \"${entity.name}\" \uB77C\uC774\uBE0C \uAC15\uC758\uAC00 \uC2A4\uCF00\uC904\uB9C1\uB418\uC5C8\uC2B5\uB2C8\uB2E4.`);\r\n  }\n"})})]})}function u(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},255511:function(e,n,r){r.d(n,{R:()=>o,x:()=>l});var t=r(596363);let s={},a=t.createContext(s);function o(e){let n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);