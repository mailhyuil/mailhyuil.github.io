"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[137195],{529087:(e,r,n)=>{n.d(r,{R:()=>p,x:()=>d});var t=n(596363);const s={},o=t.createContext(s);function p(e){const r=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:p(e.components),t.createElement(o.Provider,{value:r},e.children)}},833888:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>d,default:()=>l,frontMatter:()=>p,metadata:()=>t,toc:()=>i});const t=JSON.parse('{"id":"nestjs/nest advanced http2 - spdy","title":"nest advanced http2","description":"client\uc640 nginx\uac00 http2\ub97c \uc0ac\uc6a9\ud558\uace0 \uc788\ub2e4\uba74 nginx\uc640 nestjs \uc0ac\uc774\uc5d0\ub3c4 http2\ub97c \uc0ac\uc6a9\ud574\uc57c \uba40\ud2f0\ud50c\ub809\uc2f1\uc758 \uc774\uc810\uc744 \ub204\ub9b4 \uc218 \uc788\ub2e4.","source":"@site/docs/nestjs/nest advanced http2 - spdy.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced http2 - spdy","permalink":"/docs/nestjs/nest advanced http2 - spdy","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest health checks","permalink":"/docs/nestjs/nest advanced health checks - terminus"},"next":{"title":"nest advanced message queue AWS SQS","permalink":"/docs/nestjs/nest advanced message queue AWS SQS"}}');var s=n(447259),o=n(529087);const p={},d="nest advanced http2",a={},i=[{value:"install",id:"install",level:2},{value:"tls.key &amp; tls.crt required",id:"tlskey--tlscrt-required",level:2},{value:"main.ts",id:"maints",level:2},{value:"http-shutdown.provider.ts",id:"http-shutdownproviderts",level:2}];function c(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"nest-advanced-http2",children:"nest advanced http2"})}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"client\uc640 nginx\uac00 http2\ub97c \uc0ac\uc6a9\ud558\uace0 \uc788\ub2e4\uba74 nginx\uc640 nestjs \uc0ac\uc774\uc5d0\ub3c4 http2\ub97c \uc0ac\uc6a9\ud574\uc57c \uba40\ud2f0\ud50c\ub809\uc2f1\uc758 \uc774\uc810\uc744 \ub204\ub9b4 \uc218 \uc788\ub2e4."}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"install",children:"install"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-sh",children:"npm i spdy\r\nnpm i -D @types/spdy\n"})}),"\n",(0,s.jsx)(r.h2,{id:"tlskey--tlscrt-required",children:"tls.key & tls.crt required"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-sh",children:"openssl req -x509 -newkey rsa:4096 -nodes -sha256 -keyout private.pem -out crt.pem\n"})}),"\n",(0,s.jsx)(r.h2,{id:"maints",children:"main.ts"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:'import express, { Express } from "express";\r\nimport { ServerOptions, createServer } from "spdy";\r\n\r\nasync function bootstrap() {\r\n  const expressApp: Express = express();\r\n  const app = await NestFactory.create(AppModule, new ExpressAdapter(expressApp));\r\n\r\n  /** Config */\r\n  /*   ....  */\r\n  app.enableCors();\r\n\r\n  /** Init */\r\n  await app.init();\r\n  /** Create HTTP Server */\r\n  const spdyOpts: ServerOptions = {\r\n    key: fs.readFileSync(process.env["PRIVATE_KEY_PATH"], "utf8"),\r\n    cert: fs.readFileSync(process.env["CERTIFICATE_PATH"], "utf8"),\r\n  };\r\n  const http2Server = createServer(spdyOpts, expressApp);\r\n  /** Port */\r\n  const port = process.env.SERVER_PORT || 3000;\r\n  /** Server Listen */\r\n  http2Server.listen(port);\r\n  Logger.log(`\ud83d\ude80 Application is running on: http://localhost:${port}`);\r\n  /** Shutdown */\r\n  const shutdownProvider = app.get(HttpShutdownProvider);\r\n  shutdownProvider.addHttpServer(http2Server);\r\n}\r\n\r\nbootstrap();\n'})}),"\n",(0,s.jsx)(r.h2,{id:"http-shutdownproviderts",children:"http-shutdown.provider.ts"}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"nestjs\ub294 \uc784\uc758\ub85c \uc0dd\uc131\ud55c http server\ub97c \ub2eb\ub294 \uae30\ub2a5\uc744 \uc81c\uacf5\ud558\uc9c0 \uc54a\uae30 \ub54c\ubb38\uc5d0 OnApplicationShutdown\uc744 \uc0ac\uc6a9\ud558\uc5ec \uc9c1\uc811 \uad6c\ud604\ud574\uc57c \ud55c\ub2e4."}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"\uc0dd\uc131 \ud6c4 App Module\uc758 Provider\uc5d0 \ub4f1\ub85d"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"@Injectable()\r\nexport class HttpShutdownProvider implements OnApplicationShutdown {\r\n  private httpServers: http.Server[] = [];\r\n\r\n  public addHttpServer(server: http.Server): void {\r\n    this.httpServers.push(server);\r\n  }\r\n\r\n  public async onApplicationShutdown(): Promise<void> {\r\n    await Promise.all(\r\n      this.httpServers.map(\r\n        server =>\r\n          new Promise((resolve, reject) => {\r\n            server.close(error => {\r\n              if (error) {\r\n                reject(error);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n            });\r\n          }),\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nconst shutdownObserver = app.get(ShutdownObserver);\r\nshutdownObserver.addHttpServer(httpServer);\r\nshutdownObserver.addHttpServer(httpsServer);\n"})})]})}function l(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);