"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[238905],{427681:(r,e,n)=>{n.r(e),n.d(e,{assets:()=>a,contentTitle:()=>i,default:()=>R,frontMatter:()=>c,metadata:()=>s,toc:()=>p});const s=JSON.parse('{"id":"nestjs/nest error handling","title":"nestjs error handling","description":"error.ts","source":"@site/docs/nestjs/nest error handling.md","sourceDirName":"nestjs","slug":"/nestjs/nest error handling","permalink":"/docs/nestjs/nest error handling","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest mailer nestmailer","permalink":"/docs/nestjs/nest email nestmailer"},"next":{"title":"nest eventEmitter","permalink":"/docs/nestjs/nest event-emitter"}}');var t=n(447259),o=n(529087);const c={},i="nestjs error handling",a={},p=[{value:"error.ts",id:"errorts",level:2},{value:"business-exception.ts",id:"business-exceptionts",level:2},{value:"BusinessException",id:"businessexception",level:2},{value:"\uc7a1\uc9c0 \ubabb\ud55c HttpException",id:"\uc7a1\uc9c0-\ubabb\ud55c-httpexception",level:2},{value:"ValidationException",id:"validationexception",level:2}];function l(r){const e={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...r.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"nestjs-error-handling",children:"nestjs error handling"})}),"\n",(0,t.jsx)(e.h2,{id:"errorts",children:"error.ts"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:'export type ERROR = {\r\n  code: string;\r\n  message: string;\r\n  data?: any;\r\n};\r\n\r\nexport namespace ERROR {\r\n  export const USER_NOT_FOUND: ERROR = {\r\n    code: "0100",\r\n    message: `\uc720\uc800\ub97c \ucc3e\uc9c0 \ubabb\ud588\uc2b5\ub2c8\ub2e4.`,\r\n  };\r\n  export const USER_ALREADY_EXISTS: ERROR = {\r\n    code: "0101",\r\n    message: `\r\n\uc720\uc800\uac00 \uc774\ubbf8 \uc874\uc7ac\ud569\ub2c8\ub2e4.\r\n\uc544\uc774\ub514\ub97c \ub2e4\uc2dc \ud655\uc778\ud558\uace0 \uac00\uc785\ud558\ub824\ub294 \uc544\uc774\ub514\uac00 \uc774\ubbf8 \uc874\uc7ac\ud558\ub294\uc9c0 \ud655\uc778\ud558\uc2ed\uc2dc\uc624.\r\n`,\r\n  };\r\n  export const USER_CREATE_FAILED: ERROR = {\r\n    code: "0102",\r\n    message: "\uc720\uc800 \uc0dd\uc131\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4.",\r\n  };\r\n  export const USER_UPDATE_FAILED: ERROR = {\r\n    code: "0103",\r\n    message: "\uc720\uc800 \uc218\uc815\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4.",\r\n  };\r\n  export const NOTICE_NOT_FOUND: ERROR = {\r\n    code: "0200",\r\n    message: "\uacf5\uc9c0\uc0ac\ud56d\uc744 \ucc3e\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.",\r\n  };\r\n  export const NOTICE_CREATE_FAILED: ERROR = {\r\n    code: "0201",\r\n    message: "\uacf5\uc9c0\uc0ac\ud56d \uc0dd\uc131\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4.",\r\n  };\r\n  export const NOTICE_UPDATE_FAILED: ERROR = {\r\n    code: "0202",\r\n    message: "\uacf5\uc9c0\uc0ac\ud56d \uc218\uc815\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4.",\r\n  };\r\n}\r\n\r\nexport const createError = (error: ERROR, data?: any): ERROR => ({\r\n  ...error,\r\n  data,\r\n});\n'})}),"\n",(0,t.jsx)(e.h2,{id:"business-exceptionts",children:"business-exception.ts"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:'import { HttpException, HttpStatus } from "@nestjs/common";\r\nimport { createError, ERROR } from "./error";\r\n\r\nexport class BusinessException extends HttpException {\r\n  constructor(error: ERROR, status: HttpStatus, cause?: any) {\r\n    super(error, status, cause);\r\n  }\r\n}\r\n\r\nexport class UserNotFoundException extends BusinessException {\r\n  constructor(data?: any, cause?: any) {\r\n    const response = createError(ERROR.USER_NOT_FOUND, data);\r\n    super(response, HttpStatus.NOT_FOUND, cause);\r\n  }\r\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"businessexception",children:"BusinessException"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"\uae30\ubcf8\uc73c\ub85c \ubc1c\uc0dd\ud560 \uc218 \uc788\ub294 \uc5d0\ub7ec\ub4e4\uc740 catch\ud574\uc11c BusinessException\uc73c\ub85c \ubcf4\ub0b4\uc8fc\uae30"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"BusinessException\uc740 ERROR \uac1d\uccb4\ub97c \ubcf4\ub0b8\ub2e4"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:'import { ArgumentsHost, Catch, ExceptionFilter, Logger } from "@nestjs/common";\r\nimport { Prisma } from "@prisma/client";\r\nimport { Request, Response } from "express";\r\nimport { PrismaError } from "prisma-error-enum";\r\nimport { ERROR } from "../error";\r\nimport { BusinessException } from "../exception";\r\n\r\n@Catch(BusinessException)\r\nexport class BusinessExceptionFilter implements ExceptionFilter {\r\n  private readonly logger = new Logger(BusinessExceptionFilter.name);\r\n  catch(error: BusinessException, host: ArgumentsHost) {\r\n    const ctx = host.switchToHttp();\r\n    const res = ctx.getResponse<Response>();\r\n    const req = ctx.getRequest<Request>();\r\n    const errorStatusCode = error.getStatus();\r\n    const errorMessage = error.message;\r\n    const errorStack = error.stack;\r\n\r\n    const { code, message, cause } = error.getResponse() as ERROR;\r\n\r\n    const clientError = { code, message };\r\n\r\n    const clientErrorResponse = {\r\n      statusCode: errorStatusCode,\r\n      path: req.url,\r\n      timestamp: new Date().toISOString(),\r\n      message: errorMessage,\r\n      error: {\r\n        ...ERROR.BUSINESS_ERROR,\r\n        ...clientError,\r\n      },\r\n    };\r\n\r\n    if (cause instanceof Prisma.PrismaClientKnownRequestError) {\r\n      if (cause.code === PrismaError.UniqueConstraintViolation) {\r\n        clientErrorResponse.message = `\uc911\ubcf5\ub41c \ub370\uc774\ud130\uac00 \uc874\uc7ac\ud569\ub2c8\ub2e4. [${cause.meta.target}]`;\r\n      }\r\n    }\r\n\r\n    res.status(errorStatusCode).json(clientErrorResponse);\r\n\r\n    this.logger.error(`\r\nMESSAGE: ${clientErrorResponse.message}\r\nTIMESTAMP: ${clientErrorResponse.timestamp}\r\nMETHOD: ${req.method}\r\nPATH: ${clientErrorResponse.path}\r\nERROR: ${JSON.stringify(clientErrorResponse.error)}\r\nERROR STACK: ${errorStack}\r\nCAUSE: ${JSON.stringify(cause)}\r\nCAUSE STACK: ${cause}\r\n`);\r\n  }\r\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\uc7a1\uc9c0-\ubabb\ud55c-httpexception",children:"\uc7a1\uc9c0 \ubabb\ud55c HttpException"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"BusinessException\uc73c\ub85c \uc815\uc758\ub418\uc9c0 \uc54a\uc740 \uc5d0\ub7ec\ub4e4"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"response\uc5d0 ERROR \uac1d\uccb4\uac00 \uc544\ub2cc string\uc774 \ub4e4\uc5b4\uc788\ub2e4."}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:'code: "-1"'}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:'import { ArgumentsHost, Catch, ExceptionFilter, HttpException, Logger } from "@nestjs/common";\r\nimport { Request, Response } from "express";\r\nimport { ERROR } from "../error";\r\n\r\n@Catch(HttpException)\r\nexport class HttpExceptionFilter implements ExceptionFilter {\r\n  private readonly logger = new Logger(HttpExceptionFilter.name);\r\n  catch(error: HttpException, host: ArgumentsHost) {\r\n    const ctx = host.switchToHttp();\r\n    const res = ctx.getResponse<Response>();\r\n    const req = ctx.getRequest<Request>();\r\n    const statusCode = error.getStatus();\r\n\r\n    const response = error.getResponse() as string;\r\n    const message = error.message;\r\n    const cause = error.cause;\r\n    const stack = error.stack;\r\n\r\n    const clientErrorResponse = {\r\n      statusCode,\r\n      message,\r\n      path: req.url,\r\n      timestamp: new Date().toISOString(),\r\n      error: {\r\n        ...ERROR.HTTP_ERROR,\r\n        message: response,\r\n      } as ERROR,\r\n    };\r\n\r\n    res.status(statusCode).json(clientErrorResponse);\r\n\r\n    this.logger.error(`\r\nMESSAGE: ${clientErrorResponse.message}\r\nTIMESTAMP: ${clientErrorResponse.timestamp}\r\nMETHOD: ${req.method}\r\nPATH: ${clientErrorResponse.path}\r\nERROR: ${JSON.stringify(clientErrorResponse.error)}\r\nSTACK: ${stack}\r\nCAUSE: ${cause}\r\n`);\r\n  }\r\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"validationexception",children:"ValidationException"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"\uc720\ud6a8\uc131 \uac80\uc0ac\uc5d0\uc11c \uc2e4\ud328\ud55c \uc5d0\ub7ec"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:'code: "-3"'}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:'import { ValidationException } from "@/server/pipes/global-validation.pipe";\r\nimport { ArgumentsHost, Catch, ExceptionFilter, Logger } from "@nestjs/common";\r\nimport { Request, Response } from "express";\r\nimport { ERROR } from "../error";\r\n\r\n@Catch(ValidationException)\r\nexport class ValidationExceptionFilter implements ExceptionFilter {\r\n  private readonly logger = new Logger(ValidationExceptionFilter.name);\r\n  catch(error: ValidationException, host: ArgumentsHost) {\r\n    const ctx = host.switchToHttp();\r\n    const res = ctx.getResponse<Response>();\r\n    const req = ctx.getRequest<Request>();\r\n    const statusCode = error.getStatus();\r\n    const response = error.getResponse() as ERROR;\r\n    const message = error.message;\r\n    const cause = error.cause;\r\n    const stack = error.stack;\r\n\r\n    const clientErrorResponse = {\r\n      statusCode,\r\n      message,\r\n      path: req.url,\r\n      timestamp: new Date().toISOString(),\r\n      error: response,\r\n    };\r\n\r\n    res.status(statusCode).json(clientErrorResponse);\r\n\r\n    this.logger.error(`\r\nMESSAGE: ${clientErrorResponse.message}\r\nTIMESTAMP: ${clientErrorResponse.timestamp}\r\nMETHOD: ${req.method}\r\nPATH: ${clientErrorResponse.path}\r\nERROR: ${JSON.stringify(clientErrorResponse.error)}\r\nSTACK: ${stack}\r\nCAUSE: ${cause}\r\n`);\r\n  }\r\n}\n'})})]})}function R(r={}){const{wrapper:e}={...(0,o.R)(),...r.components};return e?(0,t.jsx)(e,{...r,children:(0,t.jsx)(l,{...r})}):l(r)}},529087:(r,e,n)=>{n.d(e,{R:()=>c,x:()=>i});var s=n(596363);const t={},o=s.createContext(t);function c(r){const e=s.useContext(o);return s.useMemo(function(){return"function"==typeof r?r(e):{...e,...r}},[e,r])}function i(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(t):r.components||t:c(r.components),s.createElement(o.Provider,{value:e},r.children)}}}]);