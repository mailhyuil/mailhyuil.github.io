"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["602978"],{352307:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>a,toc:()=>p,default:()=>l,metadata:()=>r,assets:()=>c,contentTitle:()=>i});var r=JSON.parse('{"id":"api/api payment Toss Payments webhook","title":"api payment toss webhook","description":"nginx","source":"@site/docs/api/api payment Toss Payments webhook.md","sourceDirName":"api","slug":"/api/api payment Toss Payments webhook","permalink":"/docs/api/api payment Toss Payments webhook","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"toss payment payment intents","permalink":"/docs/api/api payment Toss Payments intents"},"next":{"title":"api payment Toss Payments","permalink":"/docs/api/api payment Toss Payments"}}'),s=t(447259),o=t(255511);let a={},i="api payment toss webhook",c={},p=[{value:"nginx",id:"nginx",level:2},{value:"main.ts",id:"maints",level:2},{value:"toss-payments-webhook.guard.ts",id:"toss-payments-webhookguardts",level:2},{value:"webhook handler",id:"webhook-handler",level:2}];function d(e){let n={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"api-payment-toss-webhook",children:"api payment toss webhook"})}),"\n",(0,s.jsx)(n.h2,{id:"nginx",children:"nginx"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-conf",children:"location /api/v1/ {\r\n    proxy_set_header  X-Forwarded-For $remote_addr;\r\n    proxy_pass http://server:3000;\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'app.set("trust proxy", true);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"toss-payments-webhookguardts",children:"toss-payments-webhook.guard.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { CanActivate, ExecutionContext, Injectable, UnauthorizedException } from "@nestjs/common";\r\nimport { Request } from "express";\r\n\r\nconst whitelist = ["13.124.18.147", "13.124.108.35", "3.36.173.151", "3.38.81.32"];\r\n\r\n@Injectable()\r\nexport class TossPaymentsWebhookGuard implements CanActivate {\r\n  async canActivate(context: ExecutionContext) {\r\n    const req: Request = context.switchToHttp().getRequest();\r\n    const ip = req.ip;\r\n    if (!ip) throw new Error("IP \uC8FC\uC18C\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");\r\n    if (ip && !whitelist.includes(ip)) {\r\n      throw new UnauthorizedException("\uD5C8\uC6A9\uB418\uC9C0 \uC54A\uC740 IP \uC8FC\uC18C\uC785\uB2C8\uB2E4.");\r\n    }\r\n    return true;\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"webhook-handler",children:"webhook handler"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"  @Post('webhook')\r\n  @ApiOperation({\r\n    summary: 'Toss Payment \uC6F9\uD6C5',\r\n  })\r\n  @ApiOkResponse()\r\n  @UseGuards(TossPaymentsWebhookGuard)\r\n  async webhook(@Body() body: any) {\r\n    const eventType = body.eventType;\r\n    switch (eventType) {\r\n      case 'PAYMENT_STATUS_CHANGED':\r\n        await this.paymentService.changePaymentStatus(body);\r\n        break;\r\n      case 'DEPOSIT_CALLBACK':\r\n        await this.paymentService.changePaymentStatus(body);\r\n        break;\r\n      case 'PAYOUT_STATUS_CHANGED':\r\n        throw Error('\uC11C\uBE0C\uBAB0 \uC9C0\uAE09\uB300\uD589 \uC11C\uBE44\uC2A4\uB294 \uC9C0\uC6D0\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.');\r\n      case 'METHOD_UPDATED':\r\n        throw Error('\uBE0C\uB79C\uB4DC\uD398\uC774 \uC11C\uBE44\uC2A4\uB294 \uC9C0\uC6D0\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.');\r\n      case 'CUSTOMER_STATUS_CHANGED':\r\n        throw Error('\uBE0C\uB79C\uB4DC\uD398\uC774 \uC11C\uBE44\uC2A4\uB294 \uC9C0\uC6D0\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.');\r\n    }\r\n  }\n"})})]})}function l(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},255511:function(e,n,t){t.d(n,{R:()=>a,x:()=>i});var r=t(596363);let s={},o=r.createContext(s);function a(e){let n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);