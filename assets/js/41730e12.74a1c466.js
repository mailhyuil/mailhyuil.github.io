"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["996257"],{682108:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>i,toc:()=>d,default:()=>l,metadata:()=>r,assets:()=>c,contentTitle:()=>a});var r=JSON.parse('{"id":"testing/testing nestjs Service","title":"nest testing service","description":"prisma\uC758 now() \uC0AC\uC6A9 \uC2DC createdAt\uC744 [Function: mockConstructor]\uB85C \uB300\uCCB4\uD574\uBC84\uB9AC\uAE30 \uB54C\uBB38\uC5D0 \uBA85\uC2DC\uC801\uC73C\uB85C new Date()\uB85C \uB300\uCCB4\uD574\uC918\uC57C \uD55C\uB2E4.","source":"@site/docs/testing/testing nestjs Service.md","sourceDirName":"testing","slug":"/testing/testing nestjs Service","permalink":"/docs/testing/testing nestjs Service","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest testing prisma","permalink":"/docs/testing/testing nestjs Service PrismaService"},"next":{"title":"nest testing TestBed","permalink":"/docs/testing/testing nestjs TestBed"}}'),o=t(447259),s=t(255511);let i={},a="nest testing service",c={},d=[];function p(e){let n={blockquote:"blockquote",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"nest-testing-service",children:"nest testing service"})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"prisma\uC758 now() \uC0AC\uC6A9 \uC2DC createdAt\uC744 [Function: mockConstructor]\uB85C \uB300\uCCB4\uD574\uBC84\uB9AC\uAE30 \uB54C\uBB38\uC5D0 \uBA85\uC2DC\uC801\uC73C\uB85C new Date()\uB85C \uB300\uCCB4\uD574\uC918\uC57C \uD55C\uB2E4."}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"$transaction\uC744 \uC0AC\uC6A9\uD558\uAE30 \uC704\uD574 prismaMock.$transaction.mockImplementation(cb => cb(prismaMock));\uB97C \uCD94\uAC00\uD574\uC900\uB2E4."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:'import { NotFoundException } from "@nestjs/common";\r\nimport { Test, TestingModule } from "@nestjs/testing";\r\nimport { Prisma, PrismaClient, User } from "@prisma/client";\r\nimport { plainToInstance } from "class-transformer";\r\nimport { DeepMockProxy, mock, mockDeep } from "jest-mock-extended";\r\nimport { PrismaService } from "../../prisma/prisma.service";\r\nimport { CreateExampleDTO, ExampleDTO, ResponseExampleDTO, UpdateExampleDTO } from "./example.dto";\r\nimport { ExampleService } from "./example.service";\r\nconst user = mock<User>({});\r\n\r\ntype ExampleEntityType = Prisma.ExampleGetPayload<{\r\n  include: {};\r\n}>;\r\nconst entity = mock<ExampleEntityType>({\r\n  createdAt: new Date(),\r\n});\r\n\r\ndescribe("ExampleService", () => {\r\n  let prismaMock: DeepMockProxy<PrismaClient>;\r\n  let service: ExampleService;\r\n\r\n  beforeEach(async () => {\r\n    prismaMock = mockDeep<PrismaClient>();\r\n    prismaMock.$transaction.mockImplementation(cb => cb(prismaMock));\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        ExampleService,\r\n        {\r\n          provide: PrismaService,\r\n          useValue: prismaMock,\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<ExampleService>(ExampleService);\r\n  });\r\n\r\n  it("should be defined", () => {\r\n    expect(service).toBeDefined();\r\n    expect(prismaMock).toBeDefined();\r\n  });\r\n\r\n  describe("findAll", () => {\r\n    it("should return an array of examples", async () => {\r\n      const dto = plainToInstance(ExampleDTO, entity);\r\n      prismaMock.example.findMany.mockResolvedValue([entity]);\r\n      const found = await service.findAll();\r\n      expect(found).toEqual([dto]);\r\n    });\r\n  });\r\n\r\n  describe("findById", () => {\r\n    it("should return ResponseExampleDTO", async () => {\r\n      const dto = plainToInstance(ResponseExampleDTO, {\r\n        data: entity,\r\n        metadata: {\r\n          prev: undefined,\r\n          next: undefined,\r\n        },\r\n      } as ResponseExampleDTO);\r\n\r\n      prismaMock.example.findUniqueOrThrow.mockResolvedValue(entity);\r\n      prismaMock.example.findFirst.mockResolvedValueOnce(undefined);\r\n\r\n      const found = await service.findById("good-id");\r\n      expect(found).toEqual(dto);\r\n    });\r\n\r\n    it("should throw NotFoundException", async () => {\r\n      prismaMock.example.findUniqueOrThrow.mockRejectedValueOnce(new NotFoundException());\r\n      expect(service.findById("bad-id")).rejects.toThrow(NotFoundException);\r\n    });\r\n  });\r\n\r\n  describe("create", () => {\r\n    const createDto = mock<CreateExampleDTO>({});\r\n    it("should return an example", async () => {\r\n      const dto = plainToInstance(ExampleDTO, entity);\r\n      prismaMock.example.create.mockResolvedValue(entity);\r\n      const created = await service.create(createDto);\r\n      expect(created).toEqual(dto);\r\n    });\r\n  });\r\n\r\n  describe("update", () => {\r\n    const updateDto = mock<UpdateExampleDTO>({});\r\n    it("should return an example", async () => {\r\n      const dto = plainToInstance(ExampleDTO, entity);\r\n      prismaMock.example.update.mockResolvedValue(entity);\r\n      const updated = await service.update("good-id", updateDto);\r\n      expect(updated).toEqual(dto);\r\n    });\r\n  });\r\n\r\n  describe("delete", () => {\r\n    it("should return an example", async () => {\r\n      prismaMock.example.delete.mockResolvedValueOnce(entity);\r\n      expect(service.delete("good-id")).resolves.not.toThrow(new NotFoundException());\r\n    });\r\n  });\r\n});\n'})})]})}function l(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},255511:function(e,n,t){t.d(n,{R:()=>i,x:()=>a});var r=t(596363);let o={},s=r.createContext(o);function i(e){let n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);