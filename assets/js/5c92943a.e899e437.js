"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[744113],{529087:(e,n,c)=>{c.d(n,{R:()=>s,x:()=>i});var r=c(596363);const t={},o=r.createContext(t);function s(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),r.createElement(o.Provider,{value:n},e.children)}},874262:(e,n,c)=>{c.r(n),c.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>l,frontMatter:()=>s,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"cicd github actions/cicd github actions docker","title":"cicd github actions docker","description":"secrets \uc124\uc815","source":"@site/docs/cicd github actions/cicd github actions docker.md","sourceDirName":"cicd github actions","slug":"/cicd github actions/cicd github actions docker","permalink":"/docs/cicd github actions/cicd github actions docker","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"cicd github actions docker cache","permalink":"/docs/cicd github actions/cicd github actions docker cache"},"next":{"title":"cicd github actions nodejs","permalink":"/docs/cicd github actions/cicd github actions nodejs"}}');var t=c(447259),o=c(529087);const s={},i="cicd github actions docker",d={},a=[];function u(e){const n={blockquote:"blockquote",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"cicd-github-actions-docker",children:"cicd github actions docker"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"secrets \uc124\uc815"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"DOCKER_USERNAME, DOCKER_PASSWORD, DOCKER_REGISTRY"}),"\n",(0,t.jsx)(n.p,{children:"SSH_HOST, SSH_USERNAME, SSH_KEY, SSH_PORT"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'name: Deploy Client Production\r\non:\r\n  push:\r\n    branches:\r\n      - main\r\n    paths:\r\n      - "apps/client/**"\r\n      - ".github/workflows/client-production.yml"\r\n      - "docker/client.Dockerfile"\r\n  workflow_dispatch:\r\njobs:\r\n  deploy_client_prod:\r\n    runs-on: self-hosted\r\n    steps:\r\n      - name: Checkout\r\n        uses: actions/checkout@v4\r\n\r\n      - name: Login to Image Registry\r\n        uses: docker/login-action@v3\r\n        with:\r\n          username: ${{ secrets.DOCKER_USERNAME }}\r\n          password: ${{ secrets.DOCKER_PASSWORD }}\r\n          registry: ${{ secrets.DOCKER_REGISTRY }}\r\n\r\n      - name: Set up Docker Buildx (Multi Platform Builder)\r\n        uses: docker/setup-buildx-action@v3\r\n\r\n      - name: Build and Push\r\n        uses: docker/build-push-action@v5\r\n        with:\r\n          context: .\r\n          push: true\r\n          cache-from: type=gha # cache \uc0ac\uc6a9\r\n          cache-to: type=gha,mode=max # cache \uc0ac\uc6a9\r\n          file: ./docker/client.Dockerfile\r\n          target: production # target\uc740 stage\uc758 \uc774\ub984 "AS [target]"\r\n          tags: ${{ secrets.DOCKER_REGISTRY }}/client:${{ github.sha }} , ${{ secrets.DOCKER_REGISTRY }}/client:latest\r\n\r\n      # self-host \uc0ac\uc6a9\r\n      - name: Access to Remote Server & Run Container [CD]\r\n        run: |\r\n          echo "${{ secrets.SSH_KEY }}" >> $HOME/ssh_key.pem\r\n          chmod 600 $HOME/ssh_key.pem\r\n          ssh -o StrictHostKeyChecking=no -i $HOME/ssh_key.pem ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << ENDSSH\r\n            sudo -i\r\n            cd /home/ubuntu\r\n            docker compose pull client\r\n            docker compose down client\r\n            docker compose down nginx\r\n            docker volume remove ubuntu_client-data\r\n            docker compose up -d\r\n            docker image prune -af\r\n          ENDSSH\r\n          rm $HOME/ssh_key.pem\r\n\r\n      # appleboy/ssh-action \uc0ac\uc6a9\r\n      - name: Access to Remote Server & Run Container [CD]\r\n        uses: appleboy/ssh-action@v0.1.8\r\n        with:\r\n          host: ${{ secrets.SSH_HOST }}\r\n          username: ${{ secrets.SSH_USERNAME }}\r\n          key: ${{ secrets.SSH_KEY }}\r\n          port: 22\r\n          script: |\r\n            sudo -i\r\n            cd /home/ubuntu\r\n            docker compose pull client\r\n            docker compose down client\r\n            docker compose down nginx\r\n            docker volume remove ubuntu_client-data\r\n            docker compose up -d\r\n            docker image prune -af\n'})})]})}function l(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}}}]);