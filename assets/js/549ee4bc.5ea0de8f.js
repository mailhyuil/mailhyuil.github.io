"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["110053"],{484322:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>l,toc:()=>c,default:()=>u,metadata:()=>s,assets:()=>a,contentTitle:()=>i});var s=JSON.parse('{"id":"nestjs/nest file upload stream - busboy","title":"nest file busboy","description":"\uD30C\uC77C\uC744 in-memory\uC5D0 \uC800\uC7A5\uD558\uC9C0 \uC54A\uACE0 \uBC14\uB85C \uC2A4\uD2B8\uB9BC\uC73C\uB85C \uC77D\uC5B4\uC11C \uCC98\uB9AC\uD560\uAC70\uB77C\uBA74 busboy\uB97C \uC0AC\uC6A9\uD558\uB294 \uAC83\uC774 \uC88B\uB2E4.","source":"@site/docs/nestjs/nest file upload stream - busboy.md","sourceDirName":"nestjs","slug":"/nestjs/nest file upload stream - busboy","permalink":"/docs/nestjs/nest file upload stream - busboy","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest file busboy s3 upload","permalink":"/docs/nestjs/nest file upload stream - busboy + s3"},"next":{"title":"nest file upload","permalink":"/docs/nestjs/nest file upload"}}'),t=r(447259),o=r(255511);let l={},i="nest file busboy",a={},c=[{value:"install",id:"install",level:2},{value:"main.ts",id:"maints",level:2},{value:"controller",id:"controller",level:2},{value:"angular",id:"angular",level:2}];function d(e){let n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"nest-file-busboy",children:"nest file busboy"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"\uD30C\uC77C\uC744 in-memory\uC5D0 \uC800\uC7A5\uD558\uC9C0 \uC54A\uACE0 \uBC14\uB85C \uC2A4\uD2B8\uB9BC\uC73C\uB85C \uC77D\uC5B4\uC11C \uCC98\uB9AC\uD560\uAC70\uB77C\uBA74 busboy\uB97C \uC0AC\uC6A9\uD558\uB294 \uAC83\uC774 \uC88B\uB2E4."}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"\uD30C\uC77C\uC744 \uC5C5\uB85C\uB4DC\uD558\uBA74 nestjs\uB97C \uAC70\uCCD0\uC11C \uC2A4\uD1A0\uB9AC\uC9C0(S3)\uB85C \uBC14\uB85C \uC804\uC1A1\uD558\uB294 \uACBD\uC6B0"}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"multer\uB3C4 \uB0B4\uBD80\uC801\uC73C\uB85C busboy\uB97C \uC0AC\uC6A9\uD55C\uB2E4."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"install",children:"install"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"npm i connect-busboy\r\nnpm i -D @types/connect-busboy\n"})}),"\n",(0,t.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:'import busboy from "connect-busboy";\r\n\r\napp.use(busboy());\n'})}),"\n",(0,t.jsx)(n.h2,{id:"controller",children:"controller"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:'import { Request } from "express";\r\nimport fs, { createWriteStream } from "fs";\r\n\r\nuploadByStream(dir: string, req: Request) {\r\n  return new Promise<string>((resolve, reject) => {\r\n    req.pipe(req.busboy);\r\n\r\n    req.busboy.on("file", (name, file, info) => {\r\n\r\n      const { filename } = info;\r\n      const encodedName = Buffer.from(filename, "latin1").toString("utf8");\r\n      const path = `${dir}/${dayjs().month() + 1}/${dayjs().date()}`;\r\n      const finalDir = `${this.options.dir}/${path}`;\r\n      if (!fs.existsSync(finalDir)) {\r\n        fs.mkdirSync(finalDir, { recursive: true });\r\n      }\r\n      const key = `${path}/${encodedName}`;\r\n      const ws = createWriteStream(`${this.options.dir}/${key}`);\r\n\r\n      ws.on("close", () => {\r\n        console.log("Write Stream Closed");\r\n      });\r\n\r\n      ws.on("finish", () => {\r\n        console.log("Write Stream Finished");\r\n      });\r\n\r\n      file.on("data", (data) => {\r\n        ws.write(data);\r\n      });\r\n\r\n      file.on("end", () => {\r\n        console.log("busboy ended");\r\n        ws.end();\r\n        ws.close();\r\n        resolve(key);\r\n      });\r\n\r\n      file.on("error", (err) => {\r\n        console.error("busboy error : ", err);\r\n        reject(err);\r\n      });\r\n    });\r\n  });\r\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"angular",children:"angular"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:'const formData = new FormData();\r\nformData.append("file", file);\r\n\r\nhttp.post("http://localhost:3000/file", formData).subscribe();\n'})})]})}function u(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},255511:function(e,n,r){r.d(n,{R:()=>l,x:()=>i});var s=r(596363);let t={},o=s.createContext(t);function l(e){let n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);