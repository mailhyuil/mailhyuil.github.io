"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[347577],{39770:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>p});const s=JSON.parse('{"id":"api/api payment Toss Payments webhook","title":"api payment toss webhook","description":"nginx","source":"@site/docs/api/api payment Toss Payments webhook.md","sourceDirName":"api","slug":"/api/api payment Toss Payments webhook","permalink":"/docs/api/api payment Toss Payments webhook","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"toss payment payment intents","permalink":"/docs/api/api payment Toss Payments intents"},"next":{"title":"api payment Toss Payments","permalink":"/docs/api/api payment Toss Payments"}}');var r=t(447259),o=t(529087);const a={},i="api payment toss webhook",c={},p=[{value:"nginx",id:"nginx",level:2},{value:"main.ts",id:"maints",level:2},{value:"toss-payments-webhook.guard.ts",id:"toss-payments-webhookguardts",level:2},{value:"webhook handler",id:"webhook-handler",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"api-payment-toss-webhook",children:"api payment toss webhook"})}),"\n",(0,r.jsx)(n.h2,{id:"nginx",children:"nginx"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"location /api/v1/ {\r\n    proxy_set_header  X-Forwarded-For $remote_addr;\r\n    proxy_pass http://server:3000;\r\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'app.set("trust proxy", true);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"toss-payments-webhookguardts",children:"toss-payments-webhook.guard.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import { CanActivate, ExecutionContext, Injectable, UnauthorizedException } from "@nestjs/common";\r\nimport { Request } from "express";\r\n\r\nconst whitelist = ["13.124.18.147", "13.124.108.35", "3.36.173.151", "3.38.81.32"];\r\n\r\n@Injectable()\r\nexport class TossPaymentsWebhookGuard implements CanActivate {\r\n  async canActivate(context: ExecutionContext) {\r\n    const req: Request = context.switchToHttp().getRequest();\r\n    const ip = req.ip;\r\n    if (!ip) throw new Error("IP \uc8fc\uc18c\ub97c \ucc3e\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.");\r\n    if (ip && !whitelist.includes(ip)) {\r\n      throw new UnauthorizedException("\ud5c8\uc6a9\ub418\uc9c0 \uc54a\uc740 IP \uc8fc\uc18c\uc785\ub2c8\ub2e4.");\r\n    }\r\n    return true;\r\n  }\r\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"webhook-handler",children:"webhook handler"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"  @Post('webhook')\r\n  @ApiOperation({\r\n    summary: 'Toss Payment \uc6f9\ud6c5',\r\n  })\r\n  @ApiOkResponse()\r\n  @UseGuards(TossPaymentsWebhookGuard)\r\n  async webhook(@Body() body: any) {\r\n    const eventType = body.eventType;\r\n    switch (eventType) {\r\n      case 'PAYMENT_STATUS_CHANGED':\r\n        await this.paymentService.changePaymentStatus(body);\r\n        break;\r\n      case 'DEPOSIT_CALLBACK':\r\n        await this.paymentService.changePaymentStatus(body);\r\n        break;\r\n      case 'PAYOUT_STATUS_CHANGED':\r\n        throw Error('\uc11c\ube0c\ubab0 \uc9c0\uae09\ub300\ud589 \uc11c\ube44\uc2a4\ub294 \uc9c0\uc6d0\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.');\r\n      case 'METHOD_UPDATED':\r\n        throw Error('\ube0c\ub79c\ub4dc\ud398\uc774 \uc11c\ube44\uc2a4\ub294 \uc9c0\uc6d0\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.');\r\n      case 'CUSTOMER_STATUS_CHANGED':\r\n        throw Error('\ube0c\ub79c\ub4dc\ud398\uc774 \uc11c\ube44\uc2a4\ub294 \uc9c0\uc6d0\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.');\r\n    }\r\n  }\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},529087:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>i});var s=t(596363);const r={},o=s.createContext(r);function a(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);