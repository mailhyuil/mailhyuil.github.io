"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[542596],{529087:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>i});var s=r(596363);const t={},o=s.createContext(t);function l(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(o.Provider,{value:n},e.children)}},709763:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"nestjs/nest file upload stream - busboy","title":"nest file busboy","description":"\ud30c\uc77c\uc744 in-memory\uc5d0 \uc800\uc7a5\ud558\uc9c0 \uc54a\uace0 \ubc14\ub85c \uc2a4\ud2b8\ub9bc\uc73c\ub85c \uc77d\uc5b4\uc11c \ucc98\ub9ac\ud560\uac70\ub77c\uba74 busboy\ub97c \uc0ac\uc6a9\ud558\ub294 \uac83\uc774 \uc88b\ub2e4.","source":"@site/docs/nestjs/nest file upload stream - busboy.md","sourceDirName":"nestjs","slug":"/nestjs/nest file upload stream - busboy","permalink":"/docs/nestjs/nest file upload stream - busboy","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest file busboy s3 upload","permalink":"/docs/nestjs/nest file upload stream - busboy + s3"},"next":{"title":"nest file upload","permalink":"/docs/nestjs/nest file upload"}}');var t=r(447259),o=r(529087);const l={},i="nest file busboy",a={},c=[{value:"install",id:"install",level:2},{value:"main.ts",id:"maints",level:2},{value:"controller",id:"controller",level:2},{value:"angular",id:"angular",level:2}];function d(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"nest-file-busboy",children:"nest file busboy"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"\ud30c\uc77c\uc744 in-memory\uc5d0 \uc800\uc7a5\ud558\uc9c0 \uc54a\uace0 \ubc14\ub85c \uc2a4\ud2b8\ub9bc\uc73c\ub85c \uc77d\uc5b4\uc11c \ucc98\ub9ac\ud560\uac70\ub77c\uba74 busboy\ub97c \uc0ac\uc6a9\ud558\ub294 \uac83\uc774 \uc88b\ub2e4."}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"\ud30c\uc77c\uc744 \uc5c5\ub85c\ub4dc\ud558\uba74 nestjs\ub97c \uac70\uccd0\uc11c \uc2a4\ud1a0\ub9ac\uc9c0(S3)\ub85c \ubc14\ub85c \uc804\uc1a1\ud558\ub294 \uacbd\uc6b0"}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"multer\ub3c4 \ub0b4\ubd80\uc801\uc73c\ub85c busboy\ub97c \uc0ac\uc6a9\ud55c\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"install",children:"install"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"npm i connect-busboy\r\nnpm i -D @types/connect-busboy\n"})}),"\n",(0,t.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:'import busboy from "connect-busboy";\r\n\r\napp.use(busboy());\n'})}),"\n",(0,t.jsx)(n.h2,{id:"controller",children:"controller"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:'import { Request } from "express";\r\nimport fs, { createWriteStream } from "fs";\r\n\r\nuploadByStream(dir: string, req: Request) {\r\n  return new Promise<string>((resolve, reject) => {\r\n    req.pipe(req.busboy);\r\n\r\n    req.busboy.on("file", (name, file, info) => {\r\n\r\n      const { filename } = info;\r\n      const encodedName = Buffer.from(filename, "latin1").toString("utf8");\r\n      const path = `${dir}/${dayjs().month() + 1}/${dayjs().date()}`;\r\n      const finalDir = `${this.options.dir}/${path}`;\r\n      if (!fs.existsSync(finalDir)) {\r\n        fs.mkdirSync(finalDir, { recursive: true });\r\n      }\r\n      const key = `${path}/${encodedName}`;\r\n      const ws = createWriteStream(`${this.options.dir}/${key}`);\r\n\r\n      ws.on("close", () => {\r\n        console.log("Write Stream Closed");\r\n      });\r\n\r\n      ws.on("finish", () => {\r\n        console.log("Write Stream Finished");\r\n      });\r\n\r\n      file.on("data", (data) => {\r\n        ws.write(data);\r\n      });\r\n\r\n      file.on("end", () => {\r\n        console.log("busboy ended");\r\n        ws.end();\r\n        ws.close();\r\n        resolve(key);\r\n      });\r\n\r\n      file.on("error", (err) => {\r\n        console.error("busboy error : ", err);\r\n        reject(err);\r\n      });\r\n    });\r\n  });\r\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"angular",children:"angular"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:'const formData = new FormData();\r\nformData.append("file", file);\r\n\r\nhttp.post("http://localhost:3000/file", formData).subscribe();\n'})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);