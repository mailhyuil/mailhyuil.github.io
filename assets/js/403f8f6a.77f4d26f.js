"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["737094"],{103093:function(e,r,n){n.r(r),n.d(r,{frontMatter:()=>a,toc:()=>c,default:()=>m,metadata:()=>s,assets:()=>l,contentTitle:()=>o});var s=JSON.parse('{"id":"aws/aws-sdk SES","title":"aws-sdk SES (simple email service)","description":"install","source":"@site/docs/aws/aws-sdk SES.md","sourceDirName":"aws","slug":"/aws/aws-sdk SES","permalink":"/docs/aws/aws-sdk SES","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"aws-sdk s3","permalink":"/docs/aws/aws-sdk S3"},"next":{"title":"aws-sdk sns","permalink":"/docs/aws/aws-sdk SNS"}}'),t=n(447259),i=n(255511);let a={},o="aws-sdk SES (simple email service)",l={},c=[{value:"install",id:"install",level:2},{value:"aws-ses.module.ts",id:"aws-sesmodulets",level:2},{value:"aws-ses.service.ts",id:"aws-sesservicets",level:2},{value:"email.template.tsx",id:"emailtemplatetsx",level:2}];function d(e){let r={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"aws-sdk-ses-simple-email-service",children:"aws-sdk SES (simple email service)"})}),"\n",(0,t.jsx)(r.h2,{id:"install",children:"install"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-sh",children:"npm i @aws-sdk/client-sns\r\n\r\nnpm i -D @types/react\r\nnpm i react-email\r\nnpm i @react-email/components\n"})}),"\n",(0,t.jsx)(r.h2,{id:"aws-sesmodulets",children:"aws-ses.module.ts"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:'import { Module } from "@nestjs/common";\r\nimport { JwtModule } from "@nestjs/jwt";\r\nimport { AwsSesService } from "./aws-ses.service";\r\n\r\n@Module({\r\n  imports: [\r\n    JwtModule.register({\r\n      secret: process.env["JWT_ACCESS_TOKEN_SECRET"],\r\n      signOptions: { expiresIn: "1d" },\r\n    }),\r\n  ],\r\n  controllers: [],\r\n  providers: [AwsSesService],\r\n  exports: [AwsSesService],\r\n})\r\nexport class AwsSesModule {}\n'})}),"\n",(0,t.jsx)(r.h2,{id:"aws-sesservicets",children:"aws-ses.service.ts"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:'import { PrismaService } from "@/server/prisma/prisma.service";\r\nimport { SendEmailCommand, SESClient, VerifyEmailIdentityCommand } from "@aws-sdk/client-ses";\r\nimport { Injectable, InternalServerErrorException, Logger, UnauthorizedException } from "@nestjs/common";\r\nimport { JwtService } from "@nestjs/jwt";\r\nimport { render } from "@react-email/render";\r\nimport { VerifyEmail } from "./email.template";\r\n\r\nconst region = process.env["AWS_REGION"];\r\nconst accessKeyId = process.env["AWS_ACCESS_KEY"];\r\nconst secretAccessKey = process.env["AWS_SECRET_ACCESS_KEY"];\r\nconst clientUrl = process.env["CLIENT_URL"];\r\n@Injectable()\r\nexport class AwsSesService {\r\n  logger = new Logger(AwsSesService.name);\r\n  ses: SESClient;\r\n  constructor(private readonly jwtService: JwtService, private readonly prisma: PrismaService) {\r\n    if (!region) {\r\n      throw new Error("AWS Region is not provided");\r\n    }\r\n    this.ses = new SESClient({\r\n      region,\r\n      credentials: {\r\n        accessKeyId,\r\n        secretAccessKey,\r\n      },\r\n    });\r\n  }\r\n\r\n  async send({ emails, sender, title, html }: { emails: string[]; sender: string; title: string; html: string }) {\r\n    const command = new SendEmailCommand({\r\n      Source: sender,\r\n      Destination: {\r\n        ToAddresses: emails,\r\n      },\r\n      Message: {\r\n        Subject: {\r\n          Data: title,\r\n        },\r\n        Body: {\r\n          Html: {\r\n            Data: html,\r\n          },\r\n        },\r\n      },\r\n    });\r\n    await this.ses.send(command).catch(error => {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException("Failed to send email");\r\n    });\r\n  }\r\n\r\n  async sendToken(email: string, id: string) {\r\n    const token = this.jwtService.sign({ id, email });\r\n\r\n    const url = `${clientUrl}/verify-email?token=${token}`;\r\n\r\n    const command = new SendEmailCommand({\r\n      Source: "contact@dep.team",\r\n      Destination: {\r\n        ToAddresses: [email],\r\n      },\r\n      Message: {\r\n        Subject: {\r\n          Data: "\uCF54\uC778\uB9AC\uD380 \uC774\uBA54\uC77C \uC778\uC99D",\r\n        },\r\n        Body: {\r\n          Html: {\r\n            Data: await render(VerifyEmail({ url })),\r\n          },\r\n        },\r\n      },\r\n    });\r\n    await this.ses.send(command).catch(error => {\r\n      this.logger.error(error);\r\n      throw new InternalServerErrorException("Failed to send email");\r\n    });\r\n  }\r\n\r\n  async verifyToken(token: string) {\r\n    try {\r\n      const { id, email } = this.jwtService.verify(token);\r\n      console.log(id, email);\r\n      const found = await this.prisma.user.update({\r\n        where: { id, email },\r\n        data: { status: "ACTIVE" },\r\n      });\r\n      if (!found) {\r\n        throw new UnauthorizedException("Failed to verify email");\r\n      }\r\n    } catch (error) {\r\n      this.logger.error(error);\r\n      throw new UnauthorizedException("Failed to verify email");\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,t.jsx)(r.h2,{id:"emailtemplatetsx",children:"email.template.tsx"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",children:'import {\r\n  Body,\r\n  Container,\r\n  Head,\r\n  Heading,\r\n  Hr,\r\n  Html,\r\n  Link,\r\n  Preview,\r\n  Section,\r\n  Tailwind,\r\n  Text,\r\n} from "@react-email/components";\r\nimport * as React from "react";\r\n\r\nexport const VerifyEmail = ({ url }: { url: string }): React.ReactElement => {\r\n  return (\r\n    <Html lang="ko">\r\n      <Head />\r\n      <Preview>\uCF54\uC778\uB9AC\uD380 \uC774\uBA54\uC77C \uC778\uC99D \uC548\uB0B4</Preview>\r\n      <Tailwind>\r\n        <Body className="mx-auto my-auto font-sans bg-white text-neutral-900">\r\n          <Container>\r\n            <Hr />\r\n            <Heading>\uCF54\uC778\uB9AC\uD380 \uC774\uBA54\uC77C \uC778\uC99D \uC548\uB0B4</Heading>\r\n            <Text>\uC548\uB155\uD558\uC138\uC694. \uCF54\uC778\uB9AC\uD380\uC785\uB2C8\uB2E4.</Text>\r\n            <Text>\uC774\uBA54\uC77C \uC778\uC99D\uC744 \uC704\uD574 \uC544\uB798 \uB9C1\uD06C\uB97C \uD074\uB9AD\uD574\uC8FC\uC138\uC694</Text>\r\n            <Hr />\r\n            <Section className="flex justify-center p-5 bg-neutral-100">\r\n              <Link className="text-xl font-extrabold text-center underline" href={url}>\r\n                \uC778\uC99D\uD558\uAE30\r\n              </Link>\r\n            </Section>\r\n          </Container>\r\n        </Body>\r\n      </Tailwind>\r\n    </Html>\r\n  );\r\n};\n'})})]})}function m(e={}){let{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},255511:function(e,r,n){n.d(r,{R:()=>a,x:()=>o});var s=n(596363);let t={},i=s.createContext(t);function a(e){let r=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);