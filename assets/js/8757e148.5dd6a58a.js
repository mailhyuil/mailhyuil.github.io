"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["266791"],{69184:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>a,toc:()=>d,default:()=>m,metadata:()=>t,assets:()=>c,contentTitle:()=>o});var t=JSON.parse('{"id":"db-prisma/prisma lock \uB099\uAD00\uC801 \uB77D testing","title":"prisma optimistic lock (\uB099\uAD00\uC801 \uB77D) testing","description":"\uC77C\uBC18 \uCFFC\uB9AC\uC640 \uD2B8\uB79C\uC7AD\uC158 \uCFFC\uB9AC\uC758 \uC18D\uB3C4 \uCC28\uC774 \uD655\uC778","source":"@site/docs/db-prisma/prisma lock \uB099\uAD00\uC801 \uB77D testing.md","sourceDirName":"db-prisma","slug":"/db-prisma/prisma lock \uB099\uAD00\uC801 \uB77D testing","permalink":"/docs/db-prisma/prisma lock \uB099\uAD00\uC801 \uB77D testing","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"prisma lambda binary target","permalink":"/docs/db-prisma/prisma lambda binary target"},"next":{"title":"prisma optimistic lock (\uB099\uAD00\uC801 \uB77D)","permalink":"/docs/db-prisma/prisma lock \uB099\uAD00\uC801 \uB77D"}}'),i=r(447259),s=r(255511);let a={},o="prisma optimistic lock (\uB099\uAD00\uC801 \uB77D) testing",c={},d=[{value:"schema.prisma",id:"schemaprisma",level:2},{value:"code",id:"code",level:2}];function l(e){let n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"prisma-optimistic-lock-\uB099\uAD00\uC801-\uB77D-testing",children:"prisma optimistic lock (\uB099\uAD00\uC801 \uB77D) testing"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"\uC77C\uBC18 \uCFFC\uB9AC\uC640 \uD2B8\uB79C\uC7AD\uC158 \uCFFC\uB9AC\uC758 \uC18D\uB3C4 \uCC28\uC774 \uD655\uC778"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"user \uC0DD\uC131 \uC2DC group\uC758 userCount\uB97C \uC99D\uAC00\uC2DC\uD0A4\uB294\uB370 \uC774\uB54C \uD2B8\uB79C\uC7AD\uC158\uC774 \uC0AC\uC6A9\uB418\uBA74 group\uC5D0 \uB300\uD55C \uB77D\uC774 \uAC78\uB9AC\uAE30 \uB54C\uBB38\uC5D0 \uC18D\uB3C4\uAC00 \uB290\uB824\uC9C8 \uAC83\uC774\uB2E4."}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"\uC77C\uBC18 \uCFFC\uB9AC\uB85C 20s \uAC78\uB9AC\uB358 \uC791\uC5C5\uC774 \uD2B8\uB79C\uC7AD\uC158\uC73C\uB85C 10\uBD84 \uC774\uC0C1 \uAC78\uB9BC"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"transaction\uC5D0 relation\uC774 \uC788\uB294 \uACBD\uC6B0 relation\uC5D0 \uB300\uD55C Row Lock\uC774 \uAC78\uB9AC\uAE30 \uB54C\uBB38\uC5D0 \uC18D\uB3C4\uAC00 \uB290\uB824\uC9D0"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"schemaprisma",children:"schema.prisma"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-prisma",children:'model User {\r\n  id String @id @default(uuid())\r\n  username String @unique\r\n  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)\r\n  groupId Int\r\n  @@map(name: "users")\r\n}\r\n\r\nmodel Group {\r\n  id Int @id @default(autoincrement())\r\n  name String @unique\r\n  userCount Int @default(0) @map(name: "user_count")\r\n  user User[]\r\n  @@map(name: "groups")\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"code",children:"code"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"  async create(data: CreateUserDto) {\r\n    const time = new Date().getTime() + '::::::: CREATE :::::::'\r\n    // \uC77C\uBC18 \uCFFC\uB9AC\r\n    // console.time(time);\r\n    // for (let i = 0; i < 20000; i++) {\r\n    //   // CREATE 8s \uAC78\uB9BC\r\n    //   await this.prisma.user.create({\r\n    //     data: {\r\n    //       username: data.username + i,\r\n    //       groupId: 1,\r\n    //     },\r\n    //   });\r\n    //   await this.prisma.group.update({\r\n    //     where: {\r\n    //       id: 1,\r\n    //     },\r\n    //     data: {\r\n    //       userCount: {\r\n    //         increment: 1,\r\n    //       },\r\n    //     },\r\n    //   });\r\n    // }\r\n    // console.timeEnd(time);\r\n\r\n    // \uD2B8\uB79C\uC7AD\uC158 \uCFFC\uB9AC\r\n    console.time(time);\r\n    await this.prisma.$transaction(\r\n      // CREATE: 12s \uAC78\uB9BC\r\n      async (tx) => {\r\n        for (let i = 0; i < 20000; i++) {\r\n          await tx.user.create({\r\n            data: {\r\n              id: i + data.username,\r\n              username: data.username + i,\r\n              groupId: 1,\r\n            },\r\n          });\r\n          await tx.group.update({\r\n            where: {\r\n              id: 1,\r\n            },\r\n            data: {\r\n              userCount: {\r\n                increment: 1,\r\n              },\r\n            },\r\n          });\r\n        }\r\n      },\r\n      {\r\n        timeout: 1000000,\r\n      }\r\n    );\r\n    console.timeEnd(time);\r\n  }\n"})})]})}function m(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},255511:function(e,n,r){r.d(n,{R:()=>a,x:()=>o});var t=r(596363);let i={},s=t.createContext(i);function a(e){let n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);