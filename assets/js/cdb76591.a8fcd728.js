"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["162075"],{714746:function(e,r,n){n.r(r),n.d(r,{frontMatter:()=>a,toc:()=>u,default:()=>b,metadata:()=>s,assets:()=>o,contentTitle:()=>t});var s=JSON.parse('{"id":"db-postgres/postgres backup scripts","title":"db backup scripts","description":"pgdumpbackup.sh","source":"@site/docs/db-postgres/postgres backup scripts.md","sourceDirName":"db-postgres","slug":"/db-postgres/postgres backup scripts","permalink":"/docs/db-postgres/postgres backup scripts","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"postgres recovery psql vs pg_restore","permalink":"/docs/db-postgres/postgres backup psql vs pg_restore"},"next":{"title":"postgres backup \uC885\uB958","permalink":"/docs/db-postgres/postgres backup \uC885\uB958"}}'),c=n(447259),p=n(255511);let a={},t="db backup scripts",o={},u=[{value:"pg_dump_backup.sh",id:"pg_dump_backupsh",level:2},{value:"pg_basebackup.sh",id:"pg_basebackupsh",level:2},{value:"cron",id:"cron",level:2}];function d(e){let r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,p.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(r.header,{children:(0,c.jsx)(r.h1,{id:"db-backup-scripts",children:"db backup scripts"})}),"\n",(0,c.jsx)(r.h2,{id:"pg_dump_backupsh",children:"pg_dump_backup.sh"}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\n\r\nUSERNAME=postgres\r\nDB_NAME=onepartners\r\nPASSWORD=cloud365$\r\nCONTAINER_NAME=postgres\r\nBUCKET_NAME=onepartners-db\r\nBACKUP_DIR=/home/ubuntu/pg-backup\r\nFILENAME="${DB_NAME}_$(date +\'%Y-%m-%d_%H%M\').dump"\r\n\r\ncd $BACKUP_DIR\r\n\r\necho "[pg_dump] $(date) - DB \uBC31\uC5C5 \uC2DC\uC791"\r\nPGPASSWORD=$PASSWORD sudo docker exec $CONTAINER_NAME pg_dump -U $USERNAME $DB_NAME -Fc -v > "$FILENAME"\r\necho "[pg_dump] \uBC31\uC5C5 \uC644\uB8CC: $FILENAME"\r\n\r\naws s3 cp "$FILENAME" s3://${BUCKET_NAME}/backup/$FILENAME\r\n\r\n# \u2705 \uC5C5\uB85C\uB4DC \uD6C4 \uC989\uC2DC \uC0AD\uC81C\r\nrm -f "$FILENAME"\r\necho "[pg_dump] $(date) - S3 \uC5C5\uB85C\uB4DC \uD6C4 \uB85C\uCEEC \uBC31\uC5C5 \uC0AD\uC81C \uC644\uB8CC"\n'})}),"\n",(0,c.jsx)(r.h2,{id:"pg_basebackupsh",children:"pg_basebackup.sh"}),"\n",(0,c.jsxs)(r.blockquote,{children:["\n",(0,c.jsx)(r.p,{children:"basebackup \uD6C4 archive \uBCF5\uC0AC \uBC0F \uC0AD\uC81C"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\n\r\nset -e\r\n\r\nCONTAINER_NAME=postgres\r\nBUCKET_NAME=onepartners-db\r\n\r\n# \uD638\uC2A4\uD2B8 \uAE30\uC900 \uACBD\uB85C (docker-compose\uC5D0\uC11C \uB9C8\uC6B4\uD2B8\uB418\uC5B4 \uC788\uC5B4\uC57C \uD568)\r\nBASEBACKUP_DIR=/home/ubuntu/pg-basebackup\r\nARCHIVE_DIR=/home/ubuntu/pg-archive\r\nDATE_TAG=$(date +"%Y%m%d_%H%M%S")\r\n\r\necho "[INFO] \uC2DC\uC791: $DATE_TAG"\r\n# 1. \uCEE8\uD14C\uC774\uB108 \uB0B4\uBD80\uC5D0\uC11C basebackup \uC2E4\uD589 + \uC18C\uC720\uAD8C \uC218\uC815\r\ndocker exec $CONTAINER_NAME bash -c "\r\n  set -e\r\n  export PGPASSWORD=\'cloud365$\'\r\n  mkdir -p /var/lib/postgresql/basebackup_dir/$DATE_TAG\r\n  pg_basebackup \\\r\n    -h localhost \\\r\n    -U postgres \\\r\n    -D /var/lib/postgresql/basebackup_dir/$DATE_TAG \\\r\n    -Ft -z -X fetch -P\r\n"\r\n\r\n# 2. \uD638\uC2A4\uD2B8\uC5D0\uC11C base.tar.gz \uC5C5\uB85C\uB4DC + \uC0AD\uC81C\r\nBASE_TAR="${BASEBACKUP_DIR}/${DATE_TAG}/base.tar.gz"\r\nif [ -f "$BASE_TAR" ]; then\r\n  echo "[INFO] base.tar.gz \uBC1C\uACAC \u2192 S3 \uC5C5\uB85C\uB4DC \uC911"\r\n  aws s3 cp "$BASE_TAR" "s3://${BUCKET_NAME}/basebackup/base_${DATE_TAG}.tar.gz"\r\n  rm -rf "${BASEBACKUP_DIR:?}/${DATE_TAG}"\r\n  echo "[OK] basebackup \uC5C5\uB85C\uB4DC \uBC0F \uC0AD\uC81C \uC644\uB8CC"\r\nelse\r\n  echo "\u274C base.tar.gz \uD30C\uC77C\uC774 \uC5C6\uC74C: $BASE_TAR"\r\nfi\r\n\r\n# 3. archive \uB514\uB809\uD1A0\uB9AC\uC5D0\uC11C \uCD5C\uC2E0 .backup \uC774\uD6C4 WAL\uB9CC \uC5C5\uB85C\uB4DC + \uC0AD\uC81C\r\ncd "$ARCHIVE_DIR" || exit 1\r\n\r\nLATEST_BACKUP=$(ls -1t *.backup 2>/dev/null | head -n1)\r\nif [ -z "$LATEST_BACKUP" ]; then\r\n  echo "\u274C .backup \uD30C\uC77C \uC5C6\uC74C \u2192 archive \uCC98\uB9AC \uC0DD\uB7B5"\r\n  exit 0\r\nfi\r\n\r\nLATEST_BASE=$(basename "$LATEST_BACKUP" | cut -d. -f1)\r\necho "[INFO] \uCD5C\uC2E0 .backup \uAE30\uC900: $LATEST_BASE (.backup: $LATEST_BACKUP)"\r\n\r\nfor FILE in $(ls -1 | grep -E \'^[0-9A-F]{24}(\\.backup)?\'); do\r\n  if [[ "$FILE" > "$LATEST_BASE" || "$FILE" == "$LATEST_BACKUP" ]]; then\r\n    aws s3 cp "$FILE" "s3://${BUCKET_NAME}/archive/$FILE"\r\n    rm -f "$FILE"\r\n    echo "\u2705 $FILE \uC5C5\uB85C\uB4DC \uBC0F \uC0AD\uC81C \uC644\uB8CC"\r\n  fi\r\ndone\r\n\r\necho "[DONE] basebackup + archive \uCC98\uB9AC \uC644\uB8CC: $(date)"\n'})}),"\n",(0,c.jsx)(r.h2,{id:"cron",children:"cron"}),"\n",(0,c.jsxs)(r.blockquote,{children:["\n",(0,c.jsx)(r.p,{children:"sudo crontab -e"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-sh",children:"# \uB9E4\uC77C 03:00\uC5D0 pg_dump_backup.sh \uC2E4\uD589\r\n0 3 * * * sudo /home/ubuntu/scripts/pg_dump_backup.sh\r\n# \uB9E4\uC8FC \uC6D4,\uBAA9 03:00\uC5D0 pg_basebackup.sh \uC2E4\uD589\r\n0 3 * * 1,4 sudo /home/ubuntu/scripts/pg_basebackup.sh\n"})})]})}function b(e={}){let{wrapper:r}={...(0,p.R)(),...e.components};return r?(0,c.jsx)(r,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},255511:function(e,r,n){n.d(r,{R:()=>a,x:()=>t});var s=n(596363);let c={},p=s.createContext(c);function a(e){let r=s.useContext(p);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function t(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:a(e.components),s.createElement(p.Provider,{value:r},e.children)}}}]);