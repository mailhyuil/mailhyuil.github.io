"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[263685],{529087:(e,r,c)=>{c.d(r,{R:()=>t,x:()=>a});var s=c(596363);const n={},o=s.createContext(n);function t(e){const r=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:t(e.components),s.createElement(o.Provider,{value:r},e.children)}},670590:(e,r,c)=>{c.r(r),c.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>t,metadata:()=>s,toc:()=>i});const s=JSON.parse('{"id":"docker/docker-compose deploy replicas auto scale","title":"docker-compose cluster auto scaling","description":"scale.sh","source":"@site/docs/docker/docker-compose deploy replicas auto scale.md","sourceDirName":"docker","slug":"/docker/docker-compose deploy replicas auto scale","permalink":"/docs/docker/docker-compose deploy replicas auto scale","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"docker-compose cluster","permalink":"/docs/docker/docker-compose deploy replicas - cluster"},"next":{"title":"docker-compose logs","permalink":"/docs/docker/docker-compose logs"}}');var n=c(447259),o=c(529087);const t={},a="docker-compose cluster auto scaling",l={},i=[{value:"scale.sh",id:"scalesh",level:2},{value:"cron job",id:"cron-job",level:2}];function p(e){const r={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"docker-compose-cluster-auto-scaling",children:"docker-compose cluster auto scaling"})}),"\n",(0,n.jsx)(r.h2,{id:"scalesh",children:"scale.sh"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\n\r\n# \uc124\uc815\r\nCOMPOSE_SERVICE_NAME="app"\r\nCOMPOSE_PROJECT_NAME="myproject"  # docker-compose\uac00 \uc2e4\ud589\ub41c \ub514\ub809\ud1a0\ub9ac \uc774\ub984\r\nSCALE_UP_THRESHOLD=80             # CPU % \ucd08\uacfc \uc2dc \uc2a4\ucf00\uc77c \uc5c5\r\nSCALE_DOWN_THRESHOLD=20           # CPU % \ubbf8\ub9cc \uc2dc \uc2a4\ucf00\uc77c \ub2e4\uc6b4\r\nMIN_REPLICAS=1                    # \ucd5c\uc18c \ucee8\ud14c\uc774\ub108 \uac1c\uc218\r\nMAX_REPLICAS=5                    # \ucd5c\ub300 \ucee8\ud14c\uc774\ub108 \uac1c\uc218\r\n\r\n# \ud604\uc7ac \ucee8\ud14c\uc774\ub108 \uac1c\uc218 \ud655\uc778\r\ncurrent_replicas=$(docker ps --filter "name=${COMPOSE_PROJECT_NAME}_${COMPOSE_SERVICE_NAME}_" --format \'{{.Names}}\' | wc -l)\r\n\r\n# \ud604\uc7ac \ucee8\ud14c\uc774\ub108\ub4e4\uc758 \ud3c9\uade0 CPU \uc0ac\uc6a9\ub7c9 \uacc4\uc0b0\r\ncpu_usage=$(docker stats --no-stream --format "{{.CPUPerc}}" $(docker ps --filter "name=${COMPOSE_PROJECT_NAME}_${COMPOSE_SERVICE_NAME}_" --format \'{{.Names}}\') | sed \'s/%//\' | awk \'{sum+=$1} END {if (NR>0) print int(sum/NR); else print 0}\')\r\n\r\necho "$(date): Current replicas=${current_replicas}, CPU usage=${cpu_usage}%"\r\n\r\n# \uc2a4\ucf00\uc77c \uc5c5 \uc870\uac74\r\nif [ "$cpu_usage" -gt "$SCALE_UP_THRESHOLD" ] && [ "$current_replicas" -lt "$MAX_REPLICAS" ]; then\r\n  new_replicas=$((current_replicas + 1))\r\n  echo "$(date): Scaling UP to ${new_replicas} replicas"\r\n  docker compose up -d --scale ${COMPOSE_SERVICE_NAME}=${new_replicas}\r\nfi\r\n\r\n# \uc2a4\ucf00\uc77c \ub2e4\uc6b4 \uc870\uac74\r\nif [ "$cpu_usage" -lt "$SCALE_DOWN_THRESHOLD" ] && [ "$current_replicas" -gt "$MIN_REPLICAS" ]; then\r\n  new_replicas=$((current_replicas - 1))\r\n  echo "$(date): Scaling DOWN to ${new_replicas} replicas"\r\n  docker compose up -d --scale ${COMPOSE_SERVICE_NAME}=${new_replicas}\r\nfi\n'})}),"\n",(0,n.jsx)(r.h2,{id:"cron-job",children:"cron job"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sh",children:"crontab -e\r\n\r\n# Run the scale.sh script every 5 minutes\r\n*/5 * * * * /path/to/scale.sh\n"})})]})}function d(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(p,{...e})}):p(e)}}}]);