"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[697588],{529087:(n,r,e)=>{e.d(r,{R:()=>l,x:()=>i});var o=e(596363);const t={},s=o.createContext(t);function l(n){const r=o.useContext(s);return o.useMemo(function(){return"function"==typeof n?n(r):{...r,...n}},[r,n])}function i(n){let r;return r=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:l(n.components),o.createElement(s.Provider,{value:r},n.children)}},743695:(n,r,e)=>{e.r(r),e.d(r,{assets:()=>c,contentTitle:()=>i,default:()=>g,frontMatter:()=>l,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"nestjs/nest polling & long polling","title":"nest polling & long polling","description":"functions","source":"@site/docs/nestjs/nest polling & long polling.md","sourceDirName":"nestjs","slug":"/nestjs/nest polling & long polling","permalink":"/docs/nestjs/nest polling & long polling","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest platform","permalink":"/docs/nestjs/nest platform"},"next":{"title":"nest prisma Generic Service","permalink":"/docs/nestjs/nest prisma Generic CrudService"}}');var t=e(447259),s=e(529087);const l={},i="nest polling & long polling",c={},a=[{value:"functions",id:"functions",level:2},{value:"controller",id:"controller",level:2}];function p(n){const r={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,s.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"nest-polling--long-polling",children:"nest polling & long polling"})}),"\n",(0,t.jsx)(r.h2,{id:"functions",children:"functions"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:'const jobs = new Map<string, number>();\r\n\r\nfunction generateJobId() {\r\n  const jobId = `jobs:${Math.random().toString(36).substring(7)}`;\r\n  return jobId;\r\n}\r\n\r\nfunction doJob(jobId: string) {\r\n  let progress = 0;\r\n  const interval = setInterval(() => {\r\n    progress += 10;\r\n    jobs.set(jobId, progress);\r\n    if (progress >= 100) {\r\n      clearInterval(interval);\r\n    }\r\n  }, 1000);\r\n}\r\n\r\nasync function checkIfJobIsDone(jobId: string) {\r\n  return new Promise((resolve, reject) => {\r\n    const interval = setInterval(() => {\r\n      const progress = jobs.get(jobId);\r\n      if (!progress) {\r\n        clearInterval(interval);\r\n        reject(new NotFoundException("Job not found"));\r\n      }\r\n      if (progress >= 100) {\r\n        clearInterval(interval);\r\n        resolve(true);\r\n      }\r\n    }, 1000);\r\n  });\r\n}\n'})}),"\n",(0,t.jsx)(r.h2,{id:"controller",children:"controller"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:'import { Controller, Get, NotFoundException, Post, Query, Res } from "@nestjs/common";\r\nimport { ApiTags } from "@nestjs/swagger";\r\nimport { Response } from "express";\r\n\r\n@ApiTags("Test")\r\n@Controller({ path: "tests", version: "1" })\r\nexport class TestController {\r\n  @Get("polling")\r\n  async polling(@Query("jobId") jobId: string) {\r\n    const progress = jobs.get(jobId);\r\n    if (!progress) {\r\n      throw new NotFoundException("Job not found");\r\n    }\r\n    return { progress };\r\n  }\r\n\r\n  @Get("long-polling")\r\n  async longPolling(@Query("jobId") jobId: string, @Res() res: Response) {\r\n    await checkIfJobIsDone(jobId);\r\n    const progress = jobs.get(jobId);\r\n    res.end(JSON.stringify({ progress }));\r\n  }\r\n\r\n  @Post()\r\n  async submit() {\r\n    const jobId = generateJobId();\r\n    doJob(jobId);\r\n    return { jobId };\r\n  }\r\n}\n'})})]})}function g(n={}){const{wrapper:r}={...(0,s.R)(),...n.components};return r?(0,t.jsx)(r,{...n,children:(0,t.jsx)(p,{...n})}):p(n)}}}]);