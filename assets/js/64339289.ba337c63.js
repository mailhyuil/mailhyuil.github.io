"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[29607],{522771:(r,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>n,toc:()=>p});const n=JSON.parse('{"id":"nestjs/nest base decorator toss nestjs-aop example","title":"nest decorator toss nestjs-aop example","description":"","source":"@site/docs/nestjs/nest base decorator toss nestjs-aop example.md","sourceDirName":"nestjs","slug":"/nestjs/nest base decorator toss nestjs-aop example","permalink":"/docs/nestjs/nest base decorator toss nestjs-aop example","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"GetUser decorator","permalink":"/docs/nestjs/nest base decorator createParamDecorator"},"next":{"title":"nest decorator toss AOP","permalink":"/docs/nestjs/nest base decorator toss nestjs-aop"}}');var s=t(447259),o=t(529087);const a={},i="nest decorator toss nestjs-aop example",c={},p=[];function d(r){const e={code:"code",h1:"h1",header:"header",pre:"pre",...(0,o.R)(),...r.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"nest-decorator-toss-nestjs-aop-example",children:"nest decorator toss nestjs-aop example"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:'import { Inject } from "@nestjs/common";\r\nimport { RedisClientType } from "@redis/client";\r\nimport { Aspect, LazyDecorator, WrapParams, createDecorator } from "@toss/nestjs-aop";\r\nimport { MAX_POINT_ID } from "../app/max-point/max-point.service";\r\nimport { PrismaService } from "../prisma/prisma.service";\r\nimport { REDIS_CLIENT } from "../redis/redis.provider";\r\n\r\nexport const ADD_POINT = Symbol("ADD_POINT");\r\n\r\nconst createPointId = (userId: number) => `point:${userId}`;\r\n\r\n@Aspect(ADD_POINT)\r\nexport class AddPointDecorator implements LazyDecorator<any, number> {\r\n  constructor(private readonly prisma: PrismaService, @Inject(REDIS_CLIENT) private readonly redis: RedisClientType) {}\r\n  wrap(params: WrapParams<any, number>) {\r\n    const point = params.metadata;\r\n    return async (...args: any) => {\r\n      const res = await params.method(...args);\r\n      // add point\r\n      setTimeout(async () => {\r\n        const totalPoint = await this.redis.get(createPointId(res.userId));\r\n        const maxPoint = await this.redis.get(MAX_POINT_ID);\r\n        if (!maxPoint) {\r\n          throw new Error("Max Point is not set");\r\n        }\r\n\r\n        if (!totalPoint) {\r\n          await this.prisma.user.update({\r\n            where: {\r\n              id: res.userId,\r\n            },\r\n            data: {\r\n              point: {\r\n                increment: point,\r\n              },\r\n            },\r\n          });\r\n          await this.redis.set(createPointId(res.userId), point);\r\n          return;\r\n        }\r\n\r\n        if (+totalPoint <= +maxPoint) {\r\n          await this.prisma.user.update({\r\n            where: {\r\n              id: res.userId,\r\n            },\r\n            data: {\r\n              point: {\r\n                increment: point,\r\n              },\r\n            },\r\n          });\r\n          await this.redis.incrBy(createPointId(res.userId), point);\r\n          return;\r\n        }\r\n      });\r\n      return res;\r\n    };\r\n  }\r\n}\r\n\r\nexport const AddPoint = (point: number) => createDecorator(ADD_POINT, point);\n'})})]})}function m(r={}){const{wrapper:e}={...(0,o.R)(),...r.components};return e?(0,s.jsx)(e,{...r,children:(0,s.jsx)(d,{...r})}):d(r)}},529087:(r,e,t)=>{t.d(e,{R:()=>a,x:()=>i});var n=t(596363);const s={},o=n.createContext(s);function a(r){const e=n.useContext(o);return n.useMemo(function(){return"function"==typeof r?r(e):{...e,...r}},[e,r])}function i(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(s):r.components||s:a(r.components),n.createElement(o.Provider,{value:e},r.children)}}}]);