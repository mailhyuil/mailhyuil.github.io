"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[979288],{250221:(r,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>t,toc:()=>m});const t=JSON.parse('{"id":"db-prisma/prisma query stream","title":"prisma stream","description":"custom stream","source":"@site/docs/db-prisma/prisma query stream.md","sourceDirName":"db-prisma","slug":"/db-prisma/prisma query stream","permalink":"/docs/db-prisma/prisma query stream","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"prisma-cursorstream","permalink":"/docs/db-prisma/prisma query stream prisma-cursorstream"},"next":{"title":"prisma raw query","permalink":"/docs/db-prisma/prisma raw query"}}');var n=s(447259),a=s(529087);const i={},o="prisma stream",c={},m=[{value:"custom stream",id:"custom-stream",level:2},{value:"usage",id:"usage",level:2}];function u(r){const e={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,a.R)(),...r.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.header,{children:(0,n.jsx)(e.h1,{id:"prisma-stream",children:"prisma stream"})}),"\n",(0,n.jsx)(e.h2,{id:"custom-stream",children:"custom stream"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-ts",children:'import { Readable } from "stream";\r\nimport { PrismaClient } from "@prisma/client";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ninterface StreamReportsOptions {\r\n  batchSize: number;\r\n}\r\n\r\nexport function streamReports({ batchSize }: StreamReportsOptions): Readable {\r\n  let cursorId: number = undefined;\r\n  return new Readable({\r\n    objectMode: true,\r\n    highWaterMark: batchSize,\r\n    async read() {\r\n      try {\r\n        const items = await prisma.report.findMany({\r\n          take: batchSize,\r\n          skip: cursorId ? 1 : 0,\r\n          cursor: cursorId ? { id: cursorId } : undefined,\r\n          where: {\r\n            processed: false,\r\n          },\r\n        });\r\n        for (const item of items) {\r\n          this.push(item);\r\n        }\r\n        if (items.length < batchSize) {\r\n          this.push(null);\r\n          return;\r\n        }\r\n        cursorId = items[items.length - 1].id;\r\n      } catch (err) {\r\n        this.destroy(err);\r\n      }\r\n    },\r\n  });\r\n}\n'})}),"\n",(0,n.jsx)(e.h2,{id:"usage",children:"usage"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-ts",children:"for await (const user of streamUsers({ batchSize: 100 })) {\r\n  console.log(user);\r\n}\n"})})]})}function d(r={}){const{wrapper:e}={...(0,a.R)(),...r.components};return e?(0,n.jsx)(e,{...r,children:(0,n.jsx)(u,{...r})}):u(r)}},529087:(r,e,s)=>{s.d(e,{R:()=>i,x:()=>o});var t=s(596363);const n={},a=t.createContext(n);function i(r){const e=t.useContext(a);return t.useMemo(function(){return"function"==typeof r?r(e):{...e,...r}},[e,r])}function o(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(n):r.components||n:i(r.components),t.createElement(a.Provider,{value:e},r.children)}}}]);