"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["996446"],{386759:function(r,n,e){e.r(n),e.d(n,{frontMatter:()=>c,toc:()=>a,default:()=>f,metadata:()=>o,assets:()=>i,contentTitle:()=>l});var o=JSON.parse('{"id":"go/go \uCD5C\uC801\uD654 cpu Prefork","title":"go Prefork","description":"\uC571 \uC2E4\uD589 \uC2DC \uBBF8\uB9AC fork()\uB97C \uD1B5\uD574 \uD504\uB85C\uC138\uC2A4\uB97C \uC0DD\uC131\uD558\uC5EC \uC694\uCCAD\uC744 \uCC98\uB9AC\uD558\uB294 \uBC29\uC2DD","source":"@site/docs/go/go \uCD5C\uC801\uD654 cpu Prefork.md","sourceDirName":"go","slug":"/go/go \uCD5C\uC801\uD654 cpu Prefork","permalink":"/docs/go/go \uCD5C\uC801\uD654 cpu Prefork","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"go GOMAXPROCS","permalink":"/docs/go/go \uCD5C\uC801\uD654 cpu GOMAXPROCS"},"next":{"title":"go benchstat","permalink":"/docs/go/go \uCD5C\uC801\uD654 cpu benchstat"}}'),t=e(447259),s=e(255511);let c={},l="go Prefork",i={},a=[];function d(r){let n={blockquote:"blockquote",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,s.R)(),...r.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"go-prefork",children:"go Prefork"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"\uC571 \uC2E4\uD589 \uC2DC \uBBF8\uB9AC fork()\uB97C \uD1B5\uD574 \uD504\uB85C\uC138\uC2A4\uB97C \uC0DD\uC131\uD558\uC5EC \uC694\uCCAD\uC744 \uCC98\uB9AC\uD558\uB294 \uBC29\uC2DD"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n	"fmt"\r\n	"net"\r\n	"os"\r\n	"os/exec"\r\n	"syscall"\r\n)\r\n\r\nconst (\r\n	ADDR = ":8080"\r\n)\r\n\r\nfunc main() {\r\n	if os.Getenv("IS_WORKER") == "1" {\r\n		runWorker()\r\n		return\r\n	}\r\n\r\n	// fork 4\uAC1C\uC758 worker \uD504\uB85C\uC138\uC2A4\r\n	for i := 0; i < 4; i++ {\r\n		cmd := exec.Command(os.Args[0])\r\n		cmd.Env = append(os.Environ(), "IS_WORKER=1")\r\n		cmd.Stdout = os.Stdout\r\n		cmd.Stderr = os.Stderr\r\n		cmd.Start()\r\n		fmt.Println("Forked worker PID:", cmd.Process.Pid)\r\n	}\r\n\r\n	select {} // master\uB294 \uB300\uAE30\uB9CC \uD568\r\n}\r\n\r\nfunc runWorker() {\r\n	// \uC18C\uCF13 \uC0DD\uC131\r\n	fd, err := syscall.Socket(syscall.AF_INET, syscall.SOCK_STREAM, syscall.IPPROTO_TCP)\r\n	if err != nil {\r\n		panic(err)\r\n	}\r\n\r\n	// SO_REUSEADDR, SO_REUSEPORT \uC124\uC815\r\n	err = syscall.SetsockoptInt(fd, syscall.SOL_SOCKET, syscall.SO_REUSEADDR, 1)\r\n	if err != nil {\r\n		panic(err)\r\n	}\r\n	err = syscall.SetsockoptInt(fd, syscall.SOL_SOCKET, 0x0F, 1) // 0x0F == SO_REUSEPORT\r\n	if err != nil {\r\n		panic(err)\r\n	}\r\n\r\n	// \uBC14\uC778\uB529\r\n	sa := &syscall.SockaddrInet4{Port: 8080}\r\n	copy(sa.Addr[:], net.ParseIP("0.0.0.0").To4())\r\n	err = syscall.Bind(fd, sa)\r\n	if err != nil {\r\n		panic(err)\r\n	}\r\n\r\n	// listen \uC2DC\uC791\r\n	err = syscall.Listen(fd, syscall.SOMAXCONN)\r\n	if err != nil {\r\n		panic(err)\r\n	}\r\n\r\n	file := os.NewFile(uintptr(fd), "listener")\r\n	ln, err := net.FileListener(file)\r\n	if err != nil {\r\n		panic(err)\r\n	}\r\n\r\n	fmt.Println("Worker started on", ADDR)\r\n\r\n	for {\r\n		conn, err := ln.Accept()\r\n		if err != nil {\r\n			continue\r\n		}\r\n		go func(c net.Conn) {\r\n			defer c.Close()\r\n			c.Write([]byte("Hello from worker!\\n"))\r\n		}(conn)\r\n	}\r\n}\r\n\n'})})]})}function f(r={}){let{wrapper:n}={...(0,s.R)(),...r.components};return n?(0,t.jsx)(n,{...r,children:(0,t.jsx)(d,{...r})}):d(r)}},255511:function(r,n,e){e.d(n,{R:()=>c,x:()=>l});var o=e(596363);let t={},s=o.createContext(t);function c(r){let n=o.useContext(s);return o.useMemo(function(){return"function"==typeof r?r(n):{...n,...r}},[n,r])}function l(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(t):r.components||t:c(r.components),o.createElement(s.Provider,{value:n},r.children)}}}]);