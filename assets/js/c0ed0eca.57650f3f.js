"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["924417"],{189913:function(r,e,t){t.r(e),t.d(e,{frontMatter:()=>i,toc:()=>c,default:()=>d,metadata:()=>s,assets:()=>m,contentTitle:()=>o});var s=JSON.parse('{"id":"db-prisma/prisma query stream","title":"prisma stream","description":"custom stream","source":"@site/docs/db-prisma/prisma query stream.md","sourceDirName":"db-prisma","slug":"/db-prisma/prisma query stream","permalink":"/docs/db-prisma/prisma query stream","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"prisma-cursorstream","permalink":"/docs/db-prisma/prisma query stream prisma-cursorstream"},"next":{"title":"prisma raw query","permalink":"/docs/db-prisma/prisma raw query"}}'),n=t(447259),a=t(255511);let i={},o="prisma stream",m={},c=[{value:"custom stream",id:"custom-stream",level:2},{value:"usage",id:"usage",level:2}];function u(r){let e={code:"code",h1:"h1",h2:"h2",header:"header",pre:"pre",...(0,a.R)(),...r.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.header,{children:(0,n.jsx)(e.h1,{id:"prisma-stream",children:"prisma stream"})}),"\n",(0,n.jsx)(e.h2,{id:"custom-stream",children:"custom stream"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-ts",children:'import { Readable } from "stream";\r\nimport { PrismaClient } from "@prisma/client";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ninterface StreamReportsOptions {\r\n  batchSize: number;\r\n}\r\n\r\nexport function streamReports({ batchSize }: StreamReportsOptions): Readable {\r\n  let cursorId: number = undefined;\r\n  return new Readable({\r\n    objectMode: true,\r\n    highWaterMark: batchSize,\r\n    async read() {\r\n      try {\r\n        const items = await prisma.report.findMany({\r\n          take: batchSize,\r\n          skip: cursorId ? 1 : 0,\r\n          cursor: cursorId ? { id: cursorId } : undefined,\r\n          where: {\r\n            processed: false,\r\n          },\r\n        });\r\n        for (const item of items) {\r\n          this.push(item);\r\n        }\r\n        if (items.length < batchSize) {\r\n          this.push(null);\r\n          return;\r\n        }\r\n        cursorId = items[items.length - 1].id;\r\n      } catch (err) {\r\n        this.destroy(err);\r\n      }\r\n    },\r\n  });\r\n}\n'})}),"\n",(0,n.jsx)(e.h2,{id:"usage",children:"usage"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-ts",children:"for await (const user of streamUsers({ batchSize: 100 })) {\r\n  console.log(user);\r\n}\n"})})]})}function d(r={}){let{wrapper:e}={...(0,a.R)(),...r.components};return e?(0,n.jsx)(e,{...r,children:(0,n.jsx)(u,{...r})}):u(r)}},255511:function(r,e,t){t.d(e,{R:()=>i,x:()=>o});var s=t(596363);let n={},a=s.createContext(n);function i(r){let e=s.useContext(a);return s.useMemo(function(){return"function"==typeof r?r(e):{...e,...r}},[e,r])}function o(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(n):r.components||n:i(r.components),s.createElement(a.Provider,{value:e},r.children)}}}]);