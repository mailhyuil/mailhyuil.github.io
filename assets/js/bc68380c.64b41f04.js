"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[698430],{36049:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"aws/aws Lambda Image Resize","title":"Lambda layer Image Resize","description":"1. Lambda \uc0dd\uc131","source":"@site/docs/aws/aws Lambda Image Resize.md","sourceDirName":"aws","slug":"/aws/aws Lambda Image Resize","permalink":"/docs/aws/aws Lambda Image Resize","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Lambda layer Image Resize on Demand","permalink":"/docs/aws/aws Lambda Image Resize on Demand"},"next":{"title":"aws Lambda@Edge","permalink":"/docs/aws/aws Lambda Lambda@edge"}}');var a=r(447259),t=r(529087);const i={},c="Lambda layer Image Resize",o={},l=[];function d(e){const n={blockquote:"blockquote",code:"code",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"lambda-layer-image-resize",children:"Lambda layer Image Resize"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Lambda \uc0dd\uc131","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"memory 512MB, timeout 5s"}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.li,{children:"Trigger \uc0dd\uc131 (S3) (S3\uc5d0\uc11c Event\ub85c \ub4f1\ub85d\ud558\ub294 \ubc29\ubc95\ub3c4 \uc788\ub2e4, \ub458 \uc911 \ud55c\uac00\uc9c0 \ubc29\ubc95\ub9cc \uc0ac\uc6a9\ud574\uc57c\ud55c\ub2e4.)"}),"\n",(0,a.jsxs)(n.li,{children:["layer \uc0dd\uc131 (sharp.. \ub77c\uc774\ube0c\ub7ec\ub9ac\ub97c zip\uc73c\ub85c \uc555\ucd95\ud574\uc11c \uc5c5\ub85c\ub4dc)","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"sharp\ub294 os\uc5d0 \uc758\uc874\uc801\uc774\uae30 \ub54c\ubb38\uc5d0 \uc8fc\uc758"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"npm install --cpu=x64 --os=linux sharp\r\n\r\nmkdir nodejs\r\ncp -r node_modules nodejs # nodejs/node_modules \uad6c\uc870\r\nzip -r nodejs nodejs\n"})}),"\n",(0,a.jsxs)(n.ol,{start:"4",children:["\n",(0,a.jsxs)(n.li,{children:["source code \uc791\uc131 \ud6c4 deploy","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"commonjs\ub85c \uc791\uc131"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"\uc774\ubbf8\uc9c0\ub97c \ub9ac\uc0ac\uc774\uc9d5 \ud558\uc5ec /resized/small, /resized/medium, /resized/large\uc5d0 \uc800\uc7a5"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:'const AWS = require("aws-sdk");\r\nconst sharp = require("sharp");\r\nconst path = require("path");\r\n\r\nconst s3 = new AWS.S3();\r\nconst dstBucket = "dep-team-bucket";\r\n\r\n// \ud06c\uae30\ubcc4 \uc124\uc815\r\nconst sizes = {\r\n  small: 320,\r\n  medium: 640,\r\n  large: 1280,\r\n};\r\n\r\nexports.handler = async event => {\r\n  const srcBucket = event.Records[0].s3.bucket.name;\r\n  const srcKey = decodeURIComponent(event.Records[0].s3.object.key.replace(/\\+/g, " "));\r\n  const extMatch = srcKey.match(/\\.([^.]*)$/);\r\n  if (!extMatch) return;\r\n\r\n  const imageType = extMatch[1].toLowerCase();\r\n  if (!["jpg", "jpeg", "png"].includes(imageType)) return;\r\n\r\n  const filename = path.basename(srcKey, path.extname(srcKey));\r\n\r\n  try {\r\n    const originalImage = await s3.getObject({ Bucket: srcBucket, Key: srcKey }).promise();\r\n\r\n    for (const [sizeName, width] of Object.entries(sizes)) {\r\n      const buffer = await sharp(originalImage.Body).resize(width).webp().toBuffer();\r\n\r\n      const dstKey = `resized/${sizeName}/${filename}.webp`;\r\n\r\n      await s3\r\n        .putObject({\r\n          Bucket: dstBucket,\r\n          Key: dstKey,\r\n          Body: buffer,\r\n          ContentType: "image/webp",\r\n        })\r\n        .promise();\r\n    }\r\n\r\n    console.log(`\u2705 All sizes created for ${srcKey}`);\r\n  } catch (err) {\r\n    console.error(`\u274c Error processing ${srcKey}:`, err);\r\n  }\r\n};\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"5",children:["\n",(0,a.jsxs)(n.li,{children:["Cloudfront Fucntion \uc0ac\uc774\uc988 \ub9e4\ud551","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"function\uc744 view request\uc5d0 \uc5f0\uacb0"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:'function handler(event) {\r\n  var request = event.request;\r\n  var uri = request.uri;\r\n  var qs = request.querystring;\r\n\r\n  // \uc720\ud6a8\ud55c size \ubaa9\ub85d\r\n  var validSizes = ["small", "medium", "large"];\r\n\r\n  // size \ud30c\ub77c\ubbf8\ud130 \uc874\uc7ac & \uc720\ud6a8\ud55c \uac12\uc778\uc9c0 \ud655\uc778\r\n  if (qs.size && validSizes.includes(qs.size.value) && uri.startsWith("/images/")) {\r\n    var size = qs.size.value;\r\n\r\n    // \ud30c\uc77c\uba85 \ucd94\ucd9c\r\n    var filename = uri.replace("/images/", "").replace(/\\.[^/.]+$/, "");\r\n\r\n    // \uacbd\ub85c \uc7ac\uc791\uc131: /resized/{size}/{filename}.webp\r\n    request.uri = `/resized/${size}/${filename}.webp`;\r\n  }\r\n\r\n  return request;\r\n}\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"6",children:["\n",(0,a.jsxs)(n.li,{children:["Cache Policy \uc0dd\uc131","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"querystring size\ub97c \ud3ec\ud568\ud55c policy \uc0dd\uc131"}),"\n"]}),"\n"]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},529087:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>c});var s=r(596363);const a={},t=s.createContext(a);function i(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);