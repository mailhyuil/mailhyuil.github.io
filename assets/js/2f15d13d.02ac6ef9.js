"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[664237],{329229:(r,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>f,frontMatter:()=>c,metadata:()=>e,toc:()=>a});const e=JSON.parse('{"id":"go/go \ucd5c\uc801\ud654 cpu Prefork","title":"go Prefork","description":"\uc571 \uc2e4\ud589 \uc2dc \ubbf8\ub9ac fork()\ub97c \ud1b5\ud574 \ud504\ub85c\uc138\uc2a4\ub97c \uc0dd\uc131\ud558\uc5ec \uc694\uccad\uc744 \ucc98\ub9ac\ud558\ub294 \ubc29\uc2dd","source":"@site/docs/go/go \ucd5c\uc801\ud654 cpu Prefork.md","sourceDirName":"go","slug":"/go/go \ucd5c\uc801\ud654 cpu Prefork","permalink":"/docs/go/go \ucd5c\uc801\ud654 cpu Prefork","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"go GOMAXPROCS","permalink":"/docs/go/go \ucd5c\uc801\ud654 cpu GOMAXPROCS"},"next":{"title":"go benchstat","permalink":"/docs/go/go \ucd5c\uc801\ud654 cpu benchstat"}}');var o=t(447259),s=t(529087);const c={},l="go Prefork",i={},a=[];function d(r){const n={blockquote:"blockquote",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,s.R)(),...r.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"go-prefork",children:"go Prefork"})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"\uc571 \uc2e4\ud589 \uc2dc \ubbf8\ub9ac fork()\ub97c \ud1b5\ud574 \ud504\ub85c\uc138\uc2a4\ub97c \uc0dd\uc131\ud558\uc5ec \uc694\uccad\uc744 \ucc98\ub9ac\ud558\ub294 \ubc29\uc2dd"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n\t"fmt"\r\n\t"net"\r\n\t"os"\r\n\t"os/exec"\r\n\t"syscall"\r\n)\r\n\r\nconst (\r\n\tADDR = ":8080"\r\n)\r\n\r\nfunc main() {\r\n\tif os.Getenv("IS_WORKER") == "1" {\r\n\t\trunWorker()\r\n\t\treturn\r\n\t}\r\n\r\n\t// fork 4\uac1c\uc758 worker \ud504\ub85c\uc138\uc2a4\r\n\tfor i := 0; i < 4; i++ {\r\n\t\tcmd := exec.Command(os.Args[0])\r\n\t\tcmd.Env = append(os.Environ(), "IS_WORKER=1")\r\n\t\tcmd.Stdout = os.Stdout\r\n\t\tcmd.Stderr = os.Stderr\r\n\t\tcmd.Start()\r\n\t\tfmt.Println("Forked worker PID:", cmd.Process.Pid)\r\n\t}\r\n\r\n\tselect {} // master\ub294 \ub300\uae30\ub9cc \ud568\r\n}\r\n\r\nfunc runWorker() {\r\n\t// \uc18c\ucf13 \uc0dd\uc131\r\n\tfd, err := syscall.Socket(syscall.AF_INET, syscall.SOCK_STREAM, syscall.IPPROTO_TCP)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\t// SO_REUSEADDR, SO_REUSEPORT \uc124\uc815\r\n\terr = syscall.SetsockoptInt(fd, syscall.SOL_SOCKET, syscall.SO_REUSEADDR, 1)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\terr = syscall.SetsockoptInt(fd, syscall.SOL_SOCKET, 0x0F, 1) // 0x0F == SO_REUSEPORT\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\t// \ubc14\uc778\ub529\r\n\tsa := &syscall.SockaddrInet4{Port: 8080}\r\n\tcopy(sa.Addr[:], net.ParseIP("0.0.0.0").To4())\r\n\terr = syscall.Bind(fd, sa)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\t// listen \uc2dc\uc791\r\n\terr = syscall.Listen(fd, syscall.SOMAXCONN)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\tfile := os.NewFile(uintptr(fd), "listener")\r\n\tln, err := net.FileListener(file)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\r\n\tfmt.Println("Worker started on", ADDR)\r\n\r\n\tfor {\r\n\t\tconn, err := ln.Accept()\r\n\t\tif err != nil {\r\n\t\t\tcontinue\r\n\t\t}\r\n\t\tgo func(c net.Conn) {\r\n\t\t\tdefer c.Close()\r\n\t\t\tc.Write([]byte("Hello from worker!\\n"))\r\n\t\t}(conn)\r\n\t}\r\n}\r\n\n'})})]})}function f(r={}){const{wrapper:n}={...(0,s.R)(),...r.components};return n?(0,o.jsx)(n,{...r,children:(0,o.jsx)(d,{...r})}):d(r)}},529087:(r,n,t)=>{t.d(n,{R:()=>c,x:()=>l});var e=t(596363);const o={},s=e.createContext(o);function c(r){const n=e.useContext(s);return e.useMemo(function(){return"function"==typeof r?r(n):{...n,...r}},[n,r])}function l(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(o):r.components||o:c(r.components),e.createElement(s.Provider,{value:n},r.children)}}}]);