"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["424947"],{259557:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>i,toc:()=>l,default:()=>u,metadata:()=>s,assets:()=>o,contentTitle:()=>c});var s=JSON.parse('{"id":"aws/aws Lambda Image Resize","title":"Lambda layer Image Resize","description":"1. Lambda \uC0DD\uC131","source":"@site/docs/aws/aws Lambda Image Resize.md","sourceDirName":"aws","slug":"/aws/aws Lambda Image Resize","permalink":"/docs/aws/aws Lambda Image Resize","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Lambda layer Image Resize on Demand","permalink":"/docs/aws/aws Lambda Image Resize on Demand"},"next":{"title":"aws Lambda@Edge","permalink":"/docs/aws/aws Lambda Lambda@edge"}}'),a=r(447259),t=r(255511);let i={},c="Lambda layer Image Resize",o={},l=[];function d(e){let n={blockquote:"blockquote",code:"code",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"lambda-layer-image-resize",children:"Lambda layer Image Resize"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Lambda \uC0DD\uC131","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"memory 512MB, timeout 5s"}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.li,{children:"Trigger \uC0DD\uC131 (S3) (S3\uC5D0\uC11C Event\uB85C \uB4F1\uB85D\uD558\uB294 \uBC29\uBC95\uB3C4 \uC788\uB2E4, \uB458 \uC911 \uD55C\uAC00\uC9C0 \uBC29\uBC95\uB9CC \uC0AC\uC6A9\uD574\uC57C\uD55C\uB2E4.)"}),"\n",(0,a.jsxs)(n.li,{children:["layer \uC0DD\uC131 (sharp.. \uB77C\uC774\uBE0C\uB7EC\uB9AC\uB97C zip\uC73C\uB85C \uC555\uCD95\uD574\uC11C \uC5C5\uB85C\uB4DC)","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"sharp\uB294 os\uC5D0 \uC758\uC874\uC801\uC774\uAE30 \uB54C\uBB38\uC5D0 \uC8FC\uC758"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"npm install --cpu=x64 --os=linux sharp\r\n\r\nmkdir nodejs\r\ncp -r node_modules nodejs # nodejs/node_modules \uAD6C\uC870\r\nzip -r nodejs nodejs\n"})}),"\n",(0,a.jsxs)(n.ol,{start:"4",children:["\n",(0,a.jsxs)(n.li,{children:["source code \uC791\uC131 \uD6C4 deploy","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"commonjs\uB85C \uC791\uC131"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"\uC774\uBBF8\uC9C0\uB97C \uB9AC\uC0AC\uC774\uC9D5 \uD558\uC5EC /resized/small, /resized/medium, /resized/large\uC5D0 \uC800\uC7A5"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:'const AWS = require("aws-sdk");\r\nconst sharp = require("sharp");\r\nconst path = require("path");\r\n\r\nconst s3 = new AWS.S3();\r\nconst dstBucket = "dep-team-bucket";\r\n\r\n// \uD06C\uAE30\uBCC4 \uC124\uC815\r\nconst sizes = {\r\n  small: 320,\r\n  medium: 640,\r\n  large: 1280,\r\n};\r\n\r\nexports.handler = async event => {\r\n  const srcBucket = event.Records[0].s3.bucket.name;\r\n  const srcKey = decodeURIComponent(event.Records[0].s3.object.key.replace(/\\+/g, " "));\r\n  const extMatch = srcKey.match(/\\.([^.]*)$/);\r\n  if (!extMatch) return;\r\n\r\n  const imageType = extMatch[1].toLowerCase();\r\n  if (!["jpg", "jpeg", "png"].includes(imageType)) return;\r\n\r\n  const filename = path.basename(srcKey, path.extname(srcKey));\r\n\r\n  try {\r\n    const originalImage = await s3.getObject({ Bucket: srcBucket, Key: srcKey }).promise();\r\n\r\n    for (const [sizeName, width] of Object.entries(sizes)) {\r\n      const buffer = await sharp(originalImage.Body).resize(width).webp().toBuffer();\r\n\r\n      const dstKey = `resized/${sizeName}/${filename}.webp`;\r\n\r\n      await s3\r\n        .putObject({\r\n          Bucket: dstBucket,\r\n          Key: dstKey,\r\n          Body: buffer,\r\n          ContentType: "image/webp",\r\n        })\r\n        .promise();\r\n    }\r\n\r\n    console.log(`\u2705 All sizes created for ${srcKey}`);\r\n  } catch (err) {\r\n    console.error(`\u274C Error processing ${srcKey}:`, err);\r\n  }\r\n};\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"5",children:["\n",(0,a.jsxs)(n.li,{children:["Cloudfront Fucntion \uC0AC\uC774\uC988 \uB9E4\uD551","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"function\uC744 view request\uC5D0 \uC5F0\uACB0"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:'function handler(event) {\r\n  var request = event.request;\r\n  var uri = request.uri;\r\n  var qs = request.querystring;\r\n\r\n  // \uC720\uD6A8\uD55C size \uBAA9\uB85D\r\n  var validSizes = ["small", "medium", "large"];\r\n\r\n  // size \uD30C\uB77C\uBBF8\uD130 \uC874\uC7AC & \uC720\uD6A8\uD55C \uAC12\uC778\uC9C0 \uD655\uC778\r\n  if (qs.size && validSizes.includes(qs.size.value) && uri.startsWith("/images/")) {\r\n    var size = qs.size.value;\r\n\r\n    // \uD30C\uC77C\uBA85 \uCD94\uCD9C\r\n    var filename = uri.replace("/images/", "").replace(/\\.[^/.]+$/, "");\r\n\r\n    // \uACBD\uB85C \uC7AC\uC791\uC131: /resized/{size}/{filename}.webp\r\n    request.uri = `/resized/${size}/${filename}.webp`;\r\n  }\r\n\r\n  return request;\r\n}\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"6",children:["\n",(0,a.jsxs)(n.li,{children:["Cache Policy \uC0DD\uC131","\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"querystring size\uB97C \uD3EC\uD568\uD55C policy \uC0DD\uC131"}),"\n"]}),"\n"]}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},255511:function(e,n,r){r.d(n,{R:()=>i,x:()=>c});var s=r(596363);let a={},t=s.createContext(a);function i(e){let n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);