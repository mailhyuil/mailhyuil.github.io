"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[212765],{529087:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>c});var t=n(596363);const o={},s=t.createContext(o);function a(e){const r=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(s.Provider,{value:r},e.children)}},767241:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>i,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"nestjs/nest base DiscoveryModule MetadataScanner","title":"nest decorator DiscoveryModule DiscoveryService & MetadataScanner","description":"\ub370\ucf54\ub808\uc774\ud130\uc5d0\uc11c Provider\ub97c \uc0ac\uc6a9\ud560 \uacbd\uc6b0 Provider\ub97c \ubb34\uc870\uac74 \uc8fc\uc785\ud558\uace0 \uc788\uc5b4\uc57c\ud55c\ub2e4.","source":"@site/docs/nestjs/nest base DiscoveryModule MetadataScanner.md","sourceDirName":"nestjs","slug":"/nestjs/nest base DiscoveryModule MetadataScanner","permalink":"/docs/nestjs/nest base DiscoveryModule MetadataScanner","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest DiscoveryModule ExplorerService","permalink":"/docs/nestjs/nest base DiscoveryModule ExplorerService - DiscoveryService"},"next":{"title":"nest DiscoveryModule","permalink":"/docs/nestjs/nest base DiscoveryModule"}}');var o=n(447259),s=n(529087);const a={},c="nest decorator DiscoveryModule DiscoveryService & MetadataScanner",i={},d=[{value:"decorator \uc0dd\uc131",id:"decorator-\uc0dd\uc131",level:2},{value:"provider \uc0dd\uc131",id:"provider-\uc0dd\uc131",level:2}];function l(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"nest-decorator-discoverymodule-discoveryservice--metadatascanner",children:"nest decorator DiscoveryModule DiscoveryService & MetadataScanner"})}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\ub370\ucf54\ub808\uc774\ud130\uc5d0\uc11c Provider\ub97c \uc0ac\uc6a9\ud560 \uacbd\uc6b0 Provider\ub97c \ubb34\uc870\uac74 \uc8fc\uc785\ud558\uace0 \uc788\uc5b4\uc57c\ud55c\ub2e4."}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\uba54\ud0c0\ub370\uc774\ud130\ub97c \uc2a4\uce90\ub2dd \ud558\ub294 \ubc29\ubc95\uc73c\ub85c Provider\ub97c \uc8fc\uc785\ud558\uc9c0 \uc54a\uace0 Discover\ud558\uc5ec \uc0ac\uc6a9\ud560 \uc218 \uc788\ub2e4."}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"discoveryService\ub85c \ubaa8\ub4e0 provider \uc870\ud68c"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"metadataScanner\ub85c \uba54\uc18c\ub4dc\uc5d0 \uc811\uadfc"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.h2,{id:"decorator-\uc0dd\uc131",children:"decorator \uc0dd\uc131"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-ts",children:'export const CACHEABLE = Symbol("CACHEABLE");\r\nexport const Cacheable = (ttl: number) => SetMetadata(CACHEABLE, ttl);\r\n\r\n@Injectable()\r\nclass TargetClass {\r\n  @Cacheable(0)\r\n  test() {}\r\n}\n'})}),"\n",(0,o.jsx)(r.h2,{id:"provider-\uc0dd\uc131",children:"provider \uc0dd\uc131"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"provider\uc5d0\uc11c \uc0dd\uc131\ud55c \ub370\ucf54\ub808\uc774\ud130\uc758 \ud1a0\ud070\uc744 \uac00\uc9c4 \uba54\uc18c\ub4dc\ub97c \uc870\ud68c\ud558\uace0"}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"\uc870\ud68c\ud55c \uba54\uc18c\ub4dc\uc5d0 \uc811\uadfc\ud558\uc5ec \ub370\ucf54\ub808\uc774\ud305\ud55c\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-ts",children:"@Injectable()\r\nexport class CacheDecoratorRegister implements OnModuleInit {\r\n  constructor(\r\n    private readonly discoveryService: DiscoveryService,\r\n    private readonly metadataScanner: MetadataScanner,\r\n    private readonly reflector: Reflector,\r\n    private readonly cache: Cache\r\n  ) {}\r\n\r\n  onModuleInit() {\r\n    return this.discoveryService\r\n      .getProviders() // #1. \ubaa8\ub4e0 provider \uc870\ud68c\r\n      .filter((wrapper) => wrapper.isDependencyTreeStatic())\r\n      .filter(({ instance }) => instance && Object.getPrototypeOf(instance))\r\n      .forEach(({ instance }) => {\r\n        this.metadataScanner.scanFromPrototype(instance, Object.getPrototypeOf(instance), (methodName) => {\r\n          // #2. \uba54\ud0c0\ub370\uc774\ud130 value\r\n          const ttl = this.reflector.get(CACHEABLE, instance[methodName]);\r\n          if (!ttl) {\r\n            return;\r\n          }\r\n\r\n          // \uae30\uc874 \ud568\uc218\ub97c \uc800\uc7a5\ud574\ub450\uace0\r\n          const methodRef = instance[methodName];\r\n\r\n          instance[methodName] = async function (...args: any[]) {\r\n            // #3. \uae30\uc874 \ud568\uc218 \ub370\ucf54\ub808\uc774\ud305\r\n            // before..\r\n            const name = `${instance.constructor.name}.${methodName}`;\r\n            const value = await this.cache.get(name, args);\r\n            if (value) {\r\n              return value;\r\n            }\r\n\r\n            // \uae30\uc874 \ud568\uc218 \ud638\ucd9c\r\n            const result = await methodRef.call(instance, ...args);\r\n\r\n            // after..\r\n            await this.cache.set(name, args, result, ttl);\r\n            return result;\r\n          };\r\n        });\r\n      });\r\n  }\r\n}\n"})})]})}function u(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}}}]);