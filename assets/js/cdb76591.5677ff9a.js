"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[549270],{270523:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>t,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>u});const s=JSON.parse('{"id":"db-postgres/postgres backup scripts","title":"db backup scripts","description":"pgdumpbackup.sh","source":"@site/docs/db-postgres/postgres backup scripts.md","sourceDirName":"db-postgres","slug":"/db-postgres/postgres backup scripts","permalink":"/docs/db-postgres/postgres backup scripts","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"postgres recovery psql vs pg_restore","permalink":"/docs/db-postgres/postgres backup psql vs pg_restore"},"next":{"title":"postgres backup \uc885\ub958","permalink":"/docs/db-postgres/postgres backup \uc885\ub958"}}');var c=n(447259),p=n(529087);const a={},t="db backup scripts",o={},u=[{value:"pg_dump_backup.sh",id:"pg_dump_backupsh",level:2},{value:"pg_basebackup.sh",id:"pg_basebackupsh",level:2},{value:"cron",id:"cron",level:2}];function b(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,p.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(r.header,{children:(0,c.jsx)(r.h1,{id:"db-backup-scripts",children:"db backup scripts"})}),"\n",(0,c.jsx)(r.h2,{id:"pg_dump_backupsh",children:"pg_dump_backup.sh"}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\n\r\nUSERNAME=postgres\r\nDB_NAME=onepartners\r\nPASSWORD=cloud365$\r\nCONTAINER_NAME=postgres\r\nBUCKET_NAME=onepartners-db\r\nBACKUP_DIR=/home/ubuntu/pg-backup\r\nFILENAME="${DB_NAME}_$(date +\'%Y-%m-%d_%H%M\').dump"\r\n\r\ncd $BACKUP_DIR\r\n\r\necho "[pg_dump] $(date) - DB \ubc31\uc5c5 \uc2dc\uc791"\r\nPGPASSWORD=$PASSWORD sudo docker exec $CONTAINER_NAME pg_dump -U $USERNAME $DB_NAME -Fc -v > "$FILENAME"\r\necho "[pg_dump] \ubc31\uc5c5 \uc644\ub8cc: $FILENAME"\r\n\r\naws s3 cp "$FILENAME" s3://${BUCKET_NAME}/backup/$FILENAME\r\n\r\n# \u2705 \uc5c5\ub85c\ub4dc \ud6c4 \uc989\uc2dc \uc0ad\uc81c\r\nrm -f "$FILENAME"\r\necho "[pg_dump] $(date) - S3 \uc5c5\ub85c\ub4dc \ud6c4 \ub85c\uceec \ubc31\uc5c5 \uc0ad\uc81c \uc644\ub8cc"\n'})}),"\n",(0,c.jsx)(r.h2,{id:"pg_basebackupsh",children:"pg_basebackup.sh"}),"\n",(0,c.jsxs)(r.blockquote,{children:["\n",(0,c.jsx)(r.p,{children:"basebackup \ud6c4 archive \ubcf5\uc0ac \ubc0f \uc0ad\uc81c"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-sh",children:'#!/bin/bash\r\n\r\nset -e\r\n\r\nCONTAINER_NAME=postgres\r\nBUCKET_NAME=onepartners-db\r\n\r\n# \ud638\uc2a4\ud2b8 \uae30\uc900 \uacbd\ub85c (docker-compose\uc5d0\uc11c \ub9c8\uc6b4\ud2b8\ub418\uc5b4 \uc788\uc5b4\uc57c \ud568)\r\nBASEBACKUP_DIR=/home/ubuntu/pg-basebackup\r\nARCHIVE_DIR=/home/ubuntu/pg-archive\r\nDATE_TAG=$(date +"%Y%m%d_%H%M%S")\r\n\r\necho "[INFO] \uc2dc\uc791: $DATE_TAG"\r\n# 1. \ucee8\ud14c\uc774\ub108 \ub0b4\ubd80\uc5d0\uc11c basebackup \uc2e4\ud589 + \uc18c\uc720\uad8c \uc218\uc815\r\ndocker exec $CONTAINER_NAME bash -c "\r\n  set -e\r\n  export PGPASSWORD=\'cloud365$\'\r\n  mkdir -p /var/lib/postgresql/basebackup_dir/$DATE_TAG\r\n  pg_basebackup \\\r\n    -h localhost \\\r\n    -U postgres \\\r\n    -D /var/lib/postgresql/basebackup_dir/$DATE_TAG \\\r\n    -Ft -z -X fetch -P\r\n"\r\n\r\n# 2. \ud638\uc2a4\ud2b8\uc5d0\uc11c base.tar.gz \uc5c5\ub85c\ub4dc + \uc0ad\uc81c\r\nBASE_TAR="${BASEBACKUP_DIR}/${DATE_TAG}/base.tar.gz"\r\nif [ -f "$BASE_TAR" ]; then\r\n  echo "[INFO] base.tar.gz \ubc1c\uacac \u2192 S3 \uc5c5\ub85c\ub4dc \uc911"\r\n  aws s3 cp "$BASE_TAR" "s3://${BUCKET_NAME}/basebackup/base_${DATE_TAG}.tar.gz"\r\n  rm -rf "${BASEBACKUP_DIR:?}/${DATE_TAG}"\r\n  echo "[OK] basebackup \uc5c5\ub85c\ub4dc \ubc0f \uc0ad\uc81c \uc644\ub8cc"\r\nelse\r\n  echo "\u274c base.tar.gz \ud30c\uc77c\uc774 \uc5c6\uc74c: $BASE_TAR"\r\nfi\r\n\r\n# 3. archive \ub514\ub809\ud1a0\ub9ac\uc5d0\uc11c \ucd5c\uc2e0 .backup \uc774\ud6c4 WAL\ub9cc \uc5c5\ub85c\ub4dc + \uc0ad\uc81c\r\ncd "$ARCHIVE_DIR" || exit 1\r\n\r\nLATEST_BACKUP=$(ls -1t *.backup 2>/dev/null | head -n1)\r\nif [ -z "$LATEST_BACKUP" ]; then\r\n  echo "\u274c .backup \ud30c\uc77c \uc5c6\uc74c \u2192 archive \ucc98\ub9ac \uc0dd\ub7b5"\r\n  exit 0\r\nfi\r\n\r\nLATEST_BASE=$(basename "$LATEST_BACKUP" | cut -d. -f1)\r\necho "[INFO] \ucd5c\uc2e0 .backup \uae30\uc900: $LATEST_BASE (.backup: $LATEST_BACKUP)"\r\n\r\nfor FILE in $(ls -1 | grep -E \'^[0-9A-F]{24}(\\.backup)?\'); do\r\n  if [[ "$FILE" > "$LATEST_BASE" || "$FILE" == "$LATEST_BACKUP" ]]; then\r\n    aws s3 cp "$FILE" "s3://${BUCKET_NAME}/archive/$FILE"\r\n    rm -f "$FILE"\r\n    echo "\u2705 $FILE \uc5c5\ub85c\ub4dc \ubc0f \uc0ad\uc81c \uc644\ub8cc"\r\n  fi\r\ndone\r\n\r\necho "[DONE] basebackup + archive \ucc98\ub9ac \uc644\ub8cc: $(date)"\n'})}),"\n",(0,c.jsx)(r.h2,{id:"cron",children:"cron"}),"\n",(0,c.jsxs)(r.blockquote,{children:["\n",(0,c.jsx)(r.p,{children:"sudo crontab -e"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-sh",children:"# \ub9e4\uc77c 03:00\uc5d0 pg_dump_backup.sh \uc2e4\ud589\r\n0 3 * * * sudo /home/ubuntu/scripts/pg_dump_backup.sh\r\n# \ub9e4\uc8fc \uc6d4,\ubaa9 03:00\uc5d0 pg_basebackup.sh \uc2e4\ud589\r\n0 3 * * 1,4 sudo /home/ubuntu/scripts/pg_basebackup.sh\n"})})]})}function d(e={}){const{wrapper:r}={...(0,p.R)(),...e.components};return r?(0,c.jsx)(r,{...e,children:(0,c.jsx)(b,{...e})}):b(e)}},529087:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>t});var s=n(596363);const c={},p=s.createContext(c);function a(e){const r=s.useContext(p);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function t(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:a(e.components),s.createElement(p.Provider,{value:r},e.children)}}}]);