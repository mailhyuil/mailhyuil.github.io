"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[536865],{529087:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>l});var t=r(596363);const s={},a=t.createContext(s);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:n},e.children)}},654213:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>i});const t=JSON.parse('{"id":"nestjs/nest advanced schedule - cronjob","title":"nest schedule","description":"cronjob\uc740 \ud3ec\ud2b8\uac00 \ud544\uc694 \uc5c6\uc73c\ub2c8 standalone\uc73c\ub85c \uad6c\uc131\ud558\ub294\uac8c \uc88b\ub2e4.","source":"@site/docs/nestjs/nest advanced schedule - cronjob.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced schedule - cronjob","permalink":"/docs/nestjs/nest advanced schedule - cronjob","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nestjs advanced multi-tenancy","permalink":"/docs/nestjs/nest advanced multi-tenancy"},"next":{"title":"nestjs standalone","permalink":"/docs/nestjs/nest advanced standalone"}}');var s=r(447259),a=r(529087);const o={},l="nest schedule",c={},i=[{value:"install",id:"install",level:2},{value:"main.ts",id:"maints",level:2},{value:"module",id:"module",level:2},{value:"Static task.service.ts",id:"static-taskservicets",level:2},{value:"Dynamic task.service.ts",id:"dynamic-taskservicets",level:2},{value:"example",id:"example",level:2}];function d(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"nest-schedule",children:"nest schedule"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"cronjob\uc740 \ud3ec\ud2b8\uac00 \ud544\uc694 \uc5c6\uc73c\ub2c8 standalone\uc73c\ub85c \uad6c\uc131\ud558\ub294\uac8c \uc88b\ub2e4."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"install",children:"install"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"npm i @nestjs/schedule\n"})}),"\n",(0,s.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"standalone"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { NestFactory } from "@nestjs/core";\r\nimport { AppModule } from "./app.module";\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.createApplicationContext(AppModule);\r\n}\r\nbootstrap();\n'})}),"\n",(0,s.jsx)(n.h2,{id:"module",children:"module"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { ScheduleModule } from "@nestjs/schedule";\r\n\r\n@Module({\r\n  imports: [ScheduleModule.forRoot(), TasksModule],\r\n  controllers: [AppController],\r\n  providers: [AppService],\r\n})\r\nexport class AppModule {}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"static-taskservicets",children:"Static task.service.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Injectable, Logger } from "@nestjs/common";\r\nimport { Cron, Interval, Timeout } from "@nestjs/schedule";\r\n\r\n@Injectable()\r\nexport class TasksService {\r\n  private readonly logger = new Logger(TasksService.name);\r\n\r\n  // @Cron("45 * * * * *")\r\n  @Cron(CronExpression.EVERY_45_SECONDS)\r\n  handleCron() {\r\n    this.logger.debug("Called when the second is 45");\r\n  }\r\n\r\n  @Interval(10000)\r\n  handleInterval() {\r\n    this.logger.debug("Called every 10 seconds");\r\n  }\r\n\r\n  @Timeout(5000)\r\n  handleTimeout() {\r\n    this.logger.debug("Called once after 5 seconds");\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"dynamic-taskservicets",children:"Dynamic task.service.ts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { Injectable, Logger } from "@nestjs/common";\r\nimport { SchedulerRegistry } from "@nestjs/schedule";\r\nimport { CronJob } from "cron";\r\n@Injectable()\r\nexport class TaskService {\r\n  private readonly logger = new Logger(TaskService.name);\r\n  constructor(private readonly schedulerRegistry: SchedulerRegistry) {}\r\n\r\n  getCronJob(jobName: string) {\r\n    try {\r\n      return this.schedulerRegistry.getCronJob(jobName);\r\n    } catch (error) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  addCronJob({ jobName, date, callback }: { jobName: string; date: Date; callback: () => void }) {\r\n    const job = new CronJob(date, callback);\r\n    this.schedulerRegistry.addCronJob(jobName, job);\r\n    job.runOnce = true;\r\n    job.start();\r\n  }\r\n\r\n  deleteCron(jobName: string) {\r\n    this.schedulerRegistry.deleteCronJob(jobName);\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"example",children:"example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:" async scheduleClass(entity: Class) {\r\n    const job = this.taskService.getCronJob(entity.id);\r\n    if (job) {\r\n      this.taskService.deleteCron(entity.id);\r\n    }\r\n\r\n    if (dayjs().isAfter(entity.liveOpenAt)) {\r\n      this.logger.log(\r\n        `\ud83d\udea9 ${entity.name} \uc774\ubbf8 \uc9c0\ub09c \ub77c\uc774\ube0c \uac15\uc758\uac00 \uc624\ud508\ub418\uc5c8\uc2b5\ub2c8\ub2e4.`,\r\n      );\r\n      await this.prisma.class.update({\r\n        where: { id: entity.id },\r\n        data: {\r\n          status: 'LIVE_OPENED',\r\n        },\r\n      });\r\n      return;\r\n    }\r\n\r\n    this.taskService.addCronJob({\r\n      jobName: entity.id,\r\n      date: dayjs(entity.liveOpenAt).toDate(),\r\n      callback: async () => {\r\n        this.logger.log(`${entity.name} \ub77c\uc774\ube0c \uac15\uc758\uac00 \uc624\ud508\ub418\uc5c8\uc2b5\ub2c8\ub2e4.`);\r\n        await this.prisma.class.update({\r\n          where: { id: entity.id },\r\n          data: {\r\n            status: 'LIVE_OPENED',\r\n          },\r\n        });\r\n      },\r\n    });\r\n    this.logger.log(`\ud83d\udd50 \"${entity.name}\" \ub77c\uc774\ube0c \uac15\uc758\uac00 \uc2a4\ucf00\uc904\ub9c1\ub418\uc5c8\uc2b5\ub2c8\ub2e4.`);\r\n  }\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);