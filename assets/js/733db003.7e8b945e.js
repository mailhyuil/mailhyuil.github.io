"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([["816910"],{136187:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>o,toc:()=>i,default:()=>u,metadata:()=>r,assets:()=>c,contentTitle:()=>d});var r=JSON.parse('{"id":"nestjs/nest advanced multi-tenancy durable provider","title":"nest advanced multi-tenancy durable provider","description":"database provider\uC758 \uC2A4\uCF54\uD504\uB97C REQUEST\uB85C \uC124\uC815\uD558\uC5EC, \uAC01 \uC694\uCCAD\uB9C8\uB2E4 \uB2E4\uB978 \uC778\uC2A4\uD134\uC2A4\uB97C \uC0DD\uC131\uB97C \uC0DD\uC131\uD55C\uB2E4. (\uBAA8\uB4E0 \uC694\uCCAD\uC5D0 DI Tree\uB97C \uC7AC\uC0DD\uC131)","source":"@site/docs/nestjs/nest advanced multi-tenancy durable provider.md","sourceDirName":"nestjs","slug":"/nestjs/nest advanced multi-tenancy durable provider","permalink":"/docs/nestjs/nest advanced multi-tenancy durable provider","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"nest advanced multi-tenancy REQUEST","permalink":"/docs/nestjs/nest advanced multi-tenancy REQUEST"},"next":{"title":"nestjs advanced multi-tenancy \uB2E4\uC911 \uB370\uC774\uD130\uBCA0\uC774\uC2A4 prisma","permalink":"/docs/nestjs/nest advanced multi-tenancy \uB2E4\uC911 \uB370\uC774\uD130\uBCA0\uC774\uC2A4 prisma"}}'),a=t(447259),s=t(255511);let o={},d="nest advanced multi-tenancy durable provider",c={},i=[{value:"multi-tenancy.strategy.ts",id:"multi-tenancystrategyts",level:2},{value:"main.ts",id:"maints",level:2},{value:"some.provider.ts",id:"someproviderts",level:2}];function l(e){let n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"nest-advanced-multi-tenancy-durable-provider",children:"nest advanced multi-tenancy durable provider"})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"database provider\uC758 \uC2A4\uCF54\uD504\uB97C REQUEST\uB85C \uC124\uC815\uD558\uC5EC, \uAC01 \uC694\uCCAD\uB9C8\uB2E4 \uB2E4\uB978 \uC778\uC2A4\uD134\uC2A4\uB97C \uC0DD\uC131\uB97C \uC0DD\uC131\uD55C\uB2E4. (\uBAA8\uB4E0 \uC694\uCCAD\uC5D0 DI Tree\uB97C \uC7AC\uC0DD\uC131)"}),"\n",(0,a.jsx)(n.p,{children:"\uD558\uC9C0\uB9CC 1,000\uAC1C\uC758 \uC694\uCCAD\uC774 \uB4E4\uC5B4\uC624\uBA74 1,000\uAC1C\uC758 \uC778\uC2A4\uD134\uC2A4\uAC00 \uC0DD\uC131\uB418\uC5B4, \uBA54\uBAA8\uB9AC\uB97C \uB9CE\uC774 \uCC28\uC9C0\uD558\uAC8C \uB41C\uB2E4."}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:'durable provider\uB97C \uC0AC\uC6A9\uD558\uBA74, "\uD14C\uB10C\uD2B8 \uC2DD\uBCC4\uC790"\uB97C \uD1B5\uD574 \uD14C\uB10C\uD2B8\uBCC4\uB85C \uBCC4\uB3C4\uC758 \uC778\uC2A4\uD134\uC2A4\uB97C \uC0DD\uC131\uD55C\uB2E4. (tenantId\uB97C \uD1B5\uD574 DI Tree\uB97C \uC7AC\uC0DD\uC131)'}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"\uD14C\uB10C\uD2B8 \uBCC4\uB85C \uB370\uC774\uD130 \uC18C\uC2A4\uB97C \uC644\uC804\uD788 \uBD84\uB9AC\uD560 \uC218 \uC788\uB2E4."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"multi-tenancystrategyts",children:"multi-tenancy.strategy.ts"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"\uC694\uCCAD\uB9C8\uB2E4 \uC0C8\uB85C\uC6B4 context\uAC00 \uC2E4\uD589\uB418\uB294\uAC8C nestjs\uC758 \uAE30\uBCF8 \uB3D9\uC791"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"tenantId\uB97C \uD1B5\uD574 context\uB97C \uC0DD\uC131\uD574 \uC800\uC7A5\uD558\uC5EC \uAC19\uC740 tenantId\uC758 \uC694\uCCAD\uC774 \uB4E4\uC5B4\uC624\uBA74, \uAE30\uC874 tenant\uC758 context\uB97C \uC0AC\uC6A9\uD558\uB3C4\uB85D \uD55C\uB2E4."}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:'client\uC5D0\uC11C request header\uC5D0 "x-tenant-id"\uB97C \uCD94\uAC00\uD558\uC5EC \uD14C\uB10C\uD2B8 \uC2DD\uBCC4\uC790\uB97C \uC804\uB2EC\uD55C\uB2E4.'}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"\uD14C\uB10C\uD2B8 \uC2DD\uBCC4\uC790\uC5D0 \uB530\uB77C\uC11C \uB2E4\uB978 context\uB97C \uC0AC\uC6A9\uD55C\uB2E4."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'import { ContextId, ContextIdFactory, ContextIdStrategy, HostComponentInfo } from "@nestjs/core";\r\nimport { Request } from "express";\r\n\r\nconst tenants = new Map<string, ContextId>();\r\n\r\nexport class AggregateByTenantContextIdStrategy implements ContextIdStrategy {\r\n  attach(contextId: ContextId, request: Request) {\r\n    const tenantId = request.headers["x-tenant-id"] as string;\r\n    let tenantSubTreeId: ContextId;\r\n\r\n    if (tenants.has(tenantId)) {\r\n      // \uD14C\uB10C\uD2B8 context\uAC00 \uC774\uBBF8 \uC874\uC7AC\uD55C\uB2E4\uBA74, \uD574\uB2F9 contextId\uB97C \uAC00\uC838\uC628\uB2E4.\r\n      tenantSubTreeId = tenants.get(tenantId);\r\n    } else {\r\n      // \uD14C\uB10C\uD2B8 context\uAC00 \uC874\uC7AC\uD558\uC9C0 \uC54A\uB294\uB2E4\uBA74, \uC0C8\uB85C \uC0DD\uC131\uD558\uC5EC \uC800\uC7A5\uD55C\uB2E4.\r\n      tenantSubTreeId = ContextIdFactory.create();\r\n      tenants.set(tenantId, tenantSubTreeId);\r\n    }\r\n\r\n    request.tenantId = tenantId;\r\n\r\n    // If tree is not durable, return the original "contextId" object\r\n    return (info: HostComponentInfo) => (info.isTreeDurable ? tenantSubTreeId : contextId);\r\n\r\n    // payload\uB97C \uD568\uAED8 \uC804\uB2EC\uD558\uACE0 \uC2F6\uB2E4\uBA74 \uC544\uB798\uC640 \uAC19\uC774 \uC791\uC131 // \uADF8\uB0E5 request.teantId\uB97C \uC0AC\uC6A9\uD574\uB3C4 \uB41C\uB2E4.\r\n    // (e.g. tenantId\uB97C payload\uB85C \uC804\uB2EC\uD558\uC5EC, tenantId\uC5D0 \uB530\uB77C \uB2E4\uB978 \uB370\uC774\uD130 \uC18C\uC2A4\uB97C \uC0AC\uC6A9\uD560 \uC218 \uC788\uB2E4.)\r\n    // return {\r\n    //   resolve: (info: HostComponentInfo) =>\r\n    //     info.isTreeDurable ? tenantSubTreeId : contextId,\r\n    //   payload: { tenantId },\r\n    // };\r\n  }\r\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"maints",children:"main.ts"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"ContextIdFactory\uC5D0 strategy\uB97C \uC801\uC6A9\uD55C\uB2E4."}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'import { ContextIdFactory, NestFactory } from "@nestjs/core";\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule);\r\n\r\n  ContextIdFactory.apply(new AggregateByTenantContextIdStrategy());\r\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"someproviderts",children:"some.provider.ts"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:'import { Injectable, Scope } from "@nestjs/common";\r\n\r\n@Injectable({ scope: Scope.REQUEST, durable: true })\r\nexport class CatsService {}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\uB610\uB294"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"{\r\n  provide: 'foobar',\r\n  useFactory: () => { ... },\r\n  scope: Scope.REQUEST,\r\n  durable: true,\r\n}\n"})})]})}function u(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},255511:function(e,n,t){t.d(n,{R:()=>o,x:()=>d});var r=t(596363);let a={},s=r.createContext(a);function o(e){let n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);